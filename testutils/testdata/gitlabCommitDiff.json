{"commit":{"id":"2295d352f6073101497f9bf4e4981c7ae72706a3","short_id":"2295d352","created_at":"2021-11-08T21:10:05.000+00:00","parent_ids":["f18d1ffec0ecaae592a0ccd708ce77146f5f37e3"],"title":"Add latest changes from gitlab-org/gitlab@master","message":"Add latest changes from gitlab-org/gitlab@master\n","author_name":"GitLab Bot","author_email":"gitlab-bot@gitlab.com","authored_date":"2021-11-08T21:10:05.000+00:00","committer_name":"GitLab Bot","committer_email":"gitlab-bot@gitlab.com","committed_date":"2021-11-08T21:10:05.000+00:00","trailers":{},"web_url":"https://gitlab.com/gitlab-org/gitlab-foss/-/commit/2295d352f6073101497f9bf4e4981c7ae72706a3"},"commits":[{"id":"6a380347147d1a55afbc6a1c16e04b567ab90d86","short_id":"6a380347","created_at":"2021-11-08T12:12:07.000+00:00","parent_ids":["4901ff1764398bb017487d4a5104b74bc284f33a"],"title":"Add latest changes from gitlab-org/gitlab@master","message":"Add latest changes from gitlab-org/gitlab@master\n","author_name":"GitLab Bot","author_email":"gitlab-bot@gitlab.com","authored_date":"2021-11-08T12:12:07.000+00:00","committer_name":"GitLab Bot","committer_email":"gitlab-bot@gitlab.com","committed_date":"2021-11-08T12:12:07.000+00:00","trailers":{},"web_url":"https://gitlab.com/gitlab-org/gitlab-foss/-/commit/6a380347147d1a55afbc6a1c16e04b567ab90d86"},{"id":"05db4ead6d5c73cf62ad95d80ccac415bc3bf3cd","short_id":"05db4ead","created_at":"2021-11-08T15:13:35.000+00:00","parent_ids":["6a380347147d1a55afbc6a1c16e04b567ab90d86"],"title":"Add latest changes from gitlab-org/gitlab@master","message":"Add latest changes from gitlab-org/gitlab@master\n","author_name":"GitLab Bot","author_email":"gitlab-bot@gitlab.com","authored_date":"2021-11-08T15:13:35.000+00:00","committer_name":"GitLab Bot","committer_email":"gitlab-bot@gitlab.com","committed_date":"2021-11-08T15:13:35.000+00:00","trailers":{},"web_url":"https://gitlab.com/gitlab-org/gitlab-foss/-/commit/05db4ead6d5c73cf62ad95d80ccac415bc3bf3cd"},{"id":"f18d1ffec0ecaae592a0ccd708ce77146f5f37e3","short_id":"f18d1ffe","created_at":"2021-11-08T18:09:52.000+00:00","parent_ids":["05db4ead6d5c73cf62ad95d80ccac415bc3bf3cd"],"title":"Add latest changes from gitlab-org/gitlab@master","message":"Add latest changes from gitlab-org/gitlab@master\n","author_name":"GitLab Bot","author_email":"gitlab-bot@gitlab.com","authored_date":"2021-11-08T18:09:52.000+00:00","committer_name":"GitLab Bot","committer_email":"gitlab-bot@gitlab.com","committed_date":"2021-11-08T18:09:52.000+00:00","trailers":{},"web_url":"https://gitlab.com/gitlab-org/gitlab-foss/-/commit/f18d1ffec0ecaae592a0ccd708ce77146f5f37e3"},{"id":"2295d352f6073101497f9bf4e4981c7ae72706a3","short_id":"2295d352","created_at":"2021-11-08T21:10:05.000+00:00","parent_ids":["f18d1ffec0ecaae592a0ccd708ce77146f5f37e3"],"title":"Add latest changes from gitlab-org/gitlab@master","message":"Add latest changes from gitlab-org/gitlab@master\n","author_name":"GitLab Bot","author_email":"gitlab-bot@gitlab.com","authored_date":"2021-11-08T21:10:05.000+00:00","committer_name":"GitLab Bot","committer_email":"gitlab-bot@gitlab.com","committed_date":"2021-11-08T21:10:05.000+00:00","trailers":{},"web_url":"https://gitlab.com/gitlab-org/gitlab-foss/-/commit/2295d352f6073101497f9bf4e4981c7ae72706a3"}],"diffs":[{"old_path":".gitlab/ci/qa.gitlab-ci.yml","new_path":".gitlab/ci/qa.gitlab-ci.yml","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -58,10 +58,13 @@ update-qa-cache:\n     - tooling/bin/find_change_diffs ${CHANGES_DIFFS_DIR}\n   script:\n     - |\n-      if tooling/bin/qa/check_if_only_quarantined_specs ${CHANGES_DIFFS_DIR}; then\n-        exit 0\n-      else\n+      tooling/bin/qa/package_and_qa_check ${CHANGES_DIFFS_DIR} \u0026\u0026 exit_code=$?\n+      if [ $exit_code -eq 0 ]; then\n         ./scripts/trigger-build omnibus\n+      elif [ $exit_code -eq 1 ]; then\n+        exit 1\n+      else\n+        echo \"Downstream jobs will not be triggered because package_and_qa_check exited with code: $exit_code\"\n       fi\n   # These jobs often time out, so temporarily use private runners and a long timeout: https://gitlab.com/gitlab-org/gitlab/-/issues/238563\n   tags:\n"},{"old_path":".gitlab/ci/rails.gitlab-ci.yml","new_path":".gitlab/ci/rails.gitlab-ci.yml","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -534,6 +534,50 @@ rspec:feature-flags:\n         run_timed_command \"bundle exec scripts/used-feature-flags\";\n       fi\n \n+rspec:skipped-flaky-tests-report:\n+  extends:\n+    - .default-retry\n+    - .rails:rules:skipped-flaky-tests-report\n+  image: ruby:2.7-alpine\n+  stage: post-test\n+  # We cannot use needs since it would mean needing 84 jobs (since most are parallelized)\n+  # so we use `dependencies` here.\n+  dependencies:\n+    # FOSS/EE jobs\n+    - rspec migration pg12\n+    - rspec unit pg12\n+    - rspec integration pg12\n+    - rspec system pg12\n+    # FOSS/EE minimal jobs\n+    - rspec migration pg12 minimal\n+    - rspec unit pg12 minimal\n+    - rspec integration pg12 minimal\n+    - rspec system pg12 minimal\n+    # EE jobs\n+    - rspec-ee migration pg12\n+    - rspec-ee unit pg12\n+    - rspec-ee integration pg12\n+    - rspec-ee system pg12\n+    # EE minimal jobs\n+    - rspec-ee migration pg12 minimal\n+    - rspec-ee unit pg12 minimal\n+    - rspec-ee integration pg12 minimal\n+    - rspec-ee system pg12 minimal\n+    # Geo jobs\n+    - rspec-ee unit pg12 geo\n+    - rspec-ee integration pg12 geo\n+    - rspec-ee system pg12 geo\n+    # Geo minimal jobs\n+    - rspec-ee unit pg12 geo minimal\n+    - rspec-ee integration pg12 geo minimal\n+    - rspec-ee system pg12 geo minimal\n+  script:\n+    - cat rspec_flaky/skipped_flaky_tests_*_report.txt \u003e\u003e skipped_flaky_tests_report.txt\n+  artifacts:\n+    expire_in: 31d\n+    paths:\n+      - skipped_flaky_tests_report.txt\n+\n # EE/FOSS: default refs (MRs, default branch, schedules) jobs #\n #######################################################\n \n"},{"old_path":".gitlab/ci/rules.gitlab-ci.yml","new_path":".gitlab/ci/rules.gitlab-ci.yml","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -1352,6 +1352,13 @@\n       when: never\n     - changes: *code-backstage-patterns\n \n+.rails:rules:skipped-flaky-tests-report:\n+  rules:\n+    - \u003c\u003c: *if-not-ee\n+      when: never\n+    - if: '$SKIP_FLAKY_TESTS_AUTOMATICALLY == \"true\"'\n+      changes: *code-backstage-patterns\n+\n #########################\n # Static analysis rules #\n #########################\n"},{"old_path":"CHANGELOG.md","new_path":"CHANGELOG.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -2,6 +2,22 @@\n documentation](doc/development/changelog.md) for instructions on adding your own\n entry.\n \n+## 14.4.2 (2021-11-08)\n+\n+### Fixed (3 changes)\n+\n+- [Skip retrying for reads on connection errors if primary only](gitlab-org/gitlab@8e1976ed75bd6c606d49c83863cf46bf3c4d5070) ([merge request](gitlab-org/gitlab!73919))\n+- [Fix error 500 loading branch with UTF-8 characters with performance bar](gitlab-org/gitlab@67ddc428472d57bb3d8a4a84eb0750487a175f75) ([merge request](gitlab-org/gitlab!73919))\n+- [Skip st_diff callback setting on LegacyDiffNote when importing](gitlab-org/gitlab@84f5c66321473cd702b3b671584054fcf3d141ae) ([merge request](gitlab-org/gitlab!73919))\n+\n+### Changed (1 change)\n+\n+- [Remove skip_legacy_diff_note_callback_on_import from legacy diff note](gitlab-org/gitlab@547a2ec29ea9e9299eab727899c3d90886ffc21c) ([merge request](gitlab-org/gitlab!73919))\n+\n+### Performance (1 change)\n+\n+- [Prevent Sidekiq size limiter middleware from running multiple times on the same job](gitlab-org/gitlab@294c01be38d400607536fb20a2038e098c0f0e28) ([merge request](gitlab-org/gitlab!73919))\n+\n ## 14.4.1 (2021-10-28)\n \n ### Security (13 changes)\n"},{"old_path":"GITALY_SERVER_VERSION","new_path":"GITALY_SERVER_VERSION","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -1 +1 @@\n-7b9cd199b0851fd1b6615e0798f2aafddafd63cb\n+460a880c6993ab5f76cac951fccc02efd5cbd444\n"},{"old_path":"Gemfile","new_path":"Gemfile","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -342,7 +342,7 @@ group :development do\n   gem 'lefthook', '~\u003e 0.7.0', require: false\n   gem 'solargraph', '~\u003e 0.43', require: false\n \n-  gem 'letter_opener_web', '~\u003e 1.4.1'\n+  gem 'letter_opener_web', '~\u003e 2.0.0'\n \n   # Better errors handler\n   gem 'better_errors', '~\u003e 2.9.0'\n"},{"old_path":"Gemfile.lock","new_path":"Gemfile.lock","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -700,10 +700,11 @@ GEM\n     lefthook (0.7.5)\n     letter_opener (1.7.0)\n       launchy (~\u003e 2.2)\n-    letter_opener_web (1.4.1)\n-      actionmailer (\u003e= 3.2)\n-      letter_opener (~\u003e 1.0)\n-      railties (\u003e= 3.2)\n+    letter_opener_web (2.0.0)\n+      actionmailer (\u003e= 5.2)\n+      letter_opener (~\u003e 1.7)\n+      railties (\u003e= 5.2)\n+      rexml\n     libyajl2 (1.2.0)\n     license_finder (6.0.0)\n       bundler\n@@ -1516,7 +1517,7 @@ DEPENDENCIES\n   kramdown (~\u003e 2.3.1)\n   kubeclient (~\u003e 4.9.2)\n   lefthook (~\u003e 0.7.0)\n-  letter_opener_web (~\u003e 1.4.1)\n+  letter_opener_web (~\u003e 2.0.0)\n   license_finder (~\u003e 6.0)\n   licensee (~\u003e 9.14.1)\n   lockbox (~\u003e 0.6.2)\n"},{"old_path":"app/assets/javascripts/analytics/devops_report/components/devops_score.vue","new_path":"app/assets/javascripts/analytics/devops_reports/components/devops_score.vue","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":true,"deleted_file":false,"diff":""},{"old_path":"app/assets/javascripts/analytics/devops_report/components/devops_score_callout.vue","new_path":"app/assets/javascripts/analytics/devops_reports/components/devops_score_callout.vue","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":true,"deleted_file":false,"diff":""},{"old_path":"app/assets/javascripts/analytics/devops_report/components/service_ping_disabled.vue","new_path":"app/assets/javascripts/analytics/devops_reports/components/service_ping_disabled.vue","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":true,"deleted_file":false,"diff":""},{"old_path":"app/assets/javascripts/analytics/devops_report/constants.js","new_path":"app/assets/javascripts/analytics/devops_reports/constants.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":true,"deleted_file":false,"diff":""},{"old_path":"app/assets/javascripts/analytics/devops_report/devops_score.js","new_path":"app/assets/javascripts/analytics/devops_reports/devops_score.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":true,"deleted_file":false,"diff":""},{"old_path":"app/assets/javascripts/analytics/devops_report/devops_score_disabled_service_ping.js","new_path":"app/assets/javascripts/analytics/devops_reports/devops_score_disabled_service_ping.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":true,"deleted_file":false,"diff":""},{"old_path":"app/assets/javascripts/boards/graphql/group_board_iterations.query.graphql","new_path":"app/assets/javascripts/boards/graphql/group_board_iterations.query.graphql","a_mode":"100644","b_mode":"0","new_file":false,"renamed_file":false,"deleted_file":true,"diff":"@@ -1,10 +0,0 @@\n-query GroupBoardIterations($fullPath: ID!, $title: String) {\n-  group(fullPath: $fullPath) {\n-    iterations(includeAncestors: true, title: $title) {\n-      nodes {\n-        id\n-        title\n-      }\n-    }\n-  }\n-}\n"},{"old_path":"app/assets/javascripts/boards/graphql/project_board_iterations.query.graphql","new_path":"app/assets/javascripts/boards/graphql/project_board_iterations.query.graphql","a_mode":"100644","b_mode":"0","new_file":false,"renamed_file":false,"deleted_file":true,"diff":"@@ -1,10 +0,0 @@\n-query ProjectBoardIterations($fullPath: ID!, $title: String) {\n-  project(fullPath: $fullPath) {\n-    iterations(includeAncestors: true, title: $title) {\n-      nodes {\n-        id\n-        title\n-      }\n-    }\n-  }\n-}\n"},{"old_path":"app/assets/javascripts/boards/stores/actions.js","new_path":"app/assets/javascripts/boards/stores/actions.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -36,13 +36,11 @@ import {\n } from '../boards_util';\n import { gqlClient } from '../graphql';\n import boardLabelsQuery from '../graphql/board_labels.query.graphql';\n-import groupBoardIterationsQuery from '../graphql/group_board_iterations.query.graphql';\n import groupBoardMilestonesQuery from '../graphql/group_board_milestones.query.graphql';\n import groupProjectsQuery from '../graphql/group_projects.query.graphql';\n import issueCreateMutation from '../graphql/issue_create.mutation.graphql';\n import issueSetLabelsMutation from '../graphql/issue_set_labels.mutation.graphql';\n import listsIssuesQuery from '../graphql/lists_issues.query.graphql';\n-import projectBoardIterationsQuery from '../graphql/project_board_iterations.query.graphql';\n import projectBoardMilestonesQuery from '../graphql/project_board_milestones.query.graphql';\n \n import * as types from './mutation_types';\n@@ -203,52 +201,6 @@ export default {\n       });\n   },\n \n-  fetchIterations({ state, commit }, title) {\n-    commit(types.RECEIVE_ITERATIONS_REQUEST);\n-\n-    const { fullPath, boardType } = state;\n-\n-    const variables = {\n-      fullPath,\n-      title,\n-    };\n-\n-    let query;\n-    if (boardType === BoardType.project) {\n-      query = projectBoardIterationsQuery;\n-    }\n-    if (boardType === BoardType.group) {\n-      query = groupBoardIterationsQuery;\n-    }\n-\n-    if (!query) {\n-      // eslint-disable-next-line @gitlab/require-i18n-strings\n-      throw new Error('Unknown board type');\n-    }\n-\n-    return gqlClient\n-      .query({\n-        query,\n-        variables,\n-      })\n-      .then(({ data }) =\u003e {\n-        const errors = data[boardType]?.errors;\n-        const iterations = data[boardType]?.iterations.nodes;\n-\n-        if (errors?.[0]) {\n-          throw new Error(errors[0]);\n-        }\n-\n-        commit(types.RECEIVE_ITERATIONS_SUCCESS, iterations);\n-\n-        return iterations;\n-      })\n-      .catch((e) =\u003e {\n-        commit(types.RECEIVE_ITERATIONS_FAILURE);\n-        throw e;\n-      });\n-  },\n-\n   fetchMilestones({ state, commit }, searchTerm) {\n     commit(types.RECEIVE_MILESTONES_REQUEST);\n \n"},{"old_path":"app/assets/javascripts/boards/stores/mutation_types.js","new_path":"app/assets/javascripts/boards/stores/mutation_types.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -41,7 +41,3 @@ export const ADD_LIST_TO_HIGHLIGHTED_LISTS = 'ADD_LIST_TO_HIGHLIGHTED_LISTS';\n export const REMOVE_LIST_FROM_HIGHLIGHTED_LISTS = 'REMOVE_LIST_FROM_HIGHLIGHTED_LISTS';\n export const RESET_BOARD_ITEM_SELECTION = 'RESET_BOARD_ITEM_SELECTION';\n export const SET_ERROR = 'SET_ERROR';\n-\n-export const RECEIVE_ITERATIONS_REQUEST = 'RECEIVE_ITERATIONS_REQUEST';\n-export const RECEIVE_ITERATIONS_SUCCESS = 'RECEIVE_ITERATIONS_SUCCESS';\n-export const RECEIVE_ITERATIONS_FAILURE = 'RECEIVE_ITERATIONS_FAILURE';\n"},{"old_path":"app/assets/javascripts/boards/stores/mutations.js","new_path":"app/assets/javascripts/boards/stores/mutations.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -64,20 +64,6 @@ export default {\n     );\n   },\n \n-  [mutationTypes.RECEIVE_ITERATIONS_REQUEST](state) {\n-    state.iterationsLoading = true;\n-  },\n-\n-  [mutationTypes.RECEIVE_ITERATIONS_SUCCESS](state, iterations) {\n-    state.iterations = iterations;\n-    state.iterationsLoading = false;\n-  },\n-\n-  [mutationTypes.RECEIVE_ITERATIONS_FAILURE](state) {\n-    state.iterationsLoading = false;\n-    state.error = __('Failed to load iterations.');\n-  },\n-\n   [mutationTypes.SET_ACTIVE_ID](state, { id, sidebarType }) {\n     state.activeId = id;\n     state.sidebarType = sidebarType;\n"},{"old_path":"app/assets/javascripts/diffs/components/app.vue","new_path":"app/assets/javascripts/diffs/components/app.vue","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -44,6 +44,7 @@ import {\n   TRACKING_MULTIPLE_FILES_MODE,\n } from '../constants';\n \n+import { discussionIntersectionObserverHandlerFactory } from '../utils/discussions';\n import diffsEventHub from '../event_hub';\n import { reviewStatuses } from '../utils/file_reviews';\n import { diffsApp } from '../utils/performance';\n@@ -86,6 +87,9 @@ export default {\n     ALERT_MERGE_CONFLICT,\n     ALERT_COLLAPSED_FILES,\n   },\n+  provide: {\n+    discussionObserverHandler: discussionIntersectionObserverHandlerFactory(),\n+  },\n   props: {\n     endpoint: {\n       type: String,\n"},{"old_path":"app/assets/javascripts/diffs/utils/discussions.js","new_path":"app/assets/javascripts/diffs/utils/discussions.js","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,76 @@\n+function normalize(processable) {\n+  const { entry } = processable;\n+  const offset = entry.rootBounds.bottom - entry.boundingClientRect.top;\n+  const direction =\n+    offset \u003c 0 ? 'Up' : 'Down'; /* eslint-disable-line @gitlab/require-i18n-strings */\n+\n+  return {\n+    ...processable,\n+    entry: {\n+      time: entry.time,\n+      type: entry.isIntersecting ? 'intersection' : `scroll${direction}`,\n+    },\n+  };\n+}\n+\n+function sort({ entry: alpha }, { entry: beta }) {\n+  const diff = alpha.time - beta.time;\n+  let order = 0;\n+\n+  if (diff \u003c 0) {\n+    order = -1;\n+  } else if (diff \u003e 0) {\n+    order = 1;\n+  } else if (alpha.type === 'intersection' \u0026\u0026 beta.type === 'scrollUp') {\n+    order = 2;\n+  } else if (alpha.type === 'scrollUp' \u0026\u0026 beta.type === 'intersection') {\n+    order = -2;\n+  }\n+\n+  return order;\n+}\n+\n+function filter(entry) {\n+  return entry.type !== 'scrollDown';\n+}\n+\n+export function discussionIntersectionObserverHandlerFactory() {\n+  let unprocessed = [];\n+  let timer = null;\n+\n+  return (processable) =\u003e {\n+    unprocessed.push(processable);\n+\n+    if (timer) {\n+      clearTimeout(timer);\n+    }\n+\n+    timer = setTimeout(() =\u003e {\n+      unprocessed\n+        .map(normalize)\n+        .filter(filter)\n+        .sort(sort)\n+        .forEach((discussionObservationContainer) =\u003e {\n+          const {\n+            entry: { type },\n+            currentDiscussion,\n+            isFirstUnresolved,\n+            isDiffsPage,\n+            functions: { setCurrentDiscussionId, getPreviousUnresolvedDiscussionId },\n+          } = discussionObservationContainer;\n+\n+          if (type === 'intersection') {\n+            setCurrentDiscussionId(currentDiscussion.id);\n+          } else if (type === 'scrollUp') {\n+            setCurrentDiscussionId(\n+              isFirstUnresolved\n+                ? null\n+                : getPreviousUnresolvedDiscussionId(currentDiscussion.id, isDiffsPage),\n+            );\n+          }\n+        });\n+\n+      unprocessed = [];\n+    }, 0);\n+  };\n+}\n"},{"old_path":"app/assets/javascripts/notes/components/discussion_notes.vue","new_path":"app/assets/javascripts/notes/components/discussion_notes.vue","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -1,5 +1,6 @@\n \u003cscript\u003e\n import { mapGetters, mapActions } from 'vuex';\n+import { GlIntersectionObserver } from '@gitlab/ui';\n import { __ } from '~/locale';\n import PlaceholderNote from '~/vue_shared/components/notes/placeholder_note.vue';\n import PlaceholderSystemNote from '~/vue_shared/components/notes/placeholder_system_note.vue';\n@@ -16,7 +17,9 @@ export default {\n     ToggleRepliesWidget,\n     NoteEditedText,\n     DiscussionNotesRepliesWrapper,\n+    GlIntersectionObserver,\n   },\n+  inject: ['discussionObserverHandler'],\n   props: {\n     discussion: {\n       type: Object,\n@@ -54,7 +57,11 @@ export default {\n     },\n   },\n   computed: {\n-    ...mapGetters(['userCanReply']),\n+    ...mapGetters([\n+      'userCanReply',\n+      'previousUnresolvedDiscussionId',\n+      'firstUnresolvedDiscussionId',\n+    ]),\n     hasReplies() {\n       return Boolean(this.replies.length);\n     },\n@@ -77,9 +84,20 @@ export default {\n         url: this.discussion.discussion_path,\n       };\n     },\n+    isFirstUnresolved() {\n+      return this.firstUnresolvedDiscussionId === this.discussion.id;\n+    },\n+  },\n+  observerOptions: {\n+    threshold: 0,\n+    rootMargin: '0px 0px -50% 0px',\n   },\n   methods: {\n-    ...mapActions(['toggleDiscussion', 'setSelectedCommentPositionHover']),\n+    ...mapActions([\n+      'toggleDiscussion',\n+      'setSelectedCommentPositionHover',\n+      'setCurrentDiscussionId',\n+    ]),\n     componentName(note) {\n       if (note.isPlaceholderNote) {\n         if (note.placeholderType === SYSTEM_NOTE) {\n@@ -110,6 +128,18 @@ export default {\n         this.setSelectedCommentPositionHover();\n       }\n     },\n+    observerTriggered(entry) {\n+      this.discussionObserverHandler({\n+        entry,\n+        isFirstUnresolved: this.isFirstUnresolved,\n+        currentDiscussion: { ...this.discussion },\n+        isDiffsPage: !this.isOverviewTab,\n+        functions: {\n+          setCurrentDiscussionId: this.setCurrentDiscussionId,\n+          getPreviousUnresolvedDiscussionId: this.previousUnresolvedDiscussionId,\n+        },\n+      });\n+    },\n   },\n };\n \u003c/script\u003e\n@@ -122,33 +152,35 @@ export default {\n       @mouseleave=\"handleMouseLeave(discussion)\"\n     \u003e\n       \u003ctemplate v-if=\"shouldGroupReplies\"\u003e\n-        \u003ccomponent\n-          :is=\"componentName(firstNote)\"\n-          :note=\"componentData(firstNote)\"\n-          :line=\"line || diffLine\"\n-          :discussion-file=\"discussion.diff_file\"\n-          :commit=\"commit\"\n-          :help-page-path=\"helpPagePath\"\n-          :show-reply-button=\"userCanReply\"\n-          :discussion-root=\"true\"\n-          :discussion-resolve-path=\"discussion.resolve_path\"\n-          :is-overview-tab=\"isOverviewTab\"\n-          @handleDeleteNote=\"$emit('deleteNote')\"\n-          @startReplying=\"$emit('startReplying')\"\n-        \u003e\n-          \u003ctemplate #discussion-resolved-text\u003e\n-            \u003cnote-edited-text\n-              v-if=\"discussion.resolved\"\n-              :edited-at=\"discussion.resolved_at\"\n-              :edited-by=\"discussion.resolved_by\"\n-              :action-text=\"resolvedText\"\n-              class-name=\"discussion-headline-light js-discussion-headline discussion-resolved-text\"\n-            /\u003e\n-          \u003c/template\u003e\n-          \u003ctemplate #avatar-badge\u003e\n-            \u003cslot name=\"avatar-badge\"\u003e\u003c/slot\u003e\n-          \u003c/template\u003e\n-        \u003c/component\u003e\n+        \u003cgl-intersection-observer :options=\"$options.observerOptions\" @update=\"observerTriggered\"\u003e\n+          \u003ccomponent\n+            :is=\"componentName(firstNote)\"\n+            :note=\"componentData(firstNote)\"\n+            :line=\"line || diffLine\"\n+            :discussion-file=\"discussion.diff_file\"\n+            :commit=\"commit\"\n+            :help-page-path=\"helpPagePath\"\n+            :show-reply-button=\"userCanReply\"\n+            :discussion-root=\"true\"\n+            :discussion-resolve-path=\"discussion.resolve_path\"\n+            :is-overview-tab=\"isOverviewTab\"\n+            @handleDeleteNote=\"$emit('deleteNote')\"\n+            @startReplying=\"$emit('startReplying')\"\n+          \u003e\n+            \u003ctemplate #discussion-resolved-text\u003e\n+              \u003cnote-edited-text\n+                v-if=\"discussion.resolved\"\n+                :edited-at=\"discussion.resolved_at\"\n+                :edited-by=\"discussion.resolved_by\"\n+                :action-text=\"resolvedText\"\n+                class-name=\"discussion-headline-light js-discussion-headline discussion-resolved-text\"\n+              /\u003e\n+            \u003c/template\u003e\n+            \u003ctemplate #avatar-badge\u003e\n+              \u003cslot name=\"avatar-badge\"\u003e\u003c/slot\u003e\n+            \u003c/template\u003e\n+          \u003c/component\u003e\n+        \u003c/gl-intersection-observer\u003e\n         \u003cdiscussion-notes-replies-wrapper :is-diff-discussion=\"discussion.diff_discussion\"\u003e\n           \u003ctoggle-replies-widget\n             v-if=\"hasReplies\"\n"},{"old_path":"app/assets/javascripts/notes/components/notes_app.vue","new_path":"app/assets/javascripts/notes/components/notes_app.vue","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -8,6 +8,7 @@ import TimelineEntryItem from '~/vue_shared/components/notes/timeline_entry_item\n import OrderedLayout from '~/vue_shared/components/ordered_layout.vue';\n import glFeatureFlagsMixin from '~/vue_shared/mixins/gl_feature_flags_mixin';\n import draftNote from '../../batch_comments/components/draft_note.vue';\n+import { discussionIntersectionObserverHandlerFactory } from '../../diffs/utils/discussions';\n import { getLocationHash, doesHashExistInUrl } from '../../lib/utils/url_utility';\n import placeholderNote from '../../vue_shared/components/notes/placeholder_note.vue';\n import placeholderSystemNote from '../../vue_shared/components/notes/placeholder_system_note.vue';\n@@ -38,6 +39,9 @@ export default {\n     TimelineEntryItem,\n   },\n   mixins: [glFeatureFlagsMixin()],\n+  provide: {\n+    discussionObserverHandler: discussionIntersectionObserverHandlerFactory(),\n+  },\n   props: {\n     noteableData: {\n       type: Object,\n"},{"old_path":"app/assets/javascripts/pages/admin/dev_ops_report/index.js","new_path":"app/assets/javascripts/pages/admin/dev_ops_report/index.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -1,5 +1,5 @@\n-import initDevOpsScore from '~/analytics/devops_report/devops_score';\n-import initDevOpsScoreDisabledServicePing from '~/analytics/devops_report/devops_score_disabled_service_ping';\n+import initDevOpsScore from '~/analytics/devops_reports/devops_score';\n+import initDevOpsScoreDisabledServicePing from '~/analytics/devops_reports/devops_score_disabled_service_ping';\n \n initDevOpsScoreDisabledServicePing();\n initDevOpsScore();\n"},{"old_path":"app/assets/javascripts/runner/components/cells/runner_actions_cell.vue","new_path":"app/assets/javascripts/runner/components/cells/runner_actions_cell.vue","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -3,7 +3,7 @@ import { GlButton, GlButtonGroup, GlTooltipDirective } from '@gitlab/ui';\n import createFlash from '~/flash';\n import { __, s__ } from '~/locale';\n import runnerDeleteMutation from '~/runner/graphql/runner_delete.mutation.graphql';\n-import runnerUpdateMutation from '~/runner/graphql/runner_update.mutation.graphql';\n+import runnerActionsUpdateMutation from '~/runner/graphql/runner_actions_update.mutation.graphql';\n import { captureException } from '~/runner/sentry_utils';\n \n const i18n = {\n@@ -71,7 +71,7 @@ export default {\n             runnerUpdate: { errors },\n           },\n         } = await this.$apollo.mutate({\n-          mutation: runnerUpdateMutation,\n+          mutation: runnerActionsUpdateMutation,\n           variables: {\n             input: {\n               id: this.runner.id,\n"},{"old_path":"app/assets/javascripts/runner/components/cells/runner_type_cell.vue","new_path":"app/assets/javascripts/runner/components/cells/runner_status_cell.vue","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":true,"deleted_file":false,"diff":"@@ -1,15 +1,15 @@\n \u003cscript\u003e\n import { GlTooltipDirective } from '@gitlab/ui';\n-import RunnerTypeBadge from '../runner_type_badge.vue';\n-import RunnerStateLockedBadge from '../runner_state_locked_badge.vue';\n-import RunnerStatePausedBadge from '../runner_state_paused_badge.vue';\n+\n+import RunnerContactedStateBadge from '../runner_contacted_state_badge.vue';\n+import RunnerPausedBadge from '../runner_paused_badge.vue';\n+\n import { I18N_LOCKED_RUNNER_DESCRIPTION, I18N_PAUSED_RUNNER_DESCRIPTION } from '../../constants';\n \n export default {\n   components: {\n-    RunnerTypeBadge,\n-    RunnerStateLockedBadge,\n-    RunnerStatePausedBadge,\n+    RunnerContactedStateBadge,\n+    RunnerPausedBadge,\n   },\n   directives: {\n     GlTooltip: GlTooltipDirective,\n@@ -21,12 +21,6 @@ export default {\n     },\n   },\n   computed: {\n-    runnerType() {\n-      return this.runner.runnerType;\n-    },\n-    locked() {\n-      return this.runner.locked;\n-    },\n     paused() {\n       return !this.runner.active;\n     },\n@@ -40,8 +34,7 @@ export default {\n \n \u003ctemplate\u003e\n   \u003cdiv\u003e\n-    \u003crunner-type-badge :type=\"runnerType\" size=\"sm\" /\u003e\n-    \u003crunner-state-locked-badge v-if=\"locked\" size=\"sm\" /\u003e\n-    \u003crunner-state-paused-badge v-if=\"paused\" size=\"sm\" /\u003e\n+    \u003crunner-contacted-state-badge :runner=\"runner\" size=\"sm\" /\u003e\n+    \u003crunner-paused-badge v-if=\"paused\" size=\"sm\" /\u003e\n   \u003c/div\u003e\n \u003c/template\u003e\n"},{"old_path":"app/assets/javascripts/runner/components/cells/runner_summary_cell.vue","new_path":"app/assets/javascripts/runner/components/cells/runner_summary_cell.vue","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -1,11 +1,21 @@\n \u003cscript\u003e\n+import { GlIcon, GlTooltipDirective } from '@gitlab/ui';\n+\n import TooltipOnTruncate from '~/vue_shared/components/tooltip_on_truncate.vue';\n import RunnerName from '../runner_name.vue';\n+import RunnerTypeBadge from '../runner_type_badge.vue';\n+\n+import { I18N_LOCKED_RUNNER_DESCRIPTION } from '../../constants';\n \n export default {\n   components: {\n+    GlIcon,\n     TooltipOnTruncate,\n     RunnerName,\n+    RunnerTypeBadge,\n+  },\n+  directives: {\n+    GlTooltip: GlTooltipDirective,\n   },\n   props: {\n     runner: {\n@@ -14,10 +24,19 @@ export default {\n     },\n   },\n   computed: {\n+    runnerType() {\n+      return this.runner.runnerType;\n+    },\n+    locked() {\n+      return this.runner.locked;\n+    },\n     description() {\n       return this.runner.description;\n     },\n   },\n+  i18n: {\n+    I18N_LOCKED_RUNNER_DESCRIPTION,\n+  },\n };\n \u003c/script\u003e\n \n@@ -26,6 +45,14 @@ export default {\n     \u003cslot :runner=\"runner\" name=\"runner-name\"\u003e\n       \u003crunner-name :runner=\"runner\" /\u003e\n     \u003c/slot\u003e\n+\n+    \u003crunner-type-badge :type=\"runnerType\" size=\"sm\" /\u003e\n+    \u003cgl-icon\n+      v-if=\"locked\"\n+      v-gl-tooltip\n+      :title=\"$options.i18n.I18N_LOCKED_RUNNER_DESCRIPTION\"\n+      name=\"lock\"\n+    /\u003e\n     \u003ctooltip-on-truncate class=\"gl-display-block\" :title=\"description\" truncate-target=\"child\"\u003e\n       \u003cdiv class=\"gl-text-truncate\"\u003e\n         {{ description }}\n"},{"old_path":"app/assets/javascripts/runner/components/runner_contacted_state_badge.vue","new_path":"app/assets/javascripts/runner/components/runner_contacted_state_badge.vue","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,69 @@\n+\u003cscript\u003e\n+import { GlBadge, GlTooltipDirective } from '@gitlab/ui';\n+import { s__, sprintf } from '~/locale';\n+import { getTimeago } from '~/lib/utils/datetime_utility';\n+import {\n+  I18N_ONLINE_RUNNER_DESCRIPTION,\n+  I18N_OFFLINE_RUNNER_DESCRIPTION,\n+  I18N_NOT_CONNECTED_RUNNER_DESCRIPTION,\n+  STATUS_ONLINE,\n+  STATUS_OFFLINE,\n+  STATUS_NOT_CONNECTED,\n+} from '../constants';\n+\n+export default {\n+  components: {\n+    GlBadge,\n+  },\n+  directives: {\n+    GlTooltip: GlTooltipDirective,\n+  },\n+  props: {\n+    runner: {\n+      required: true,\n+      type: Object,\n+    },\n+  },\n+  computed: {\n+    contactedAtTimeAgo() {\n+      if (this.runner.contactedAt) {\n+        return getTimeago().format(this.runner.contactedAt);\n+      }\n+      return null;\n+    },\n+    badge() {\n+      switch (this.runner.status) {\n+        case STATUS_ONLINE:\n+          return {\n+            variant: 'success',\n+            label: s__('Runners|online'),\n+            tooltip: sprintf(I18N_ONLINE_RUNNER_DESCRIPTION, {\n+              timeAgo: this.contactedAtTimeAgo,\n+            }),\n+          };\n+        case STATUS_OFFLINE:\n+          return {\n+            variant: 'muted',\n+            label: s__('Runners|offline'),\n+            tooltip: sprintf(I18N_OFFLINE_RUNNER_DESCRIPTION, {\n+              timeAgo: this.contactedAtTimeAgo,\n+            }),\n+          };\n+        case STATUS_NOT_CONNECTED:\n+          return {\n+            variant: 'muted',\n+            label: s__('Runners|not connected'),\n+            tooltip: I18N_NOT_CONNECTED_RUNNER_DESCRIPTION,\n+          };\n+        default:\n+          return null;\n+      }\n+    },\n+  },\n+};\n+\u003c/script\u003e\n+\u003ctemplate\u003e\n+  \u003cgl-badge v-if=\"badge\" v-gl-tooltip=\"badge.tooltip\" :variant=\"badge.variant\" v-bind=\"$attrs\"\u003e\n+    {{ badge.label }}\n+  \u003c/gl-badge\u003e\n+\u003c/template\u003e\n"},{"old_path":"app/assets/javascripts/runner/components/runner_list.vue","new_path":"app/assets/javascripts/runner/components/runner_list.vue","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -5,7 +5,7 @@ import { __, s__ } from '~/locale';\n import TimeAgo from '~/vue_shared/components/time_ago_tooltip.vue';\n import RunnerActionsCell from './cells/runner_actions_cell.vue';\n import RunnerSummaryCell from './cells/runner_summary_cell.vue';\n-import RunnerTypeCell from './cells/runner_type_cell.vue';\n+import RunnerStatusCell from './cells/runner_status_cell.vue';\n import RunnerTags from './runner_tags.vue';\n \n const tableField = ({ key, label = '', width = 10 }) =\u003e {\n@@ -36,7 +36,7 @@ export default {\n     RunnerActionsCell,\n     RunnerSummaryCell,\n     RunnerTags,\n-    RunnerTypeCell,\n+    RunnerStatusCell,\n   },\n   directives: {\n     GlTooltip: GlTooltipDirective,\n@@ -63,8 +63,8 @@ export default {\n     },\n   },\n   fields: [\n-    tableField({ key: 'type', label: __('Type/State') }),\n-    tableField({ key: 'summary', label: s__('Runners|Runner'), width: 30 }),\n+    tableField({ key: 'status', label: s__('Runners|Status') }),\n+    tableField({ key: 'summary', label: s__('Runners|Runner ID'), width: 30 }),\n     tableField({ key: 'version', label: __('Version') }),\n     tableField({ key: 'ipAddress', label: __('IP Address') }),\n     tableField({ key: 'tagList', label: __('Tags'), width: 20 }),\n@@ -88,8 +88,8 @@ export default {\n         \u003cgl-skeleton-loader v-for=\"i in 4\" :key=\"i\" /\u003e\n       \u003c/template\u003e\n \n-      \u003ctemplate #cell(type)=\"{ item }\"\u003e\n-        \u003crunner-type-cell :runner=\"item\" /\u003e\n+      \u003ctemplate #cell(status)=\"{ item }\"\u003e\n+        \u003crunner-status-cell :runner=\"item\" /\u003e\n       \u003c/template\u003e\n \n       \u003ctemplate #cell(summary)=\"{ item, index }\"\u003e\n"},{"old_path":"app/assets/javascripts/runner/components/runner_state_paused_badge.vue","new_path":"app/assets/javascripts/runner/components/runner_paused_badge.vue","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":true,"deleted_file":false,"diff":""},{"old_path":"app/assets/javascripts/runner/components/runner_state_locked_badge.vue","new_path":"app/assets/javascripts/runner/components/runner_state_locked_badge.vue","a_mode":"100644","b_mode":"0","new_file":false,"renamed_file":false,"deleted_file":true,"diff":"@@ -1,25 +0,0 @@\n-\u003cscript\u003e\n-import { GlBadge, GlTooltipDirective } from '@gitlab/ui';\n-import { I18N_LOCKED_RUNNER_DESCRIPTION } from '../constants';\n-\n-export default {\n-  components: {\n-    GlBadge,\n-  },\n-  directives: {\n-    GlTooltip: GlTooltipDirective,\n-  },\n-  i18n: {\n-    I18N_LOCKED_RUNNER_DESCRIPTION,\n-  },\n-};\n-\u003c/script\u003e\n-\u003ctemplate\u003e\n-  \u003cgl-badge\n-    v-gl-tooltip=\"$options.i18n.I18N_LOCKED_RUNNER_DESCRIPTION\"\n-    variant=\"warning\"\n-    v-bind=\"$attrs\"\n-  \u003e\n-    {{ s__('Runners|locked') }}\n-  \u003c/gl-badge\u003e\n-\u003c/template\u003e\n"},{"old_path":"app/assets/javascripts/runner/components/runner_type_alert.vue","new_path":"app/assets/javascripts/runner/components/runner_type_alert.vue","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -9,17 +9,14 @@ const ALERT_DATA = {\n     message: s__(\n       'Runners|This runner is available to all groups and projects in your GitLab instance.',\n     ),\n-    variant: 'success',\n     anchor: 'shared-runners',\n   },\n   [GROUP_TYPE]: {\n     message: s__('Runners|This runner is available to all projects and subgroups in a group.'),\n-    variant: 'success',\n     anchor: 'group-runners',\n   },\n   [PROJECT_TYPE]: {\n     message: s__('Runners|This runner is associated with one or more projects.'),\n-    variant: 'info',\n     anchor: 'specific-runners',\n   },\n };\n@@ -50,7 +47,7 @@ export default {\n };\n \u003c/script\u003e\n \u003ctemplate\u003e\n-  \u003cgl-alert v-if=\"alert\" :variant=\"alert.variant\" :dismissible=\"false\"\u003e\n+  \u003cgl-alert v-if=\"alert\" variant=\"info\" :dismissible=\"false\"\u003e\n     {{ alert.message }}\n     \u003cgl-link :href=\"helpHref\"\u003e{{ __('Learn more.') }}\u003c/gl-link\u003e\n   \u003c/gl-alert\u003e\n"},{"old_path":"app/assets/javascripts/runner/components/runner_type_badge.vue","new_path":"app/assets/javascripts/runner/components/runner_type_badge.vue","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -12,17 +12,14 @@ import {\n \n const BADGE_DATA = {\n   [INSTANCE_TYPE]: {\n-    variant: 'success',\n     text: s__('Runners|shared'),\n     tooltip: I18N_INSTANCE_RUNNER_DESCRIPTION,\n   },\n   [GROUP_TYPE]: {\n-    variant: 'success',\n     text: s__('Runners|group'),\n     tooltip: I18N_GROUP_RUNNER_DESCRIPTION,\n   },\n   [PROJECT_TYPE]: {\n-    variant: 'info',\n     text: s__('Runners|specific'),\n     tooltip: I18N_PROJECT_RUNNER_DESCRIPTION,\n   },\n@@ -53,7 +50,7 @@ export default {\n };\n \u003c/script\u003e\n \u003ctemplate\u003e\n-  \u003cgl-badge v-if=\"badge\" v-gl-tooltip=\"badge.tooltip\" :variant=\"badge.variant\" v-bind=\"$attrs\"\u003e\n+  \u003cgl-badge v-if=\"badge\" v-gl-tooltip=\"badge.tooltip\" variant=\"info\" v-bind=\"$attrs\"\u003e\n     {{ badge.text }}\n   \u003c/gl-badge\u003e\n \u003c/template\u003e\n"},{"old_path":"app/assets/javascripts/runner/constants.js","new_path":"app/assets/javascripts/runner/constants.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -6,11 +6,24 @@ export const GROUP_RUNNER_COUNT_LIMIT = 1000;\n export const I18N_FETCH_ERROR = s__('Runners|Something went wrong while fetching runner data.');\n export const I18N_DETAILS_TITLE = s__('Runners|Runner #%{runner_id}');\n \n+// Type\n export const I18N_INSTANCE_RUNNER_DESCRIPTION = s__('Runners|Available to all projects');\n export const I18N_GROUP_RUNNER_DESCRIPTION = s__(\n   'Runners|Available to all projects and subgroups in the group',\n );\n export const I18N_PROJECT_RUNNER_DESCRIPTION = s__('Runners|Associated with one or more projects');\n+\n+// Status\n+export const I18N_ONLINE_RUNNER_DESCRIPTION = s__(\n+  'Runners|Runner is online; last contact was %{timeAgo}',\n+);\n+export const I18N_OFFLINE_RUNNER_DESCRIPTION = s__(\n+  'Runners|No recent contact from this runner; last contact was %{timeAgo}',\n+);\n+export const I18N_NOT_CONNECTED_RUNNER_DESCRIPTION = s__(\n+  'Runners|This runner has never connected to this instance',\n+);\n+\n export const I18N_LOCKED_RUNNER_DESCRIPTION = s__('Runners|You cannot assign to other projects');\n export const I18N_PAUSED_RUNNER_DESCRIPTION = s__('Runners|Not available to run jobs');\n \n"},{"old_path":"app/assets/javascripts/runner/graphql/runner_actions_update.mutation.graphql","new_path":"app/assets/javascripts/runner/graphql/runner_actions_update.mutation.graphql","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,14 @@\n+#import \"~/runner/graphql/runner_node.fragment.graphql\"\n+\n+# Mutation for updates within the runners list via action\n+# buttons (play, pause, ...), loads attributes shown in the\n+# runner list.\n+\n+mutation runnerActionsUpdate($input: RunnerUpdateInput!) {\n+  runnerUpdate(input: $input) {\n+    runner {\n+      ...RunnerNode\n+    }\n+    errors\n+  }\n+}\n"},{"old_path":"app/assets/javascripts/runner/graphql/runner_node.fragment.graphql","new_path":"app/assets/javascripts/runner/graphql/runner_node.fragment.graphql","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -10,4 +10,5 @@ fragment RunnerNode on CiRunner {\n   locked\n   tagList\n   contactedAt\n+  status\n }\n"},{"old_path":"app/assets/javascripts/runner/graphql/runner_update.mutation.graphql","new_path":"app/assets/javascripts/runner/graphql/runner_update.mutation.graphql","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -1,5 +1,8 @@\n #import \"ee_else_ce/runner/graphql/runner_details.fragment.graphql\"\n \n+# Mutation for updates from the runner form, loads\n+# attributes shown in the runner details.\n+\n mutation runnerUpdate($input: RunnerUpdateInput!) {\n   runnerUpdate(input: $input) {\n     runner {\n"},{"old_path":"app/assets/javascripts/vue_merge_request_widget/components/added_commit_message.vue","new_path":"app/assets/javascripts/vue_merge_request_widget/components/added_commit_message.vue","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -40,9 +40,9 @@ export default {\n     },\n     message() {\n       return this.isFastForwardEnabled\n-        ? s__('mrWidgetCommitsAdded|%{commitCount} will be added to %{targetBranch}.')\n+        ? s__('mrWidgetCommitsAdded|Adds %{commitCount} to %{targetBranch}.')\n         : s__(\n-            'mrWidgetCommitsAdded|%{commitCount} and %{mergeCommitCount} will be added to %{targetBranch}%{squashedCommits}.',\n+            'mrWidgetCommitsAdded|Adds %{commitCount} and %{mergeCommitCount} to %{targetBranch}%{squashedCommits}.',\n           );\n     },\n     textDecorativeComponent() {\n@@ -69,7 +69,7 @@ export default {\n       \u003c/template\u003e\n       \u003ctemplate #squashedCommits\u003e\n         \u003ctemplate v-if=\"glFeatures.restructuredMrWidget \u0026\u0026 isSquashEnabled\"\u003e\n-          {{ __('(commits will be squashed)') }}\u003c/template\n+          {{ n__('(squashes %d commit)', '(squashes %d commits)', commitsCount) }}\u003c/template\n         \u003e\u003c/template\n       \u003e\n     \u003c/gl-sprintf\u003e\n"},{"old_path":"app/assets/javascripts/vue_merge_request_widget/components/source_branch_removal_status.vue","new_path":"app/assets/javascripts/vue_merge_request_widget/components/source_branch_removal_status.vue","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -4,7 +4,7 @@ import { __ } from '../../locale';\n \n export default {\n   i18n: {\n-    removesBranchText: __('The source branch will be deleted'),\n+    removesBranchText: __('Deletes the source branch'),\n     tooltipTitle: __('A user with write access to the source branch selected this option'),\n   },\n   components: {\n"},{"old_path":"app/assets/javascripts/vue_merge_request_widget/components/states/mr_widget_auto_merge_enabled.vue","new_path":"app/assets/javascripts/vue_merge_request_widget/components/states/mr_widget_auto_merge_enabled.vue","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -177,10 +177,10 @@ export default {\n         \u003c/h4\u003e\n         \u003csection class=\"mr-info-list\"\u003e\n           \u003cp v-if=\"shouldRemoveSourceBranch\"\u003e\n-            {{ s__('mrWidget|The source branch will be deleted') }}\n+            {{ s__('mrWidget|Deletes the source branch') }}\n           \u003c/p\u003e\n           \u003cp v-else class=\"gl-display-flex\"\u003e\n-            \u003cspan class=\"gl-mr-3\"\u003e{{ s__('mrWidget|The source branch will not be deleted') }}\u003c/span\u003e\n+            \u003cspan class=\"gl-mr-3\"\u003e{{ s__('mrWidget|Does not delete the source branch') }}\u003c/span\u003e\n             \u003cgl-button\n               v-if=\"canRemoveSourceBranch\"\n               :loading=\"isRemovingSourceBranch\"\n"},{"old_path":"app/assets/javascripts/vue_merge_request_widget/components/states/mr_widget_merging.vue","new_path":"app/assets/javascripts/vue_merge_request_widget/components/states/mr_widget_merging.vue","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -32,7 +32,7 @@ export default {\n       \u003c/h4\u003e\n       \u003csection class=\"mr-info-list\"\u003e\n         \u003cp\u003e\n-          {{ s__('mrWidget|The changes will be merged into') }}\n+          {{ s__('mrWidget|Merges changes into') }}\n           \u003cspan class=\"label-branch\"\u003e\n             \u003ca :href=\"mr.targetBranchPath\"\u003e{{ mr.targetBranch }}\u003c/a\u003e\n           \u003c/span\u003e\n"},{"old_path":"app/assets/javascripts/vue_merge_request_widget/components/states/ready_to_merge.vue","new_path":"app/assets/javascripts/vue_merge_request_widget/components/states/ready_to_merge.vue","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -710,10 +710,10 @@ export default {\n                   \u003c/li\u003e\n                   \u003cli class=\"gl-line-height-normal\"\u003e\n                     \u003ctemplate v-if=\"removeSourceBranch\"\u003e\n-                      {{ __('Source branch will be deleted.') }}\n+                      {{ __('Deletes the source branch.') }}\n                     \u003c/template\u003e\n                     \u003ctemplate v-else\u003e\n-                      {{ __('Source branch will not be deleted.') }}\n+                      {{ __('Does not delete the source branch.') }}\n                     \u003c/template\u003e\n                   \u003c/li\u003e\n                   \u003cli v-if=\"mr.relatedLinks\" class=\"gl-line-height-normal\"\u003e\n"},{"old_path":"app/assets/stylesheets/framework/files.scss","new_path":"app/assets/stylesheets/framework/files.scss","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -227,7 +227,7 @@\n       // IMPORTANT PERFORMANCE OPTIMIZATION\n       //\n       // When viewinng a blame with many commits a lot of content is rendered on the page.\n-      // Two selectors below ensure that we only render what is visible to the user, thus reducing TBT in the browser.\n+      // content-visibility rules below ensure that we only render what is visible to the user, thus reducing TBT in the browser.\n       .commit {\n         content-visibility: auto;\n         contain-intrinsic-size: 1px 3em;\n@@ -237,6 +237,10 @@\n         content-visibility: auto;\n         contain-intrinsic-size: 1px 1.1875rem;\n       }\n+\n+      .line-numbers {\n+        content-visibility: auto;\n+      }\n     }\n \n     \u0026.logs {\n"},{"old_path":"app/graphql/mutations/issues/set_crm_contacts.rb","new_path":"app/graphql/mutations/issues/set_crm_contacts.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,48 @@\n+# frozen_string_literal: true\n+\n+module Mutations\n+  module Issues\n+    class SetCrmContacts \u003c Base\n+      graphql_name 'IssueSetCrmContacts'\n+\n+      argument :crm_contact_ids,\n+               [::Types::GlobalIDType[::CustomerRelations::Contact]],\n+               required: true,\n+               description: 'Customer relations contact IDs to set. Replaces existing contacts by default.'\n+\n+      argument :operation_mode,\n+               Types::MutationOperationModeEnum,\n+               required: false,\n+               description: 'Changes the operation mode. Defaults to REPLACE.'\n+\n+      def resolve(project_path:, iid:, crm_contact_ids:, operation_mode: Types::MutationOperationModeEnum.enum[:replace])\n+        issue = authorized_find!(project_path: project_path, iid: iid)\n+        project = issue.project\n+        raise Gitlab::Graphql::Errors::ResourceNotAvailable, 'Feature disabled' unless Feature.enabled?(:customer_relations, project.group, default_enabled: :yaml)\n+\n+        crm_contact_ids = crm_contact_ids.compact.map do |crm_contact_id|\n+          raise Gitlab::Graphql::Errors::ArgumentError, \"Contact #{crm_contact_id} is invalid.\" unless crm_contact_id.respond_to?(:model_id)\n+\n+          crm_contact_id.model_id.to_i\n+        end\n+\n+        attribute_name = case operation_mode\n+                         when Types::MutationOperationModeEnum.enum[:append]\n+                           :add_crm_contact_ids\n+                         when Types::MutationOperationModeEnum.enum[:remove]\n+                           :remove_crm_contact_ids\n+                         else\n+                           :crm_contact_ids\n+                         end\n+\n+        response = ::Issues::SetCrmContactsService.new(project: project, current_user: current_user, params: { attribute_name =\u003e crm_contact_ids })\n+          .execute(issue)\n+\n+        {\n+          issue: issue,\n+          errors: response.errors\n+        }\n+      end\n+    end\n+  end\n+end\n"},{"old_path":"app/graphql/types/mutation_type.rb","new_path":"app/graphql/types/mutation_type.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -49,6 +49,7 @@ class MutationType \u003c BaseObject\n     mount_mutation Mutations::Environments::CanaryIngress::Update\n     mount_mutation Mutations::Issues::Create\n     mount_mutation Mutations::Issues::SetAssignees\n+    mount_mutation Mutations::Issues::SetCrmContacts\n     mount_mutation Mutations::Issues::SetConfidential\n     mount_mutation Mutations::Issues::SetLocked\n     mount_mutation Mutations::Issues::SetDueDate\n"},{"old_path":"app/helpers/application_settings_helper.rb","new_path":"app/helpers/application_settings_helper.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -404,6 +404,10 @@ def visible_attributes\n       :keep_latest_artifact,\n       :whats_new_variant,\n       :user_deactivation_emails_enabled,\n+      :sentry_enabled,\n+      :sentry_dsn,\n+      :sentry_clientside_dsn,\n+      :sentry_environment,\n       :sidekiq_job_limiter_mode,\n       :sidekiq_job_limiter_compression_threshold_bytes,\n       :sidekiq_job_limiter_limit_bytes,\n"},{"old_path":"app/helpers/issues_helper.rb","new_path":"app/helpers/issues_helper.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -1,6 +1,8 @@\n # frozen_string_literal: true\n \n module IssuesHelper\n+  include Issues::IssueTypeHelpers\n+\n   def issue_css_classes(issue)\n     classes = [\"issue\"]\n     classes \u003c\u003c \"closed\" if issue.closed?\n"},{"old_path":"app/models/application_setting.rb","new_path":"app/models/application_setting.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -536,6 +536,18 @@ def self.kroki_formats_attributes\n   validates :sidekiq_job_limiter_limit_bytes,\n             numericality: { only_integer: true, greater_than_or_equal_to: 0 }\n \n+  validates :sentry_enabled,\n+    inclusion: { in: [true, false], message: _('must be a boolean value') }\n+  validates :sentry_dsn,\n+    addressable_url: true, presence: true, length: { maximum: 255 },\n+    if: :sentry_enabled?\n+  validates :sentry_clientside_dsn,\n+    addressable_url: true, allow_blank: true, length: { maximum: 255 },\n+    if: :sentry_enabled?\n+  validates :sentry_environment,\n+    presence: true, length: { maximum: 255 },\n+    if: :sentry_enabled?\n+\n   attr_encrypted :asset_proxy_secret_key,\n                  mode: :per_attribute_iv,\n                  key: Settings.attr_encrypted_db_key_base_truncated,\n"},{"old_path":"app/models/concerns/alert_event_lifecycle.rb","new_path":"app/models/concerns/alert_event_lifecycle.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -41,8 +41,6 @@ module AlertEventLifecycle\n     scope :firing, -\u003e { where(status: status_value_for(:firing)) }\n     scope :resolved, -\u003e { where(status: status_value_for(:resolved)) }\n \n-    scope :count_by_project_id, -\u003e { group(:project_id).count }\n-\n     def self.status_value_for(name)\n       state_machines[:status].states[name].value\n     end\n"},{"old_path":"app/models/concerns/issuable.rb","new_path":"app/models/concerns/issuable.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -92,7 +92,6 @@ def award_emojis_loaded?\n     scope :recent, -\u003e { reorder(id: :desc) }\n     scope :of_projects, -\u003e(ids) { where(project_id: ids) }\n     scope :opened, -\u003e { with_state(:opened) }\n-    scope :only_opened, -\u003e { with_state(:opened) }\n     scope :closed, -\u003e { with_state(:closed) }\n \n     # rubocop:disable GitlabSecurity/SqlInjection\n"},{"old_path":"app/models/concerns/milestoneable.rb","new_path":"app/models/concerns/milestoneable.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -14,7 +14,6 @@ module Milestoneable\n \n     validate :milestone_is_valid\n \n-    scope :of_milestones, -\u003e(ids) { where(milestone_id: ids) }\n     scope :any_milestone, -\u003e { where.not(milestone_id: nil) }\n     scope :with_milestone, -\u003e(title) { left_joins_milestones.where(milestones: { title: title }) }\n     scope :without_particular_milestone, -\u003e(title) { left_outer_joins(:milestone).where(\"milestones.title != ? OR milestone_id IS NULL\", title) }\n"},{"old_path":"app/models/customer_relations/issue_contact.rb","new_path":"app/models/customer_relations/issue_contact.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -15,6 +15,6 @@ def contact_belongs_to_issue_group\n     return unless issue\u0026.project\u0026.namespace_id\n     return if contact.group_id == issue.project.namespace_id\n \n-    errors.add(:base, _('The contact does not belong to the same group as the issue.'))\n+    errors.add(:base, _('The contact does not belong to the same group as the issue'))\n   end\n end\n"},{"old_path":"app/models/group.rb","new_path":"app/models/group.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -194,13 +194,8 @@ def preset_root_ancestor_for(groups)\n     def ids_with_disabled_email(groups)\n       inner_groups = Group.where('id = namespaces_with_emails_disabled.id')\n \n-      inner_ancestors = if Feature.enabled?(:linear_group_ancestor_scopes, default_enabled: :yaml)\n-                          inner_groups.self_and_ancestors\n-                        else\n-                          Gitlab::ObjectHierarchy.new(inner_groups).base_and_ancestors\n-                        end\n-\n-      inner_query = inner_ancestors\n+      inner_query = inner_groups\n+        .self_and_ancestors\n         .where(emails_disabled: true)\n         .select('1')\n         .limit(1)\n"},{"old_path":"app/policies/issue_policy.rb","new_path":"app/policies/issue_policy.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -12,6 +12,9 @@ class IssuePolicy \u003c IssuablePolicy\n     @user \u0026\u0026 IssueCollection.new([@subject]).visible_to(@user).any?\n   end\n \n+  desc \"User can read contacts belonging to the issue group\"\n+  condition(:can_read_crm_contacts, scope: :subject) { @user.can?(:read_crm_contact, @subject.project.group) }\n+\n   desc \"Issue is confidential\"\n   condition(:confidential, scope: :subject) { @subject.confidential? }\n \n@@ -77,6 +80,10 @@ class IssuePolicy \u003c IssuablePolicy\n   rule { ~persisted \u0026 can?(:create_issue) }.policy do\n     enable :set_confidentiality\n   end\n+\n+  rule { can?(:set_issue_metadata) \u0026 can_read_crm_contacts }.policy do\n+    enable :set_issue_crm_contacts\n+  end\n end\n \n IssuePolicy.prepend_mod_with('IssuePolicy')\n"},{"old_path":"app/services/authorized_project_update/project_access_changed_service.rb","new_path":"app/services/authorized_project_update/project_access_changed_service.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,19 @@\n+# frozen_string_literal: true\n+\n+module AuthorizedProjectUpdate\n+  class ProjectAccessChangedService\n+    def initialize(project_ids)\n+      @project_ids = Array.wrap(project_ids)\n+    end\n+\n+    def execute(blocking: true)\n+      bulk_args = @project_ids.map { |id| [id] }\n+\n+      if blocking\n+        AuthorizedProjectUpdate::ProjectRecalculateWorker.bulk_perform_and_wait(bulk_args)\n+      else\n+        AuthorizedProjectUpdate::ProjectRecalculateWorker.bulk_perform_async(bulk_args) # rubocop:disable Scalability/BulkPerformWithContext\n+      end\n+    end\n+  end\n+end\n"},{"old_path":"app/services/concerns/issues/issue_type_helpers.rb","new_path":"app/services/concerns/issues/issue_type_helpers.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,12 @@\n+# frozen_string_literal: true\n+\n+module Issues\n+  module IssueTypeHelpers\n+    # @param object [Issue, Project]\n+    # @param issue_type [String, Symbol]\n+    def create_issue_type_allowed?(object, issue_type)\n+      WorkItem::Type.base_types.key?(issue_type.to_s) \u0026\u0026\n+        can?(current_user, :\"create_#{issue_type}\", object)\n+    end\n+  end\n+end\n"},{"old_path":"app/services/groups/transfer_service.rb","new_path":"app/services/groups/transfer_service.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -175,21 +175,18 @@ def ensure_ownership\n     end\n \n     def refresh_project_authorizations\n-      ProjectAuthorization.where(project_id: @group.all_projects.select(:id)).delete_all # rubocop: disable CodeReuse/ActiveRecord\n+      projects_to_update = Set.new\n \n-      # refresh authorized projects for current_user immediately\n-      current_user.refresh_authorized_projects\n-\n-      # schedule refreshing projects for all the members of the group\n-      @group.refresh_members_authorized_projects\n+      # All projects in this hierarchy need to have their project authorizations recalculated\n+      @group.all_projects.each_batch { |prjs| projects_to_update.merge(prjs.ids) } # rubocop: disable CodeReuse/ActiveRecord\n \n       # When a group is transferred, it also affects who gets access to the projects shared to\n       # the subgroups within its hierarchy, so we also schedule jobs that refresh authorizations for all such shared projects.\n-      project_group_shares_within_the_hierarchy = ProjectGroupLink.in_group(group.self_and_descendants.select(:id))\n-\n-      project_group_shares_within_the_hierarchy.find_each do |project_group_link|\n-        AuthorizedProjectUpdate::ProjectRecalculateWorker.perform_async(project_group_link.project_id)\n+      ProjectGroupLink.in_group(@group.self_and_descendants.select(:id)).each_batch do |project_group_links|\n+        projects_to_update.merge(project_group_links.pluck(:project_id)) # rubocop: disable CodeReuse/ActiveRecord\n       end\n+\n+      AuthorizedProjectUpdate::ProjectAccessChangedService.new(projects_to_update.to_a).execute unless projects_to_update.empty?\n     end\n \n     def raise_transfer_error(message)\n"},{"old_path":"app/services/issues/base_service.rb","new_path":"app/services/issues/base_service.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -3,6 +3,7 @@\n module Issues\n   class BaseService \u003c ::IssuableBaseService\n     include IncidentManagement::UsageData\n+    include IssueTypeHelpers\n \n     def hook_data(issue, action, old_associations: {})\n       hook_data = issue.to_hook_data(current_user, old_associations: old_associations)\n@@ -44,7 +45,7 @@ def find_work_item_type_id(issue_type)\n     def filter_params(issue)\n       super\n \n-      params.delete(:issue_type) unless issue_type_allowed?(issue)\n+      params.delete(:issue_type) unless create_issue_type_allowed?(issue, params[:issue_type])\n       filter_incident_label(issue) if params[:issue_type]\n \n       moved_issue = params.delete(:moved_issue)\n@@ -89,12 +90,6 @@ def delete_milestone_total_issue_counter_cache(milestone)\n       Milestones::IssuesCountService.new(milestone).delete_cache\n     end\n \n-    # @param object [Issue, Project]\n-    def issue_type_allowed?(object)\n-      WorkItem::Type.base_types.key?(params[:issue_type]) \u0026\u0026\n-        can?(current_user, :\"create_#{params[:issue_type]}\", object)\n-    end\n-\n     # @param issue [Issue]\n     def filter_incident_label(issue)\n       return unless add_incident_label?(issue) || remove_incident_label?(issue)\n"},{"old_path":"app/services/issues/build_service.rb","new_path":"app/services/issues/build_service.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -80,7 +80,7 @@ def allowed_issue_params\n       ]\n \n       allowed_params \u003c\u003c :milestone_id if can?(current_user, :admin_issue, project)\n-      allowed_params \u003c\u003c :issue_type if issue_type_allowed?(project)\n+      allowed_params \u003c\u003c :issue_type if create_issue_type_allowed?(project, params[:issue_type])\n \n       params.slice(*allowed_params)\n     end\n"},{"old_path":"app/services/issues/set_crm_contacts_service.rb","new_path":"app/services/issues/set_crm_contacts_service.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,90 @@\n+# frozen_string_literal: true\n+\n+module Issues\n+  class SetCrmContactsService \u003c ::BaseProjectService\n+    attr_accessor :issue, :errors\n+\n+    MAX_ADDITIONAL_CONTACTS = 6\n+\n+    def execute(issue)\n+      @issue = issue\n+      @errors = []\n+\n+      return error_no_permissions unless allowed?\n+      return error_invalid_params unless valid_params?\n+\n+      determine_changes if params[:crm_contact_ids]\n+\n+      return error_too_many if too_many?\n+\n+      add_contacts if params[:add_crm_contact_ids]\n+      remove_contacts if params[:remove_crm_contact_ids]\n+\n+      if issue.valid?\n+        ServiceResponse.success(payload: issue)\n+      else\n+        # The default error isn't very helpful: \"Issue customer relations contacts is invalid\"\n+        issue.errors.delete(:issue_customer_relations_contacts)\n+        issue.errors.add(:issue_customer_relations_contacts, errors.to_sentence)\n+        ServiceResponse.error(payload: issue, message: issue.errors.full_messages)\n+      end\n+    end\n+\n+    private\n+\n+    def determine_changes\n+      existing_contact_ids = issue.issue_customer_relations_contacts.map(\u0026:contact_id)\n+      params[:add_crm_contact_ids] = params[:crm_contact_ids] - existing_contact_ids\n+      params[:remove_crm_contact_ids] = existing_contact_ids - params[:crm_contact_ids]\n+    end\n+\n+    def add_contacts\n+      params[:add_crm_contact_ids].uniq.each do |contact_id|\n+        issue_contact = issue.issue_customer_relations_contacts.create(contact_id: contact_id)\n+\n+        unless issue_contact.persisted?\n+          # The validation ensures that the id exists and the user has permission\n+          errors \u003c\u003c \"#{contact_id}: The resource that you are attempting to access does not exist or you don't have permission to perform this action\"\n+        end\n+      end\n+    end\n+\n+    def remove_contacts\n+      issue.issue_customer_relations_contacts\n+        .where(contact_id: params[:remove_crm_contact_ids]) # rubocop: disable CodeReuse/ActiveRecord\n+        .delete_all\n+    end\n+\n+    def allowed?\n+      current_user\u0026.can?(:set_issue_crm_contacts, issue)\n+    end\n+\n+    def valid_params?\n+      set_present? ^ add_or_remove_present?\n+    end\n+\n+    def set_present?\n+      params[:crm_contact_ids].present?\n+    end\n+\n+    def add_or_remove_present?\n+      params[:add_crm_contact_ids].present? || params[:remove_crm_contact_ids].present?\n+    end\n+\n+    def too_many?\n+      params[:add_crm_contact_ids] \u0026\u0026 params[:add_crm_contact_ids].length \u003e MAX_ADDITIONAL_CONTACTS\n+    end\n+\n+    def error_no_permissions\n+      ServiceResponse.error(message: ['You have insufficient permissions to set customer relations contacts for this issue'])\n+    end\n+\n+    def error_invalid_params\n+      ServiceResponse.error(message: ['You cannot combine crm_contact_ids with add_crm_contact_ids or remove_crm_contact_ids'])\n+    end\n+\n+    def error_too_many\n+      ServiceResponse.error(payload: issue, message: [\"You can only add up to #{MAX_ADDITIONAL_CONTACTS} contacts at one time\"])\n+    end\n+  end\n+end\n"},{"old_path":"app/services/projects/container_repository/cleanup_tags_service.rb","new_path":"app/services/projects/container_repository/cleanup_tags_service.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -146,8 +146,7 @@ def cache\n \n       def caching_enabled?\n         container_expiration_policy \u0026\u0026\n-          older_than.present? \u0026\u0026\n-          Feature.enabled?(:container_registry_expiration_policies_caching, @project)\n+          older_than.present?\n       end\n \n       def throttling_enabled?\n"},{"old_path":"app/views/admin/application_settings/_sentry.html.haml","new_path":"app/views/admin/application_settings/_sentry.html.haml","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,22 @@\n+= form_for @application_setting, url: metrics_and_profiling_admin_application_settings_path(anchor: 'js-sentry-settings'), html: { class: 'fieldset-form', id: 'sentry-settings' } do |f|\n+  = form_errors(@application_setting)\n+\n+  %span.text-muted\n+    = _('Changing any setting here requires an application restart')\n+\n+  %fieldset\n+    .form-group\n+      .form-check\n+        = f.check_box :sentry_enabled, class: 'form-check-input'\n+        = f.label :sentry_enabled, _('Enable Sentry error tracking'), class: 'form-check-label'\n+    .form-group\n+      = f.label :sentry_dsn, _('DSN'), class: 'label-light'\n+      = f.text_field :sentry_dsn, class: 'form-control gl-form-input', placeholder: 'https://public@sentry.example.com/1'\n+    .form-group\n+      = f.label :sentry_clientside_dsn, _('Clientside DSN'), class: 'label-light'\n+      = f.text_field :sentry_clientside_dsn, class: 'form-control gl-form-input', placeholder: 'https://public@sentry.example.com/2'\n+    .form-group\n+      = f.label :sentry_environment, _('Environment'), class: 'label-light'\n+      = f.text_field :sentry_environment, class: 'form-control gl-form-input', placeholder: Rails.env\n+\n+  = f.submit _('Save changes'), class: 'gl-button btn btn-confirm'\n"},{"old_path":"app/views/admin/application_settings/metrics_and_profiling.html.haml","new_path":"app/views/admin/application_settings/metrics_and_profiling.html.haml","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -54,3 +54,15 @@\n     = render 'usage'\n \n = render_if_exists 'admin/application_settings/pseudonymizer_settings', expanded: expanded_by_default?\n+\n+- if Feature.enabled?(:configure_sentry_in_application_settings, default_enabled: :yaml)\n+  %section.settings.as-sentry.no-animate#js-sentry-settings{ class: ('expanded' if expanded_by_default?), data: { qa_selector: 'sentry_settings_content' } }\n+    .settings-header\n+      %h4\n+        = _('Sentry')\n+      %button.btn.gl-button.btn-default.js-settings-toggle{ type: 'button' }\n+        = expanded_by_default? ? _('Collapse') : _('Expand')\n+      %p\n+        = _('Configure Sentry integration for error tracking')\n+    .settings-content\n+      = render 'sentry'\n"},{"old_path":"app/views/admin/dev_ops_report/_report.html.haml","new_path":"app/views/admin/dev_ops_report/_score.html.haml","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":true,"deleted_file":false,"diff":""},{"old_path":"app/views/admin/dev_ops_report/show.html.haml","new_path":"app/views/admin/dev_ops_report/show.html.haml","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -6,5 +6,5 @@\n     - if show_adoption?\n       = render_if_exists 'admin/dev_ops_report/devops_tabs'\n     - else\n-      = render 'report'\n+      = render 'score'\n \n"},{"old_path":"app/views/projects/product_analytics/_links.html.haml","new_path":"app/views/projects/product_analytics/_links.html.haml","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -1,10 +1,5 @@\n-.mb-3\n-  %ul.nav-links\n-    = nav_link(path: 'product_analytics#index') do\n-      = link_to _('Events'), project_product_analytics_path(@project)\n-    = nav_link(path: 'product_analytics#graphs') do\n-      = link_to 'Graphs', graphs_project_product_analytics_path(@project)\n-    = nav_link(path: 'product_analytics#test') do\n-      = link_to _('Test'), test_project_product_analytics_path(@project)\n-    = nav_link(path: 'product_analytics#setup') do\n-      = link_to _('Setup'), setup_project_product_analytics_path(@project)\n+= gl_tabs_nav({ class: 'mb-3'}) do\n+  = gl_tab_link_to _('Events'), project_product_analytics_path(@project)\n+  = gl_tab_link_to _('Graphs'), graphs_project_product_analytics_path(@project)\n+  = gl_tab_link_to _('Test'), test_project_product_analytics_path(@project)\n+  = gl_tab_link_to _('Setup'), setup_project_product_analytics_path(@project)\n"},{"old_path":"app/views/shared/issuable/form/_type_selector.html.haml","new_path":"app/views/shared/issuable/form/_type_selector.html.haml","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -18,17 +18,19 @@\n                 = sprite_icon('close', size: 16, css_class: 'dropdown-menu-close-icon')\n             .dropdown-content{ data: { testid: 'issue-type-select-dropdown' } }\n               %ul\n-                %li.js-filter-issuable-type\n-                  = link_to new_project_issue_path(@project), class: (\"is-active\" if issuable.issue?) do\n-                    #{sprite_icon(work_item_type_icon(:issue), css_class: 'gl-icon')} #{_(\"Issue\")}\n-                %li.js-filter-issuable-type{ data: { track: { action: \"select_issue_type_incident\", label: \"select_issue_type_incident_dropdown_option\" } } }\n-                  = link_to new_project_issue_path(@project, { issuable_template: 'incident', issue: { issue_type: 'incident' } }), class: (\"is-active\" if issuable.incident?) do\n-                    #{sprite_icon(work_item_type_icon(:incident), css_class: 'gl-icon')} #{_(\"Incident\")}\n+                - if create_issue_type_allowed?(@project, :issue)\n+                  %li.js-filter-issuable-type\n+                    = link_to new_project_issue_path(@project), class: (\"is-active\" if issuable.issue?) do\n+                      #{sprite_icon(work_item_type_icon(:issue), css_class: 'gl-icon')} #{_('Issue')}\n+                - if create_issue_type_allowed?(@project, :incident)\n+                  %li.js-filter-issuable-type{ data: { track: { action: \"select_issue_type_incident\", label: \"select_issue_type_incident_dropdown_option\" } } }\n+                    = link_to new_project_issue_path(@project, { issuable_template: 'incident', issue: { issue_type: 'incident' } }), class: (\"is-active\" if issuable.incident?) do\n+                      #{sprite_icon(work_item_type_icon(:incident), css_class: 'gl-icon')} #{_('Incident')}\n \n       #js-type-popover\n \n     - if issuable.incident?\n       %p.form-text.text-muted\n         - incident_docs_url = help_page_path('operations/incident_management/incidents.md')\n-        - incident_docs_start = '\u003ca href=\"%{url}\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e'.html_safe % { url: incident_docs_url }\n-        = _('A %{incident_docs_start}modified issue%{incident_docs_end} to guide the resolution of incidents.').html_safe % { incident_docs_start: incident_docs_start, incident_docs_end: '\u003c/a\u003e'.html_safe }\n+        - incident_docs_start = format('\u003ca href=\"%{url}\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e', url: incident_docs_url)\n+        = format(_('A %{incident_docs_start}modified issue%{incident_docs_end} to guide the resolution of incidents.'), incident_docs_start: incident_docs_start, incident_docs_end: '\u003c/a\u003e').html_safe\n"},{"old_path":"app/workers/authorized_project_update/project_recalculate_worker.rb","new_path":"app/workers/authorized_project_update/project_recalculate_worker.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -7,6 +7,8 @@ class ProjectRecalculateWorker\n     data_consistency :always\n     include Gitlab::ExclusiveLeaseHelpers\n \n+    prepend WaitableWorker\n+\n     feature_category :authentication_and_authorization\n     urgency :high\n     queue_namespace :authorized_project_update\n"},{"old_path":"app/workers/container_expiration_policies/cleanup_container_repository_worker.rb","new_path":"app/workers/container_expiration_policies/cleanup_container_repository_worker.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -159,7 +159,10 @@ def log_cache_ratio(result)\n \n       return unless tags_count \u0026\u0026 cached_tags_count \u0026\u0026 tags_count != 0\n \n-      log_extra_metadata_on_done(:cleanup_tags_service_cache_hit_ratio, cached_tags_count / tags_count.to_f)\n+      ratio = cached_tags_count / tags_count.to_f\n+      ratio_as_percentage = (ratio * 100).round(2)\n+\n+      log_extra_metadata_on_done(:cleanup_tags_service_cache_hit_ratio, ratio_as_percentage)\n     end\n \n     def log_truncate(result)\n"},{"old_path":"bin/sidekiq-cluster","new_path":"bin/sidekiq-cluster","a_mode":"100755","b_mode":"100755","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -1,13 +1,7 @@\n #!/usr/bin/env ruby\n # frozen_string_literal: true\n \n-require 'optparse'\n-require_relative '../lib/gitlab'\n-require_relative '../lib/gitlab/utils'\n-require_relative '../lib/gitlab/sidekiq_config/cli_methods'\n-require_relative '../lib/gitlab/sidekiq_config/worker_matcher'\n-require_relative '../lib/gitlab/sidekiq_cluster'\n-require_relative '../lib/gitlab/sidekiq_cluster/cli'\n+require_relative '../sidekiq_cluster/cli'\n \n Thread.abort_on_exception = true\n \n"},{"old_path":"config/application.rb","new_path":"config/application.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -16,6 +16,8 @@\n \n module Gitlab\n   class Application \u003c Rails::Application\n+    config.load_defaults 6.1\n+\n     require_dependency Rails.root.join('lib/gitlab')\n     require_dependency Rails.root.join('lib/gitlab/utils')\n     require_dependency Rails.root.join('lib/gitlab/action_cable/config')\n@@ -37,8 +39,6 @@ class Application \u003c Rails::Application\n     require_dependency Rails.root.join('lib/gitlab/runtime')\n     require_dependency Rails.root.join('lib/gitlab/patch/legacy_database_config')\n \n-    config.autoloader = :zeitwerk\n-\n     # To be removed in 15.0\n     # This preload is needed to convert legacy `database.yml`\n     # from `production: adapter: postgresql`\n@@ -190,11 +190,12 @@ class Application \u003c Rails::Application\n     # regardless if schema_search_path is set, or not.\n     config.active_record.dump_schemas = :all\n \n-    # Use new connection handling so that we can use Rails 6.1+ multiple\n-    # database support.\n-    config.active_record.legacy_connection_handling = false\n-\n-    config.action_mailer.delivery_job = \"ActionMailer::MailDeliveryJob\"\n+    # Override default Active Record settings\n+    # We cannot do this in an initializer because some models are already loaded by then\n+    config.active_record.cache_versioning = false\n+    config.active_record.collection_cache_versioning = false\n+    config.active_record.has_many_inversing = false\n+    config.active_record.belongs_to_required_by_default = false\n \n     # Enable the asset pipeline\n     config.assets.enabled = true\n@@ -380,6 +381,7 @@ class Application \u003c Rails::Application\n     config.cache_store = :redis_cache_store, Gitlab::Redis::Cache.active_support_config\n \n     config.active_job.queue_adapter = :sidekiq\n+    config.action_mailer.deliver_later_queue_name = :mailers\n \n     # This is needed for gitlab-shell\n     ENV['GITLAB_PATH_OUTSIDE_HOOK'] = ENV['PATH']\n"},{"old_path":"config/feature_flags/development/linear_group_ancestor_scopes.yml","new_path":"config/feature_flags/development/api_v3_commits_skip_diff_files.yml","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":true,"deleted_file":false,"diff":"@@ -1,8 +1,8 @@\n ---\n-name: linear_group_ancestor_scopes\n-introduced_by_url: https://gitlab.com/gitlab-org/gitlab/-/merge_requests/70495\n-rollout_issue_url: https://gitlab.com/gitlab-org/gitlab/-/issues/341115\n-milestone: '14.4'\n+name: api_v3_commits_skip_diff_files\n+introduced_by_url: https://gitlab.com/gitlab-org/gitlab/-/merge_requests/67647\n+rollout_issue_url: https://gitlab.com/gitlab-org/gitlab/-/issues/344617\n+milestone: '14.5'\n type: development\n-group: group::access\n+group: group::integrations\n default_enabled: false\n"},{"old_path":"config/feature_flags/development/ci_new_artifact_file_reader.yml","new_path":"config/feature_flags/development/configure_sentry_in_application_settings.yml","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":true,"deleted_file":false,"diff":"@@ -1,8 +1,8 @@\n ---\n-name: ci_new_artifact_file_reader\n-introduced_by_url: https://gitlab.com/gitlab-org/gitlab/-/merge_requests/46552\n-rollout_issue_url: https://gitlab.com/gitlab-org/gitlab/-/issues/273755\n-milestone: '13.6'\n+name: configure_sentry_in_application_settings\n+introduced_by_url: https://gitlab.com/gitlab-org/gitlab/-/merge_requests/73381\n+rollout_issue_url: https://gitlab.com/gitlab-org/gitlab/-/issues/344832\n+milestone: '14.5'\n type: development\n-group: group::pipeline authoring\n-default_enabled: true\n+group: group::pipeline execution\n+default_enabled: false\n"},{"old_path":"config/feature_flags/development/container_registry_expiration_policies_caching.yml","new_path":"config/feature_flags/development/container_registry_expiration_policies_caching.yml","a_mode":"100644","b_mode":"0","new_file":false,"renamed_file":false,"deleted_file":true,"diff":"@@ -1,8 +0,0 @@\n----\n-name: container_registry_expiration_policies_caching\n-introduced_by_url:\n-rollout_issue_url: https://gitlab.com/gitlab-org/gitlab/-/issues/340606\n-milestone: '14.3'\n-type: development\n-group: group::package\n-default_enabled: false\n"},{"old_path":"config/initializers/0_acts_as_taggable.rb","new_path":"config/initializers/1_acts_as_taggable.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":true,"deleted_file":false,"diff":"@@ -9,3 +9,9 @@\n # validate that counter cache is disabled\n raise \"Counter cache is not disabled\" if\n     ActsAsTaggableOn::Tagging.reflections[\"tag\"].options[:counter_cache]\n+\n+# Redirects retrieve_connection to use Ci::ApplicationRecord's connection\n+[::ActsAsTaggableOn::Tag, ::ActsAsTaggableOn::Tagging].each do |model|\n+  model.connection_specification_name = Ci::ApplicationRecord.connection_specification_name\n+  model.singleton_class.delegate :connection, :sticking, to: '::Ci::ApplicationRecord'\n+end\n"},{"old_path":"config/initializers/action_view.rb","new_path":"config/initializers/action_view.rb","a_mode":"100644","b_mode":"0","new_file":false,"renamed_file":false,"deleted_file":true,"diff":"@@ -1,7 +0,0 @@\n-# frozen_string_literal: true\n-\n-# This file was introduced during upgrading Rails from 5.2 to 6.0.\n-# This file can be removed when `config.load_defaults 6.0` is introduced.\n-\n-# Don't force requests from old versions of IE to be UTF-8 encoded.\n-Rails.application.config.action_view.default_enforce_utf8 = false\n"},{"old_path":"config/initializers/cookies_serializer.rb","new_path":"config/initializers/cookies_serializer.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -2,6 +2,5 @@\n \n # Be sure to restart your server when you modify this file.\n \n-Rails.application.config.action_dispatch.use_cookies_with_metadata = true\n Rails.application.config.action_dispatch.cookies_serializer =\n   Gitlab::Utils.to_boolean(ENV['USE_UNSAFE_HYBRID_COOKIES']) ? :hybrid : :json\n"},{"old_path":"config/initializers/database_query_analyzers.rb","new_path":"config/initializers/database_query_analyzers.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,4 @@\n+# frozen_string_literal: true\n+\n+# Currently we register validator only for `dev` or `test` environment\n+Gitlab::Database::QueryAnalyzer.new.hook! if Gitlab.dev_or_test_env?\n"},{"old_path":"config/initializers/new_framework_defaults.rb","new_path":"config/initializers/new_framework_defaults.rb","a_mode":"100644","b_mode":"0","new_file":false,"renamed_file":false,"deleted_file":true,"diff":"@@ -1,24 +0,0 @@\n-# frozen_string_literal: true\n-\n-# Remove this `if` condition when upgraded to rails 5.0.\n-# The body must be kept.\n-# Be sure to restart your server when you modify this file.\n-#\n-# This file contains migration options to ease your Rails 5.0 upgrade.\n-#\n-# Once upgraded flip defaults one by one to migrate to the new default.\n-#\n-# Read the Guide for Upgrading Ruby on Rails for more info on each option.\n-\n-# Enable per-form CSRF tokens. Previous versions had false.\n-Rails.application.config.action_controller.per_form_csrf_tokens = false\n-\n-# Enable origin-checking CSRF mitigation. Previous versions had false.\n-Rails.application.config.action_controller.forgery_protection_origin_check = false\n-\n-# Make Ruby 2.4 preserve the timezone of the receiver when calling `to_time`.\n-# Previous versions had false.\n-ActiveSupport.to_time_preserves_timezone = false\n-\n-# Require `belongs_to` associations by default. Previous versions had false.\n-Rails.application.config.active_record.belongs_to_required_by_default = false\n"},{"old_path":"config/initializers_before_autoloader/000_override_framework_defaults.rb","new_path":"config/initializers_before_autoloader/000_override_framework_defaults.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,35 @@\n+# frozen_string_literal: true\n+\n+# This contains configuration from Rails upgrades to override the new defaults so that we\n+# keep existing behavior.\n+#\n+# For boolean values, the new default is the opposite of the value being set in this file.\n+# For other types, the new default is noted in the comments. These are also documented in\n+# https://guides.rubyonrails.org/configuring.html#results-of-config-load-defaults\n+#\n+# To switch a setting to the new default value, we just need to delete the specific line here.\n+\n+Rails.application.configure do\n+  # Rails 6.1\n+  config.action_dispatch.cookies_same_site_protection = nil # New default is :lax\n+  config.action_dispatch.ssl_default_redirect_status = nil # New default is 308\n+  ActiveSupport.utc_to_local_returns_utc_offset_times = false\n+  config.action_controller.urlsafe_csrf_tokens = false\n+  config.action_view.preload_links_header = false\n+\n+  # Rails 5.2\n+  config.action_dispatch.use_authenticated_cookie_encryption = false\n+  config.active_support.use_authenticated_message_encryption = false\n+  config.active_support.hash_digest_class = ::Digest::MD5 # New default is ::Digest::SHA1\n+  config.action_controller.default_protect_from_forgery = false\n+  config.action_view.form_with_generates_ids = false\n+\n+  # Rails 5.1\n+  config.assets.unknown_asset_fallback = true\n+\n+  # Rails 5.0\n+  config.action_controller.per_form_csrf_tokens = false\n+  config.action_controller.forgery_protection_origin_check = false\n+  ActiveSupport.to_time_preserves_timezone = false\n+  config.ssl_options = {} # New default is { hsts: { subdomains: true } }\n+end\n"},{"old_path":"config/plugins/graphql_known_operations_plugin.js","new_path":"config/plugins/graphql_known_operations_plugin.js","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,112 @@\n+/* eslint-disable no-underscore-dangle */\n+const yaml = require('js-yaml');\n+\n+const PLUGIN_NAME = 'GraphqlKnownOperationsPlugin';\n+const GRAPHQL_PATH_REGEX = /(query|mutation)\\.graphql$/;\n+const OPERATION_NAME_SOURCE_REGEX = /^\\s*module\\.exports.*oneQuery.*\"(\\w+)\"/gm;\n+\n+/**\n+ * Returns whether a given webpack module is a \"graphql\" module\n+ */\n+const isGraphqlModule = (module) =\u003e {\n+  return GRAPHQL_PATH_REGEX.test(module.resource);\n+};\n+\n+/**\n+ * Returns graphql operation names we can parse from the given module\n+ *\n+ * Since webpack gives us the source **after** the graphql-tag/loader runs,\n+ * we can look for specific lines we're guaranteed to have from the\n+ * graphql-tag/loader.\n+ */\n+const getOperationNames = (module) =\u003e {\n+  const originalSource = module.originalSource();\n+\n+  if (!originalSource) {\n+    return [];\n+  }\n+\n+  const matches = originalSource.source().toString().matchAll(OPERATION_NAME_SOURCE_REGEX);\n+\n+  return Array.from(matches).map((match) =\u003e match[1]);\n+};\n+\n+const createFileContents = (knownOperations) =\u003e {\n+  const sourceData = Array.from(knownOperations.values()).sort((a, b) =\u003e a.localeCompare(b));\n+\n+  return yaml.dump(sourceData);\n+};\n+\n+/**\n+ * Creates a webpack4 compatible \"RawSource\"\n+ *\n+ * Inspired from https://sourcegraph.com/github.com/FormidableLabs/webpack-stats-plugin@e050ff8c362d5ddd45c66ade724d4a397ace3e5c/-/blob/lib/stats-writer-plugin.js?L144\n+ */\n+const createWebpackRawSource = (source) =\u003e {\n+  const buff = Buffer.from(source, 'utf-8');\n+\n+  return {\n+    source() {\n+      return buff;\n+    },\n+    size() {\n+      return buff.length;\n+    },\n+  };\n+};\n+\n+const onSucceedModule = ({ module, knownOperations }) =\u003e {\n+  if (!isGraphqlModule(module)) {\n+    return;\n+  }\n+\n+  getOperationNames(module).forEach((x) =\u003e knownOperations.add(x));\n+};\n+\n+const onCompilerEmit = ({ compilation, knownOperations, filename }) =\u003e {\n+  const contents = createFileContents(knownOperations);\n+  const source = createWebpackRawSource(contents);\n+\n+  const asset = compilation.getAsset(filename);\n+  if (asset) {\n+    compilation.updateAsset(filename, source);\n+  } else {\n+    compilation.emitAsset(filename, source);\n+  }\n+};\n+\n+/**\n+ * Webpack plugin that outputs a file containing known graphql operations.\n+ *\n+ * A lot of the mechanices was expired from [this example][1].\n+ *\n+ * [1]: https://sourcegraph.com/github.com/FormidableLabs/webpack-stats-plugin@e050ff8c362d5ddd45c66ade724d4a397ace3e5c/-/blob/lib/stats-writer-plugin.js?L136\n+ */\n+class GraphqlKnownOperationsPlugin {\n+  constructor({ filename }) {\n+    this._filename = filename;\n+  }\n+\n+  apply(compiler) {\n+    const knownOperations = new Set();\n+\n+    compiler.hooks.emit.tap(PLUGIN_NAME, (compilation) =\u003e {\n+      onCompilerEmit({\n+        compilation,\n+        knownOperations,\n+        filename: this._filename,\n+      });\n+    });\n+\n+    compiler.hooks.compilation.tap(PLUGIN_NAME, (compilation) =\u003e {\n+      compilation.hooks.succeedModule.tap(PLUGIN_NAME, (module) =\u003e {\n+        onSucceedModule({\n+          module,\n+          knownOperations,\n+        });\n+      });\n+    });\n+  }\n+}\n+\n+module.exports = GraphqlKnownOperationsPlugin;\n"},{"old_path":"config/webpack.config.js","new_path":"config/webpack.config.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -24,6 +24,7 @@ const IS_JH = require('./helpers/is_jh_env');\n const vendorDllHash = require('./helpers/vendor_dll_hash');\n \n const MonacoWebpackPlugin = require('./plugins/monaco_webpack');\n+const GraphqlKnownOperationsPlugin = require('./plugins/graphql_known_operations_plugin');\n \n const ROOT_PATH = path.resolve(__dirname, '..');\n const SUPPORTED_BROWSERS = fs.readFileSync(path.join(ROOT_PATH, '.browserslistrc'), 'utf-8');\n@@ -456,6 +457,8 @@ module.exports = {\n       globalAPI: true,\n     }),\n \n+    new GraphqlKnownOperationsPlugin({ filename: 'graphql_known_operations.yml' }),\n+\n     // fix legacy jQuery plugins which depend on globals\n     new webpack.ProvidePlugin({\n       $: 'jquery',\n"},{"old_path":"db/migrate/20211021125908_add_sentry_settings_to_application_settings.rb","new_path":"db/migrate/20211021125908_add_sentry_settings_to_application_settings.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,12 @@\n+# frozen_string_literal: true\n+\n+class AddSentrySettingsToApplicationSettings \u003c Gitlab::Database::Migration[1.0]\n+  # rubocop:disable Migration/AddLimitToTextColumns\n+  def change\n+    add_column :application_settings, :sentry_enabled, :boolean, default: false, null: false\n+    add_column :application_settings, :sentry_dsn,            :text\n+    add_column :application_settings, :sentry_clientside_dsn, :text\n+    add_column :application_settings, :sentry_environment,    :text\n+  end\n+  # rubocop:enable Migration/AddLimitToTextColumns\n+end\n"},{"old_path":"db/migrate/20211021134458_add_limits_to_sentry_settings_on_application_settings.rb","new_path":"db/migrate/20211021134458_add_limits_to_sentry_settings_on_application_settings.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,17 @@\n+# frozen_string_literal: true\n+\n+class AddLimitsToSentrySettingsOnApplicationSettings \u003c Gitlab::Database::Migration[1.0]\n+  disable_ddl_transaction!\n+\n+  def up\n+    add_text_limit :application_settings, :sentry_dsn,            255\n+    add_text_limit :application_settings, :sentry_clientside_dsn, 255\n+    add_text_limit :application_settings, :sentry_environment,    255\n+  end\n+\n+  def down\n+    remove_text_limit :application_settings, :sentry_dsn\n+    remove_text_limit :application_settings, :sentry_clientside_dsn\n+    remove_text_limit :application_settings, :sentry_environment\n+  end\n+end\n"},{"old_path":"db/post_migrate/20211005194425_schedule_requirements_migration.rb","new_path":"db/post_migrate/20211005194425_schedule_requirements_migration.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,35 @@\n+# frozen_string_literal: true\n+\n+class ScheduleRequirementsMigration \u003c Gitlab::Database::Migration[1.0]\n+  DOWNTIME = false\n+\n+  # 2021-10-05 requirements count: ~12500\n+  #\n+  # Using 30 as batch size and 120 seconds default interval will produce:\n+  # ~420 jobs - taking ~14 hours to perform\n+  BATCH_SIZE = 30\n+\n+  MIGRATION = 'MigrateRequirementsToWorkItems'\n+\n+  disable_ddl_transaction!\n+\n+  class Requirement \u003c ActiveRecord::Base\n+    include EachBatch\n+\n+    self.table_name = 'requirements'\n+  end\n+\n+  def up\n+    queue_background_migration_jobs_by_range_at_intervals(\n+      Requirement.where(issue_id: nil),\n+      MIGRATION,\n+      2.minutes,\n+      batch_size: BATCH_SIZE,\n+      track_jobs: true\n+    )\n+  end\n+\n+  def down\n+    # NO OP\n+  end\n+end\n"},{"old_path":"db/schema_migrations/20211005194425","new_path":"db/schema_migrations/20211005194425","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1 @@\n+6647e94d315c76629f9726e26bafd124fb2fed361568d65315e7c7557f8d9ecf\n\\ No newline at end of file\n"},{"old_path":"db/schema_migrations/20211021125908","new_path":"db/schema_migrations/20211021125908","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1 @@\n+d6fbe3efc3e45b750d82e277e30b7b0048b960d9f9f5b4f7c6a7a1ed869e76b5\n\\ No newline at end of file\n"},{"old_path":"db/schema_migrations/20211021134458","new_path":"db/schema_migrations/20211021134458","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1 @@\n+1baa8db0d42a8d99e48b61930f5c42d1af5f86555488419b6551e1dbf417d3ad\n\\ No newline at end of file\n"},{"old_path":"db/structure.sql","new_path":"db/structure.sql","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -10457,6 +10457,10 @@ CREATE TABLE application_settings (\n     encrypted_content_validation_api_key bytea,\n     encrypted_content_validation_api_key_iv bytea,\n     content_validation_endpoint_enabled boolean DEFAULT false NOT NULL,\n+    sentry_enabled boolean DEFAULT false NOT NULL,\n+    sentry_dsn text,\n+    sentry_clientside_dsn text,\n+    sentry_environment text,\n     CONSTRAINT app_settings_container_reg_cleanup_tags_max_list_size_positive CHECK ((container_registry_cleanup_tags_service_max_list_size \u003e= 0)),\n     CONSTRAINT app_settings_dep_proxy_ttl_policies_worker_capacity_positive CHECK ((dependency_proxy_ttl_group_policy_worker_capacity \u003e= 0)),\n     CONSTRAINT app_settings_ext_pipeline_validation_service_url_text_limit CHECK ((char_length(external_pipeline_validation_service_url) \u003c= 255)),\n@@ -10465,9 +10469,12 @@ CREATE TABLE application_settings (\n     CONSTRAINT app_settings_yaml_max_size_positive CHECK ((max_yaml_size_bytes \u003e 0)),\n     CONSTRAINT check_17d9558205 CHECK ((char_length((kroki_url)::text) \u003c= 1024)),\n     CONSTRAINT check_2dba05b802 CHECK ((char_length(gitpod_url) \u003c= 255)),\n+    CONSTRAINT check_3def0f1829 CHECK ((char_length(sentry_clientside_dsn) \u003c= 255)),\n+    CONSTRAINT check_4f8b811780 CHECK ((char_length(sentry_dsn) \u003c= 255)),\n     CONSTRAINT check_51700b31b5 CHECK ((char_length(default_branch_name) \u003c= 255)),\n     CONSTRAINT check_57123c9593 CHECK ((char_length(help_page_documentation_base_url) \u003c= 255)),\n     CONSTRAINT check_5a84c3ffdc CHECK ((char_length(content_validation_endpoint_url) \u003c= 255)),\n+    CONSTRAINT check_5bcba483c4 CHECK ((char_length(sentry_environment) \u003c= 255)),\n     CONSTRAINT check_718b4458ae CHECK ((char_length(personal_access_token_prefix) \u003c= 20)),\n     CONSTRAINT check_7227fad848 CHECK ((char_length(rate_limiting_response_text) \u003c= 255)),\n     CONSTRAINT check_85a39b68ff CHECK ((char_length(encrypted_ci_jwt_signing_key_iv) \u003c= 255)),\n"},{"old_path":"doc/api/graphql/reference/index.md","new_path":"doc/api/graphql/reference/index.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -2820,6 +2820,28 @@ Input type: `IssueSetConfidentialInput`\n | \u003ca id=\"mutationissuesetconfidentialerrors\"\u003e\u003c/a\u003e`errors` | [`[String!]!`](#string) | Errors encountered during execution of the mutation. |\n | \u003ca id=\"mutationissuesetconfidentialissue\"\u003e\u003c/a\u003e`issue` | [`Issue`](#issue) | Issue after mutation. |\n \n+### `Mutation.issueSetCrmContacts`\n+\n+Input type: `IssueSetCrmContactsInput`\n+\n+#### Arguments\n+\n+| Name | Type | Description |\n+| ---- | ---- | ----------- |\n+| \u003ca id=\"mutationissuesetcrmcontactsclientmutationid\"\u003e\u003c/a\u003e`clientMutationId` | [`String`](#string) | A unique identifier for the client performing the mutation. |\n+| \u003ca id=\"mutationissuesetcrmcontactscrmcontactids\"\u003e\u003c/a\u003e`crmContactIds` | [`[CustomerRelationsContactID!]!`](#customerrelationscontactid) | Customer relations contact IDs to set. Replaces existing contacts by default. |\n+| \u003ca id=\"mutationissuesetcrmcontactsiid\"\u003e\u003c/a\u003e`iid` | [`String!`](#string) | IID of the issue to mutate. |\n+| \u003ca id=\"mutationissuesetcrmcontactsoperationmode\"\u003e\u003c/a\u003e`operationMode` | [`MutationOperationMode`](#mutationoperationmode) | Changes the operation mode. Defaults to REPLACE. |\n+| \u003ca id=\"mutationissuesetcrmcontactsprojectpath\"\u003e\u003c/a\u003e`projectPath` | [`ID!`](#id) | Project the issue to mutate is in. |\n+\n+#### Fields\n+\n+| Name | Type | Description |\n+| ---- | ---- | ----------- |\n+| \u003ca id=\"mutationissuesetcrmcontactsclientmutationid\"\u003e\u003c/a\u003e`clientMutationId` | [`String`](#string) | A unique identifier for the client performing the mutation. |\n+| \u003ca id=\"mutationissuesetcrmcontactserrors\"\u003e\u003c/a\u003e`errors` | [`[String!]!`](#string) | Errors encountered during execution of the mutation. |\n+| \u003ca id=\"mutationissuesetcrmcontactsissue\"\u003e\u003c/a\u003e`issue` | [`Issue`](#issue) | Issue after mutation. |\n+\n ### `Mutation.issueSetDueDate`\n \n Input type: `IssueSetDueDateInput`\n"},{"old_path":"doc/api/packages/maven.md","new_path":"doc/api/packages/maven.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -36,13 +36,13 @@ GET packages/maven/*path/:file_name\n | `file_name`  | string | yes | The name of the Maven package file. |\n \n ```shell\n-curl --header \"Private-Token: \u003cpersonal_access_token\u003e\" \"https://gitlab.example.com/api/v4/packages/maven/foo/bar/baz/mypkg-1.0-SNAPSHOT.jar\"\n+curl --header \"Private-Token: \u003cpersonal_access_token\u003e\" \"https://gitlab.example.com/api/v4/packages/maven/foo/bar/mypkg/1.0-SNAPSHOT/mypkg-1.0-SNAPSHOT.jar\"\n ```\n \n To write the output to file:\n \n ```shell\n-curl --header \"Private-Token: \u003cpersonal_access_token\u003e\" \"https://gitlab.example.com/api/v4/packages/maven/foo/bar/baz/mypkg-1.0-SNAPSHOT.jar\" \u003e\u003e mypkg-1.0-SNAPSHOT.jar\n+curl --header \"Private-Token: \u003cpersonal_access_token\u003e\" \"https://gitlab.example.com/api/v4/packages/maven/foo/bar/mypkg/1.0-SNAPSHOT/mypkg-1.0-SNAPSHOT.jar\" \u003e\u003e mypkg-1.0-SNAPSHOT.jar\n ```\n \n This writes the downloaded file to `mypkg-1.0-SNAPSHOT.jar` in the current directory.\n@@ -63,13 +63,13 @@ GET groups/:id/-/packages/maven/*path/:file_name\n | `file_name`  | string | yes | The name of the Maven package file. |\n \n ```shell\n-curl --header \"Private-Token: \u003cpersonal_access_token\u003e\" \"https://gitlab.example.com/api/v4/groups/1/-/packages/maven/foo/bar/baz/mypkg-1.0-SNAPSHOT.jar\"\n+curl --header \"Private-Token: \u003cpersonal_access_token\u003e\" \"https://gitlab.example.com/api/v4/groups/1/-/packages/maven/foo/bar/mypkg/1.0-SNAPSHOT/mypkg-1.0-SNAPSHOT.jar\"\n ```\n \n To write the output to file:\n \n ```shell\n-curl --header \"Private-Token: \u003cpersonal_access_token\u003e\" \"https://gitlab.example.com/api/v4/groups/1/-/packages/maven/foo/bar/baz/mypkg-1.0-SNAPSHOT.jar\" \u003e\u003e mypkg-1.0-SNAPSHOT.jar\n+curl --header \"Private-Token: \u003cpersonal_access_token\u003e\" \"https://gitlab.example.com/api/v4/groups/1/-/packages/maven/foo/bar/mypkg/1.0-SNAPSHOT/mypkg-1.0-SNAPSHOT.jar\" \u003e\u003e mypkg-1.0-SNAPSHOT.jar\n ```\n \n This writes the downloaded file to `mypkg-1.0-SNAPSHOT.jar` in the current directory.\n@@ -90,13 +90,13 @@ GET projects/:id/packages/maven/*path/:file_name\n | `file_name`  | string | yes | The name of the Maven package file. |\n \n ```shell\n-curl --header \"Private-Token: \u003cpersonal_access_token\u003e\" \"https://gitlab.example.com/api/v4/projects/1/packages/maven/foo/bar/baz/mypkg-1.0-SNAPSHOT.jar\"\n+curl --header \"Private-Token: \u003cpersonal_access_token\u003e\" \"https://gitlab.example.com/api/v4/projects/1/packages/maven/foo/bar/mypkg/1.0-SNAPSHOT/mypkg-1.0-SNAPSHOT.jar\"\n ```\n \n To write the output to file:\n \n ```shell\n-curl --header \"Private-Token: \u003cpersonal_access_token\u003e\" \"https://gitlab.example.com/api/v4/projects/1/packages/maven/foo/bar/baz/mypkg-1.0-SNAPSHOT.jar\" \u003e\u003e mypkg-1.0-SNAPSHOT.jar\n+curl --header \"Private-Token: \u003cpersonal_access_token\u003e\" \"https://gitlab.example.com/api/v4/projects/1/packages/maven/foo/bar/mypkg/1.0-SNAPSHOT/mypkg-1.0-SNAPSHOT.jar\" \u003e\u003e mypkg-1.0-SNAPSHOT.jar\n ```\n \n This writes the downloaded file to `mypkg-1.0-SNAPSHOT.jar` in the current directory.\n@@ -120,5 +120,5 @@ PUT projects/:id/packages/maven/*path/:file_name\n curl --request PUT \\\n      --upload-file path/to/mypkg-1.0-SNAPSHOT.pom \\\n      --header \"Private-Token: \u003cpersonal_access_token\u003e\" \\\n-     \"https://gitlab.example.com/api/v4/projects/1/packages/maven/foo/bar/baz/mypkg-1.0-SNAPSHOT.pom\"\n+     \"https://gitlab.example.com/api/v4/projects/1/packages/maven/foo/bar/mypkg/1.0-SNAPSHOT/mypkg-1.0-SNAPSHOT.pom\"\n ```\n"},{"old_path":"doc/ci/jobs/index.md","new_path":"doc/ci/jobs/index.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -82,6 +82,20 @@ For example:\n \n ![Pipeline mini graph sorting](img/pipelines_mini_graph_sorting.png)\n \n+## Unavailable names for jobs\n+\n+You can't use these keywords as job names:\n+\n+- `image`\n+- `services`\n+- `stages`\n+- `types`\n+- `before_script`\n+- `after_script`\n+- `variables`\n+- `cache`\n+- `include`\n+\n ## Group jobs in a pipeline\n \n If you have many similar jobs, your [pipeline graph](../pipelines/index.md#visualize-pipelines) becomes long and hard\n"},{"old_path":"doc/ci/quick_start/index.md","new_path":"doc/ci/quick_start/index.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -141,7 +141,7 @@ The pipeline starts when the commit is committed.\n - You can also use [CI/CD configuration visualization](../pipeline_editor/index.md#visualize-ci-configuration) to\n   view a graphical representation of your `.gitlab-ci.yml` file.\n - Each job contains scripts and stages:\n-  - The [`default`](../yaml/index.md#custom-default-keyword-values) keyword is for\n+  - The [`default`](../yaml/index.md#default) keyword is for\n     custom defaults, for example with [`before_script`](../yaml/index.md#before_script)\n     and [`after_script`](../yaml/index.md#after_script).\n   - [`stage`](../yaml/index.md#stage) describes the sequential execution of jobs.\n"},{"old_path":"doc/ci/runners/index.md","new_path":"doc/ci/runners/index.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -10,7 +10,7 @@ type: reference\n If you are using self-managed GitLab or you want to use your own runners on GitLab.com, you can\n [install and configure your own runners](https://docs.gitlab.com/runner/install/).\n \n-If you are using GitLab SaaS (GitLab.com), your CI jobs automatically run on runners in the GitLab Build Cloud.\n+If you are using GitLab SaaS (GitLab.com), your CI jobs automatically run on runners in the GitLab Runner Cloud.\n No configuration is required. Your jobs can run on:\n \n - [Linux runners](build_cloud/linux_build_cloud.md).\n"},{"old_path":"doc/ci/runners/runner_cloud/linux_runner_cloud.md","new_path":"doc/ci/runners/runner_cloud/linux_runner_cloud.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -35,7 +35,7 @@ These runners share a [distributed cache](https://docs.gitlab.com/runner/configu\n \n ## Pre-clone script\n \n-Build Cloud runners for Linux provide a way to run commands in a CI\n+Cloud runners for Linux provide a way to run commands in a CI\n job before the runner attempts to run `git init` and `git fetch` to\n download a GitLab repository. The\n [`pre_clone_script`](https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-section)\n"},{"old_path":"doc/ci/runners/runner_cloud/macos/environment.md","new_path":"doc/ci/runners/runner_cloud/macos/environment.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -4,9 +4,9 @@ group: Runner\n info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://about.gitlab.com/handbook/engineering/ux/technical-writing/#assignments\n ---\n \n-# VM instances and images for Build Cloud for macOS **(FREE)**\n+# VM instances and images for Runner Cloud for macOS **(FREE)**\n \n-When you use the Build Cloud for macOS:\n+When you use the Runner Cloud for macOS:\n \n - Each of your jobs runs in a newly provisioned VM, which is dedicated to the specific job.\n - The VM is active only for the duration of the job and immediately deleted.\n"},{"old_path":"doc/ci/runners/runner_cloud/macos_runner_cloud.md","new_path":"doc/ci/runners/runner_cloud/macos_runner_cloud.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -11,12 +11,12 @@ Use these runners to build, test, and deploy apps for the Apple ecosystem (macOS\n of all the capabilities of the GitLab single DevOps platform and not have to manage or operate a\n build environment.\n \n-Build Cloud runners for macOS are in [Beta](https://about.gitlab.com/handbook/product/gitlab-the-product/#beta)\n+Cloud runners for macOS are in [Beta](https://about.gitlab.com/handbook/product/gitlab-the-product/#beta)\n and shouldn't be relied upon for mission-critical production jobs.\n \n ## Quickstart\n \n-To start using Build Cloud for macOS Beta, you must submit an access request [issue](https://gitlab.com/gitlab-com/macos-buildcloud-runners-beta/-/issues/new?issuable_template=beta_access_request). After your\n+To start using Runner Cloud for macOS Beta, you must submit an access request [issue](https://gitlab.com/gitlab-com/macos-buildcloud-runners-beta/-/issues/new?issuable_template=beta_access_request). After your\n access has been granted and your build environment configured, you must configure your\n `.gitlab-ci.yml` pipeline file:\n \n"},{"old_path":"doc/ci/yaml/includes.md","new_path":"doc/ci/yaml/includes.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -69,7 +69,7 @@ You can include an array of configuration files:\n \n ## Use `default` configuration from an included configuration file\n \n-You can define a [`default`](index.md#custom-default-keyword-values) section in a\n+You can define a [`default`](index.md#default) section in a\n configuration file. When you use a `default` section with the `include` keyword, the defaults apply to\n all jobs in the pipeline.\n \n"},{"old_path":"doc/ci/yaml/index.md","new_path":"doc/ci/yaml/index.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":""},{"old_path":"doc/ci/yaml/script.md","new_path":"doc/ci/yaml/script.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -62,7 +62,7 @@ job:\n ## Set a default `before_script` or `after_script` for all jobs\n \n You can use [`before_script`](index.md#before_script) and [`after_script`](index.md#after_script)\n-with [`default`](index.md#custom-default-keyword-values):\n+with [`default`](index.md#default):\n \n - Use `before_script` with `default` to define a default array of commands that\n   should run before the `script` commands in all jobs.\n"},{"old_path":"doc/development/avoiding_downtime_in_migrations.md","new_path":"doc/development/avoiding_downtime_in_migrations.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -377,7 +377,181 @@ ensures that no downtime is needed.\n \n This operation does not require downtime.\n \n-## Data Migrations\n+## Migrating `integer` primary keys to `bigint`\n+\n+To [prevent the overflow risk](https://gitlab.com/groups/gitlab-org/-/epics/4785) for some tables\n+with `integer` primary key (PK), we have to migrate their PK to `bigint`. The process to do this\n+without downtime and causing too much load on the database is described below.\n+\n+### Initialize the conversion and start migrating existing data (release N)\n+\n+To start the process, add a regular migration to create the new `bigint` columns. Use the provided\n+`initialize_conversion_of_integer_to_bigint` helper. The helper also creates a database trigger\n+to keep in sync both columns for any new records ([see an example](https://gitlab.com/gitlab-org/gitlab/-/blob/41fbe34a4725a4e357a83fda66afb382828767b2/db/migrate/20210608072312_initialize_conversion_of_ci_stages_to_bigint.rb)):\n+\n+```ruby\n+class InitializeConversionOfCiStagesToBigint \u003c ActiveRecord::Migration[6.1]\n+  include Gitlab::Database::MigrationHelpers\n+\n+  TABLE = :ci_stages\n+  COLUMNS = %i(id)\n+\n+  def up\n+    initialize_conversion_of_integer_to_bigint(TABLE, COLUMNS)\n+  end\n+\n+  def down\n+    revert_initialize_conversion_of_integer_to_bigint(TABLE, COLUMNS)\n+  end\n+end\n+```\n+\n+Ignore the new `bigint` columns:\n+\n+```ruby\n+module Ci\n+  class Stage \u003c Ci::ApplicationRecord\n+    include IgnorableColumns\n+    ignore_column :id_convert_to_bigint, remove_with: '14.2', remove_after: '2021-08-22'\n+  end\n+```\n+\n+To migrate existing data, we introduced new type of _batched background migrations_.\n+Unlike the classic background migrations, built on top of Sidekiq, batched background migrations\n+don't have to enqueue and schedule all the background jobs at the beginning.\n+They also have other advantages, like automatic tuning of the batch size, better progress visibility,\n+and collecting metrics. To start the process, use the provided `backfill_conversion_of_integer_to_bigint`\n+helper ([example](https://gitlab.com/gitlab-org/gitlab/-/blob/41fbe34a4725a4e357a83fda66afb382828767b2/db/migrate/20210608072346_backfill_ci_stages_for_bigint_conversion.rb)):\n+\n+```ruby\n+class BackfillCiStagesForBigintConversion \u003c ActiveRecord::Migration[6.1]\n+  include Gitlab::Database::MigrationHelpers\n+\n+  TABLE = :ci_stages\n+  COLUMNS = %i(id)\n+\n+  def up\n+    backfill_conversion_of_integer_to_bigint(TABLE, COLUMNS)\n+  end\n+\n+  def down\n+    revert_backfill_conversion_of_integer_to_bigint(TABLE, COLUMNS)\n+  end\n+end\n+```\n+\n+### Monitor the background migration\n+\n+Check how the migration is performing while it's running. Multiple ways to do this are described below.\n+\n+#### High-level status of batched background migrations\n+\n+See how to [check the status of batched background migrations](../update/index.md#checking-for-background-migrations-before-upgrading).\n+\n+#### Query the database\n+\n+We can query the related database tables directly. Requires access to read-only replica.\n+Example queries:\n+\n+```sql\n+-- Get details for batched background migration for given table\n+SELECT * FROM batched_background_migrations WHERE table_name = 'namespaces'\\gx\n+\n+-- Get count of batched background migration jobs by status for given table\n+SELECT\n+  batched_background_migrations.id, batched_background_migration_jobs.status, COUNT(*)\n+FROM\n+  batched_background_migrations\n+  JOIN batched_background_migration_jobs ON batched_background_migrations.id = batched_background_migration_jobs.batched_background_migration_id\n+WHERE\n+  table_name = 'namespaces'\n+GROUP BY\n+  batched_background_migrations.id, batched_background_migration_jobs.status;\n+\n+-- Batched background migration progress for given table (based on estimated total number of tuples)\n+SELECT\n+  m.table_name,\n+  LEAST(100 * sum(j.batch_size) / pg_class.reltuples, 100) AS percentage_complete\n+FROM\n+  batched_background_migrations m\n+  JOIN batched_background_migration_jobs j ON j.batched_background_migration_id = m.id\n+  JOIN pg_class ON pg_class.relname = m.table_name\n+WHERE\n+  j.status = 3 AND m.table_name = 'namespaces'\n+GROUP BY m.id, pg_class.reltuples;\n+```\n+\n+#### Sidekiq logs\n+\n+We can also use the Sidekiq logs to monitor the worker that executes the batched background\n+migrations:\n+\n+1. Sign in to [Kibana](https://log.gprd.gitlab.net) with a `@gitlab.com` email address.\n+1. Change the index pattern to `pubsub-sidekiq-inf-gprd*`.\n+1. Add filter for `json.queue: cronjob:database_batched_background_migration`.\n+\n+#### PostgerSQL slow queries log\n+\n+Slow queries log keeps track of low queries that took above 1 second to execute. To see them\n+for batched background migration:\n+\n+1. Sign in to [Kibana](https://log.gprd.gitlab.net) with a `@gitlab.com` email address.\n+1. Change the index pattern to `pubsub-postgres-inf-gprd*`.\n+1. Add filter for `json.endpoint_id.keyword: Database::BatchedBackgroundMigrationWorker`.\n+1. Optional. To see only updates, add a filter for `json.command_tag.keyword: UPDATE`.\n+1. Optional. To see only failed statements, add a filter for `json.error_severiry.keyword: ERROR`.\n+1. Optional. Add a filter by table name.\n+\n+#### Grafana dashboards\n+\n+To monitor the health of the database, use these additional metrics:\n+\n+- [PostgreSQL Tuple Statistics](https://dashboards.gitlab.net/d/000000167/postgresql-tuple-statistics?orgId=1\u0026refresh=1m): if you see high rate of updates for the tables being actively converted, or increasing percentage of dead tuples for this table, it might mean that autovacuum cannot keep up.\n+- [PostgreSQL Overview](https://dashboards.gitlab.net/d/000000144/postgresql-overview?orgId=1): if you see high system usage or transactions per second (TPS) on the primary database server, it might mean that the migration is causing problems.\n+\n+### Prometheus metrics\n+\n+Number of [metrics](https://gitlab.com/gitlab-org/gitlab/-/blob/294a92484ce4611f660439aa48eee4dfec2230b5/lib/gitlab/database/background_migration/batched_migration_wrapper.rb#L90-128)\n+for each batched background migration are published to Prometheus. These metrics can be searched for and\n+visualized in Thanos ([see an example](https://thanos-query.ops.gitlab.net/graph?g0.expr=sum%20(rate(batched_migration_job_updated_tuples_total%7Benv%3D%22gprd%22%7D%5B5m%5D))%20by%20(migration_id)%20\u0026g0.tab=0\u0026g0.stacked=0\u0026g0.range_input=3d\u0026g0.max_source_resolution=0s\u0026g0.deduplicate=1\u0026g0.partial_response=0\u0026g0.store_matches=%5B%5D\u0026g0.end_input=2021-06-13%2012%3A18%3A24\u0026g0.moment_input=2021-06-13%2012%3A18%3A24)).\n+\n+### Swap the columns (release N + 1)\n+\n+After the background is completed and the new `bigint` columns are populated for all records, we can\n+swap the columns. Swapping is done with post-deployment migration. The exact process depends on the\n+table being converted, but in general it's done in the following steps:\n+\n+1. Using the provided `ensure_batched_background_migration_is_finished` helper, make sure the batched\n+migration has finished ([see an example](https://gitlab.com/gitlab-org/gitlab/-/blob/41fbe34a4725a4e357a83fda66afb382828767b2/db/post_migrate/20210707210916_finalize_ci_stages_bigint_conversion.rb#L13-18)).\n+If the migration has not completed, the subsequent steps fail anyway. By checking in advance we\n+aim to have more helpful error message.\n+1. Create indexes using the `bigint` columns that match the existing indexes using the `integer`\n+column ([see an example](https://gitlab.com/gitlab-org/gitlab/-/blob/41fbe34a4725a4e357a83fda66afb382828767b2/db/post_migrate/20210707210916_finalize_ci_stages_bigint_conversion.rb#L28-34)).\n+1. Create foreign keys (FK) using the `bigint` columns that match the existing FKs using the\n+`integer` column. Do this both for FK referencing other tables, and FKs that reference the table\n+that is being migrated ([see an example](https://gitlab.com/gitlab-org/gitlab/-/blob/41fbe34a4725a4e357a83fda66afb382828767b2/db/post_migrate/20210707210916_finalize_ci_stages_bigint_conversion.rb#L36-43)).\n+1. Inside a transaction, swap the columns:\n+    1. Lock the tables involved. To reduce the chance of hitting a deadlock, we recommended to do this in parent to child order ([see an example](https://gitlab.com/gitlab-org/gitlab/-/blob/41fbe34a4725a4e357a83fda66afb382828767b2/db/post_migrate/20210707210916_finalize_ci_stages_bigint_conversion.rb#L47)).\n+    1. Rename the columns to swap names ([see an example](https://gitlab.com/gitlab-org/gitlab/-/blob/41fbe34a4725a4e357a83fda66afb382828767b2/db/post_migrate/20210707210916_finalize_ci_stages_bigint_conversion.rb#L49-54))\n+    1. Reset the trigger function ([see an example](https://gitlab.com/gitlab-org/gitlab/-/blob/41fbe34a4725a4e357a83fda66afb382828767b2/db/post_migrate/20210707210916_finalize_ci_stages_bigint_conversion.rb#L56-57)).\n+    1. Swap the defaults ([see an example](https://gitlab.com/gitlab-org/gitlab/-/blob/41fbe34a4725a4e357a83fda66afb382828767b2/db/post_migrate/20210707210916_finalize_ci_stages_bigint_conversion.rb#L59-62)).\n+    1. Swap the PK constraint (if any) ([see an example](https://gitlab.com/gitlab-org/gitlab/-/blob/41fbe34a4725a4e357a83fda66afb382828767b2/db/post_migrate/20210707210916_finalize_ci_stages_bigint_conversion.rb#L64-68)).\n+    1. Remove old indexes and rename new ones ([see an example](https://gitlab.com/gitlab-org/gitlab/-/blob/41fbe34a4725a4e357a83fda66afb382828767b2/db/post_migrate/20210707210916_finalize_ci_stages_bigint_conversion.rb#L70-72)).\n+    1. Remove old FKs (if still present) and rename new ones ([see an example](https://gitlab.com/gitlab-org/gitlab/-/blob/41fbe34a4725a4e357a83fda66afb382828767b2/db/post_migrate/20210707210916_finalize_ci_stages_bigint_conversion.rb#L74)).\n+\n+See example [merge request](https://gitlab.com/gitlab-org/gitlab/-/merge_requests/66088), and [migration](https://gitlab.com/gitlab-org/gitlab/-/blob/41fbe34a4725a4e357a83fda66afb382828767b2/db/post_migrate/20210707210916_finalize_ci_stages_bigint_conversion.rb).\n+\n+### Remove the trigger and old `integer` columns (release N + 2)\n+\n+Using post-deployment migration and the provided `cleanup_conversion_of_integer_to_bigint` helper,\n+drop the database trigger and the old `integer` columns ([see an example](https://gitlab.com/gitlab-org/gitlab/-/merge_requests/69714)).\n+\n+### Remove ignore rules (release N + 3)\n+\n+In the next release after the columns were dropped, remove the ignore rules as we do not need them\n+anymore ([see an example](https://gitlab.com/gitlab-org/gitlab/-/merge_requests/71161)).\n+\n+## Data migrations\n \n Data migrations can be tricky. The usual approach to migrate data is to take a 3\n step approach:\n"},{"old_path":"doc/development/cicd/templates.md","new_path":"doc/development/cicd/templates.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -60,7 +60,7 @@ don't have any other `.gitlab-ci.yml` files.\n When authoring pipeline templates:\n \n - Place any [global keywords](../../ci/yaml/index.md#global-keywords) like `image`\n-  or `before_script` in a [`default`](../../ci/yaml/index.md#custom-default-keyword-values)\n+  or `before_script` in a [`default`](../../ci/yaml/index.md#default)\n   section at the top of the template.\n - Note clearly in the [code comments](#explain-the-template-with-comments) if the\n   template is designed to be used with the `includes` keyword in an existing\n@@ -77,7 +77,7 @@ other pipeline configuration.\n \n When authoring job templates:\n \n-- Do not use [global](../../ci/yaml/index.md#global-keywords) or [`default`](../../ci/yaml/index.md#custom-default-keyword-values)\n+- Do not use [global](../../ci/yaml/index.md#global-keywords) or [`default`](../../ci/yaml/index.md#default)\n   keywords. When a root `.gitlab-ci.yml` includes a template, global or default keywords\n   might be overridden and cause unexpected behavior. If a job template requires a\n   specific stage, explain in the code comments that users must manually add the stage\n"},{"old_path":"doc/development/migration_style_guide.md","new_path":"doc/development/migration_style_guide.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -135,6 +135,7 @@ various database operations, such as:\n - [dropping and renaming columns](avoiding_downtime_in_migrations.md#dropping-columns)\n - [changing column constraints and types](avoiding_downtime_in_migrations.md#changing-column-constraints)\n - [adding and dropping indexes, tables, and foreign keys](avoiding_downtime_in_migrations.md#adding-indexes)\n+- [migrating `integer` primary keys to `bigint`](avoiding_downtime_in_migrations.md#adding-indexes)\n \n and explains how to perform them without requiring downtime.\n \n"},{"old_path":"doc/development/pipelines.md","new_path":"doc/development/pipelines.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -166,6 +166,13 @@ Our current RSpec tests parallelization setup is as follows:\n \n After that, the next pipeline uses the up-to-date `knapsack/report-master.json` file.\n \n+### Flaky tests\n+\n+Tests that are [known to be flaky](testing_guide/flaky_tests.md#automatic-retries-and-flaky-tests-detection) are:\n+\n+- skipped if the `$SKIP_FLAKY_TESTS_AUTOMATICALLY` variable is set to `true` (`false` by default)\n+- run if `$SKIP_FLAKY_TESTS_AUTOMATICALLY` variable is not set to `true` or if the `~\"pipeline:run-flaky-tests\"` label is set on the MR\n+\n ### Monitoring\n \n The GitLab test suite is [monitored](performance.md#rspec-profiling) for the `main` branch, and any branch\n"},{"old_path":"doc/install/requirements.md","new_path":"doc/install/requirements.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -302,7 +302,7 @@ The GitLab Runner server requirements depend on:\n \n Since the nature of the jobs varies for each use case, you need to experiment by adjusting the job concurrency to get the optimum setting.\n \n-For reference, the GitLab.com Build Cloud [auto-scaling runner for Linux](../ci/runners/build_cloud/linux_build_cloud.md) is configured so that a **single job** runs in a **single instance** with:\n+For reference, the GitLab.com Runner Cloud [auto-scaling runner for Linux](../ci/runners/build_cloud/linux_build_cloud.md) is configured so that a **single job** runs in a **single instance** with:\n \n - 1 vCPU.\n - 3.75 GB of RAM.\n"},{"old_path":"doc/integration/jira/index.md","new_path":"doc/integration/jira/index.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -10,7 +10,7 @@ If your organization uses [Jira](https://www.atlassian.com/software/jira) issues\n you can [migrate your issues from Jira](../../user/project/import/jira.md) and work\n exclusively in GitLab. However, if you'd like to continue to use Jira, you can\n integrate it with GitLab. GitLab offers two types of Jira integrations, and you\n-can use one or both depending on the capabilities you need. It is recommended that you enable both.\n+can use one or both depending on the capabilities you need. We recommend you enable both.\n \n ## Compare integrations\n \n@@ -41,7 +41,7 @@ or the Jira DVCS (distributed version control system) connector,\n \n ### Direct feature comparison\n \n-| Capability | Jira integration | Jira Development panel integration |\n+| Capability | Jira integration | Jira development panel integration |\n |-|-|-|\n | Mention a Jira issue ID in a GitLab commit or merge request, and a link to the Jira issue is created. | Yes. | No. |\n | Mention a Jira issue ID in GitLab and the Jira issue shows the GitLab issue or merge request. | Yes. A Jira comment with the GitLab issue or MR title links to GitLab. The first mention is also added to the Jira issue under **Web links**. | Yes, in the issue's [development panel](https://support.atlassian.com/jira-software-cloud/docs/view-development-information-for-an-issue/). |\n@@ -55,11 +55,11 @@ or the Jira DVCS (distributed version control system) connector,\n \n ## Authentication in Jira\n \n-The process for configuring Jira depends on whether you host Jira on your own server or on\n+The authentication method in Jira depends on whether you host Jira on your own server or on\n [Atlassian cloud](https://www.atlassian.com/cloud):\n \n - **Jira Server** supports basic authentication. When connecting, a **username and password** are\n-  required. Connecting to Jira Server via CAS is not possible. For more information, read\n+  required. Connecting to Jira Server using the Central Authentication Service (CAS) is not possible. For more information, read\n   how to [set up a user in Jira Server](jira_server_configuration.md).\n - **Jira on Atlassian cloud** supports authentication through an API token. When connecting to Jira on\n   Atlassian cloud, an email and API token are required. For more information, read\n@@ -72,11 +72,16 @@ actions in GitLab issues and merge requests linked to a Jira issue leak informat\n about the private project to non-administrator Jira users. If your installation uses Jira Cloud,\n you can use the [GitLab.com for Jira Cloud app](connect-app.md) to avoid this risk.\n \n+## Third-party Jira integrations\n+\n+Developers have built several third-party Jira integrations for GitLab that are\n+listed on the [Atlassian Marketplace](https://marketplace.atlassian.com/search?product=jira\u0026query=gitlab).\n+\n ## Troubleshooting\n \n If these features do not work as expected, it is likely due to a problem with the way the integration settings were configured.\n \n-### GitLab is unable to comment on a Jira issue\n+### GitLab cannot comment on a Jira issue\n \n If GitLab cannot comment on Jira issues, make sure the Jira user you\n set up for the integration has permission to:\n@@ -86,14 +91,16 @@ set up for the integration has permission to:\n \n Jira issue references and update comments do not work if the GitLab issue tracker is disabled.\n \n-### GitLab is unable to close a Jira issue\n+### GitLab cannot close a Jira issue\n+\n+If GitLab cannot close a Jira issue:\n \n-Make sure the `Transition ID` you set in the Jira settings matches the one\n-your project needs to close an issue.\n+- Make sure the `Transition ID` you set in the Jira settings matches the one\n+  your project needs to close an issue.\n \n-Make sure that the Jira issue is not already marked as resolved. That is,\n-the Jira issue resolution field is not set, and the issue is not struck through in\n-Jira lists.\n+- Make sure the Jira issue is not already marked as resolved:\n+  - Check the Jira issue resolution field is not set.\n+  - Check the issue is not struck through in Jira lists.\n \n ### CAPTCHA\n \n@@ -104,8 +111,3 @@ authenticate with the Jira site.\n \n To fix this error, sign in to your Jira instance\n and complete the CAPTCHA.\n-\n-## Third-party Jira integrations\n-\n-Developers have built several third-party Jira integrations for GitLab that are\n-listed on the [Atlassian Marketplace](https://marketplace.atlassian.com/search?product=jira\u0026query=gitlab).\n"},{"old_path":"doc/user/admin_area/index.md","new_path":"doc/user/admin_area/index.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -257,6 +257,10 @@ To edit a topic, select **Edit** in that topic's row.\n To search for topics by name, enter your criteria in the search box. The topic search is case\n insensitive, and applies partial matching.\n \n+NOTE:\n+Topics are public and visible to everyone, but assignments to projects are not.\n+Do not include sensitive information in the name or description of a topic.\n+\n ### Administering Jobs\n \n You can administer all jobs in the GitLab instance from the Admin Area's Jobs page.\n"},{"old_path":"doc/user/clusters/agent/install/index.md","new_path":"doc/user/clusters/agent/install/index.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -85,6 +85,7 @@ the Agent in subsequent steps.\n \n In GitLab:\n \n+1. Ensure that [GitLab CI/CD is enabled in your project](../../../../ci/enable_or_disable_ci.md#enable-cicd-in-a-project).\n 1. From your project's sidebar, select **Infrastructure \u003e Kubernetes clusters**.\n 1. Select the **GitLab Agent managed clusters** tab.\n 1. Select **Integrate with the GitLab Agent**.\n"},{"old_path":"doc/user/clusters/agent/repository.md","new_path":"doc/user/clusters/agent/repository.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -173,7 +173,7 @@ To grant projects access to the Agent through the [CI/CD Tunnel](ci_cd_tunnel.md\n 1. Go to your Agent's configuration project.\n 1. Edit the Agent's configuration file (`config.yaml`).\n 1. Add the `projects` attribute into `ci_access`.\n-1. Identify the new project through its path:\n+1. Identify the project through its path:\n \n    ```yaml\n    ci_access:\n"},{"old_path":"doc/user/clusters/management_project.md","new_path":"doc/user/clusters/management_project.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -12,6 +12,9 @@ info: To determine the technical writer assigned to the Stage/Group associated w\n WARNING:\n This feature was [deprecated](https://gitlab.com/groups/gitlab-org/configure/-/epics/8) in GitLab 14.5.\n \n+To manage cluster applications, use the [GitLab Kubernetes Agent](agent/index.md)\n+with the [Cluster Management Project Template](management_project_template.md).\n+\n A project can be designated as the management project for a cluster.\n A management project can be used to run deployment jobs with\n Kubernetes\n@@ -41,8 +44,7 @@ Management projects are restricted to the following:\n To use a cluster management project to manage your cluster:\n \n 1. Create a new project to serve as the cluster management project\n-for your cluster. We recommend that you\n-[create this project based on the Cluster Management project template](management_project_template.md#create-a-new-project-based-on-the-cluster-management-template).\n+for your cluster.\n 1. [Associate the cluster with the management project](#associate-the-cluster-management-project-with-the-cluster).\n 1. [Configure your cluster's pipelines](#configuring-your-pipeline).\n 1. [Set the environment scope](#setting-the-environment-scope).\n"},{"old_path":"doc/user/clusters/management_project_template.md","new_path":"doc/user/clusters/management_project_template.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -4,15 +4,17 @@ group: Configure\n info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://about.gitlab.com/handbook/engineering/ux/technical-writing/#assignments\n ---\n \n-# Cluster Management project template **(FREE)**\n+# Manage cluster applications **(FREE)**\n \n \u003e - [Introduced](https://gitlab.com/gitlab-org/gitlab/-/merge_requests/25318) in GitLab 12.10 with Helmfile support via Helm v2.\n \u003e - Helm v2 support was [dropped](https://gitlab.com/gitlab-org/gitlab/-/merge_requests/63577) in GitLab 14.0. Use Helm v3 instead.\n+\u003e - [Migrated](https://gitlab.com/gitlab-org/project-templates/cluster-management/-/merge_requests/24) to the GitLab Kubernetes Agent in GitLab 14.5.\n \n-With a [cluster management project](management_project.md) you can manage\n-your cluster's deployment and applications through a repository in GitLab.\n+Use a repository to install, manage, and deploy clusters applications through code.\n \n-The Cluster Management project template provides you a baseline to get\n+## Cluster Management Project Template\n+\n+The Cluster Management Project Template provides you a baseline to get\n started and flexibility to customize your project to your cluster's needs.\n For instance, you can:\n \n@@ -21,49 +23,78 @@ For instance, you can:\n - Remove the built-in cluster applications you don't need.\n - Add other cluster applications using the same structure as the ones already available.\n \n-The template contains the following [components](#available-components):\n+The template contains the following [components](#configure-the-available-components):\n \n-- A pre-configured GitLab CI/CD file so that you can configure deployment pipelines.\n+- A pre-configured GitLab CI/CD file so that you can configure CI/CD pipelines using the [CI/CD Tunnel](agent/ci_cd_tunnel.md).\n - A pre-configured [Helmfile](https://github.com/roboll/helmfile) so that\n you can manage cluster applications with [Helm v3](https://helm.sh/).\n - An `applications` directory with a `helmfile.yaml` configured for each\n application available in the template.\n \n-WARNING:\n-If you used [GitLab Managed Apps](applications.md) to manage your\n-cluster from GitLab, see how to [migrate from GitLab Managed Apps](migrating_from_gma_to_project_template.md) to the Cluster Management\n-project.\n+## Use the Kubernetes Agent with the Cluster Management Project Template\n+\n+To use a new project created from the Cluster Management Project Template\n+with a cluster connected to GitLab through the [GitLab Kubernetes Agent](agent/index.md),\n+you have two options:\n+\n+- [Use one single project](#single-project) to configure the Agent and manage cluster applications.\n+- [Use separate projects](#separate-projects) - one to configure the Agent and another to manage cluster applications.\n+\n+### Single project\n+\n+This setup is particularly useful when you haven't connected your cluster\n+to GitLab through the Agent yet and you want to use the Cluster Management\n+Project Template to manage cluster applications.\n+\n+To use one single project to configure the Agent and to manage cluster applications:\n+\n+1. [Create a new project from the Cluster Management Project Template](#create-a-new-project-based-on-the-cluster-management-template).\n+1. Configure the new project as the [Agent's configuration repository](agent/repository.md)\n+(where the Agent is registered and its `config.yaml` is stored).\n+1. From your project's settings, add a [new environment variable](../../ci/variables/index.md#add-a-cicd-variable-to-a-project) `$KUBE_CONTEXT` and set it to `path/to/agent-configuration-project:your-agent-name`.\n+1. [Configure the components](#configure-the-available-components) inherited from the template.\n+\n+### Separate projects\n+\n+This setup is particularly useful **when you already have a cluster** connected\n+to GitLab through the Agent and want to use the Cluster Management\n+Project Template to manage cluster applications.\n \n-## Set up the management project from the Cluster Management project template\n+To use one project to configure the Agent (\"project A\") and another project to\n+manage cluster applications (\"project B\"), follow the steps below.\n \n-To set up your cluster's management project off of the Cluster Management project template:\n+We assume that you already have a cluster connected through the Agent and\n+[configured through the Agent's configuration repository](agent/repository.md)\n+(\"project A\").\n \n-1. [Create a new project based on the Cluster Management template](#create-a-new-project-based-on-the-cluster-management-template).\n-1. [Associate the cluster management project with your cluster](management_project.md#associate-the-cluster-management-project-with-the-cluster).\n-1. Use the [available components](#available-components) to manage your cluster.\n+1. [Create a new project from the Cluster Management Project Template](#create-a-new-project-based-on-the-cluster-management-template).\n+This new project is \"project B\".\n+1. In your \"project A\", [grant the Agent access to the new project (B) through the CI/CD Tunnel](agent/repository.md#authorize-projects-to-use-an-agent).\n+1. From the \"project's B\" settings, add a [new environment variable](../../ci/variables/index.md#add-a-cicd-variable-to-a-project) `$KUBE_CONTEXT` and set it to `path/to/agent-configuration-project:your-agent-name`.\n+1. In \"project B\", [configure the components](#configure-the-available-components) inherited from the template.\n \n-### Create a new project based on the Cluster Management template\n+## Create a new project based on the Cluster Management Template\n \n To get started, create a new project based on the Cluster Management\n project template to use as a cluster management project.\n \n-You can either create the [new project](../project/working_with_projects.md#create-a-project)\n-from the template or import the project from the URL. Importing\n-the project is useful if you are using a GitLab self-managed\n-instance that may not have the latest version of the template.\n+You can either create the new project from the template or import the\n+project from the URL. Importing the project is useful if you are using\n+a GitLab self-managed instance that may not have the latest version of\n+the template.\n \n-To create the new project:\n+To [create the new project](../project/working_with_projects.md#create-a-project):\n \n - From the template: select the **GitLab Cluster Management** project template.\n - Importing from the URL: use `https://gitlab.com/gitlab-org/project-templates/cluster-management.git`.\n \n-## Available components\n+## Configure the available components\n \n-Use the available components to configure your cluster:\n+Use the available components to configure your cluster applications:\n \n-- [A `.gitlab-ci.yml` file](#the-gitlab-ciyml-file).\n-- [A main `helmfile.yml` file](#the-main-helmfileyml-file).\n-- [A directory with built-in applications](#built-in-applications).\n+- [The `.gitlab-ci.yml` file](#the-gitlab-ciyml-file).\n+- [The main `helmfile.yml` file](#the-main-helmfileyml-file).\n+- [The directory with built-in applications](#built-in-applications).\n \n ### The `.gitlab-ci.yml` file\n \n@@ -107,7 +138,7 @@ The [built-in supported applications](https://gitlab.com/gitlab-org/project-temp\n - [Sentry](../infrastructure/clusters/manage/management_project_applications/sentry.md)\n - [Vault](../infrastructure/clusters/manage/management_project_applications/vault.md)\n \n-#### How to customize your applications\n+#### Customize your applications\n \n Each app has an `applications/{app}/values.yaml` file (`applications/{app}/values.yaml.gotmpl` in case of GitLab Runner). This is the\n place where you can define default values for your app's Helm chart. Some apps already have defaults\n"},{"old_path":"doc/user/gitlab_com/index.md","new_path":"doc/user/gitlab_com/index.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -198,11 +198,11 @@ The following limits apply for [Webhooks](../project/integrations/webhooks.md):\n | [Number of webhooks](../../administration/instance_limits.md#number-of-webhooks) | `100` per project, `50` per group | `100` per project, `50` per group |\n | Maximum payload size | 25 MB       | 25 MB   |\n \n-## Shared Build Cloud runners\n+## Shared Runner Cloud runners\n \n GitLab has shared runners on GitLab.com that you can use to run your CI jobs.\n \n-For more information, see [GitLab Build Cloud runners](../../ci/runners/index.md).\n+For more information, see [GitLab Runner Cloud runners](../../ci/runners/index.md).\n \n ## Sidekiq\n \n"},{"old_path":"doc/user/group/saml_sso/scim_setup.md","new_path":"doc/user/group/saml_sso/scim_setup.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -35,9 +35,10 @@ The following identity providers are supported:\n \n Once [Group Single Sign-On](index.md) has been configured, we can:\n \n-1. Navigate to the group and click **Administration \u003e SAML SSO**.\n-1. Click on the **Generate a SCIM token** button.\n-1. Save the token and URL so they can be used in the next step.\n+1. On the top bar, select **Menu \u003e Groups** and find your group.\n+1. On the left sidebar, select **Settings \u003e SAML SSO**.\n+1. Select **Generate a SCIM token**.\n+1. Save the token and URL for use in the next step.\n \n ![SCIM token configuration](img/scim_token_v13_3.png)\n \n@@ -50,14 +51,14 @@ Once [Group Single Sign-On](index.md) has been configured, we can:\n \n The SAML application that was created during [Single sign-on](index.md) setup for [Azure](https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/view-applications-portal) now needs to be set up for SCIM.\n \n-1. Set up automatic provisioning and administrative credentials by following the\n+1. Enable automatic provisioning and administrative credentials by following the\n    [Azure's SCIM setup documentation](https://docs.microsoft.com/en-us/azure/active-directory/app-provisioning/use-scim-to-provision-users-and-groups#provisioning-users-and-groups-to-applications-that-support-scim).\n \n During this configuration, note the following:\n \n-- The `Tenant URL` and `secret token` are the ones retrieved in the\n+- The `Tenant URL` and `secret token` are the items retrieved in the\n   [previous step](#gitlab-configuration).\n-- It is recommended to set a notification email and check the **Send an email notification when a failure occurs** checkbox.\n+- We recommend setting a notification email and selecting the **Send an email notification when a failure occurs** checkbox.\n - For mappings, we only leave `Synchronize Azure Active Directory Users to AppName` enabled.\n   `Synchronize Azure Active Directory Groups to AppName` is usually disabled. However, this\n   does not mean Azure AD users cannot be provisioned in groups. Leaving it enabled does not break\n@@ -113,29 +114,27 @@ Make sure that the Okta setup matches our documentation exactly, especially the\n configuration. Otherwise, the Okta SCIM app may not work properly.\n \n 1. Sign in to Okta.\n-1. If you see an **Admin** button in the top right, click the button. This will\n-   ensure you are in the Admin area.\n+1. Ensure you are in the Admin section by selecting the **Admin** button located in the top right. The admin button is not visible from the admin page.\n \n    NOTE:\n-   If you're using the Developer Console, click **Developer Console** in the top\n-   bar and select **Classic UI**. Otherwise, you may not see the buttons described\n-   in the following steps:\n+   If you're using the Developer Console, select **Developer Console** in the top\n+   bar and then select **Classic UI**. Otherwise, you may not see the buttons described in the following steps:\n \n-1. In the **Application** tab, click **Add Application**.\n-1. Search for **GitLab**, find and click on the 'GitLab' application.\n-1. On the GitLab application overview page, click **Add**.\n+1. In the **Application** tab, select **Add Application**.\n+1. Search for **GitLab**, find and select on the 'GitLab' application.\n+1. On the GitLab application overview page, select **Add**.\n 1. Under **Application Visibility** select both checkboxes. Currently the GitLab application does not support SAML authentication so the icon should not be shown to users.\n-1. Click **Done** to finish adding the application.\n-1. In the **Provisioning** tab, click **Configure API integration**.\n+1. Select **Done** to finish adding the application.\n+1. In the **Provisioning** tab, select **Configure API integration**.\n 1. Select **Enable API integration**.\n     - For **Base URL** enter the URL obtained from the GitLab SCIM configuration page\n     - For **API Token** enter the SCIM token obtained from the GitLab SCIM configuration page\n-1. Click 'Test API Credentials' to verify configuration.\n-1. Click **Save** to apply the settings.\n-1. After saving the API integration details, new settings tabs appear on the left. Choose **To App**.\n-1. Click **Edit**.\n-1. Check the box to **Enable** for both **Create Users** and **Deactivate Users**.\n-1. Click **Save**.\n+1. Select 'Test API Credentials' to verify configuration.\n+1. Select **Save** to apply the settings.\n+1. After saving the API integration details, new settings tabs appear on the left. Select **To App**.\n+1. Select **Edit**.\n+1. Select the **Enable** checkbox for both **Create Users** and **Deactivate Users**.\n+1. Select **Save**.\n 1. Assign users in the **Assignments** tab. Assigned users are created and\n    managed in your GitLab group.\n \n@@ -147,8 +146,8 @@ application described above.\n \n ### OneLogin\n \n-OneLogin provides a \"GitLab (SaaS)\" app in their catalog, which includes a SCIM integration.\n-As the app is developed by OneLogin, please reach out to OneLogin if you encounter issues.\n+As the developers of this app, OneLogin provides a \"GitLab (SaaS)\" app in their catalog, which includes a SCIM integration.\n+Please reach out to OneLogin if you encounter issues.\n \n ## User access and linking setup\n \n@@ -177,8 +176,8 @@ As long as [Group SAML](index.md) has been configured, existing GitLab.com users\n - By following these steps:\n \n   1. Sign in to GitLab.com if needed.\n-  1. Click on the GitLab app in the identity provider's dashboard or visit the **GitLab single sign-on URL**.\n-  1. Click on the **Authorize** button.\n+  1. In the identity provider's dashboard select the GitLab app or visit the **GitLab single sign-on URL**.\n+  1. Select the **Authorize**.\n \n We recommend users do this prior to turning on sync, because while synchronization is active, there may be provisioning errors for existing users.\n \n"},{"old_path":"doc/user/infrastructure/clusters/index.md","new_path":"doc/user/infrastructure/clusters/index.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -8,7 +8,7 @@ info: To determine the technical writer assigned to the Stage/Group associated w\n \n To connect clusters to GitLab, use the [GitLab Kubernetes Agent](../../clusters/agent/index.md).\n \n-## Certificate-based Kubernetes integration (DEPRECATED) **(FREE)**\n+## Certificate-based Kubernetes integration (DEPRECATED)\n \n WARNING:\n In GitLab 14.5, the certificate-based method to connect Kubernetes clusters\n"},{"old_path":"doc/user/infrastructure/clusters/manage/clusters_health.md","new_path":"doc/user/infrastructure/clusters/manage/clusters_health.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -6,8 +6,8 @@ info: To determine the technical writer assigned to the Stage/Group associated w\n \n # Clusters health **(FREE)**\n \n-\u003e - [Introduced](https://gitlab.com/gitlab-org/gitlab/-/merge_requests/4701) in [GitLab Ultimate](https://about.gitlab.com/pricing/) 10.6.\n-\u003e - [Moved](https://gitlab.com/gitlab-org/gitlab/-/issues/208224) to GitLab Free in 13.2.\n+\u003e - [Introduced](https://gitlab.com/gitlab-org/gitlab/-/merge_requests/4701) in GitLab 10.6.\n+\u003e - [Moved](https://gitlab.com/gitlab-org/gitlab/-/issues/208224) from GitLab Ultimate to GitLab Free in 13.2.\n \n When [the Prometheus cluster integration is enabled](../../../clusters/integrations.md#prometheus-cluster-integration), GitLab monitors the cluster's health. At the top of the cluster settings page, CPU and Memory utilization is displayed, along with the total amount available. Keeping an eye on cluster resources can be important, if the cluster runs out of memory pods may be shutdown or fail to start.\n \n"},{"old_path":"doc/user/infrastructure/clusters/manage/management_project_applications/certmanager.md","new_path":"doc/user/infrastructure/clusters/manage/management_project_applications/certmanager.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -4,7 +4,7 @@ group: Configure\n info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://about.gitlab.com/handbook/engineering/ux/technical-writing/#assignments\n ---\n \n-# Install cert-manager with a cluster management project\n+# Install cert-manager with a cluster management project **(FREE)**\n \n \u003e - [Introduced](https://gitlab.com/gitlab-org/project-templates/cluster-management/-/merge_requests/5) in GitLab 14.0.\n \u003e - Support for cert-manager v1.4 was [introduced](https://gitlab.com/gitlab-org/project-templates/cluster-management/-/merge_requests/69405) in GitLab 14.3.\n"},{"old_path":"doc/user/infrastructure/clusters/manage/management_project_applications/ingress.md","new_path":"doc/user/infrastructure/clusters/manage/management_project_applications/ingress.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -4,7 +4,7 @@ group: Configure\n info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://about.gitlab.com/handbook/engineering/ux/technical-writing/#assignments\n ---\n \n-# Install Ingress with a cluster management project\n+# Install Ingress with a cluster management project **(FREE)**\n \n \u003e [Introduced](https://gitlab.com/gitlab-org/project-templates/cluster-management/-/merge_requests/5) in GitLab 14.0.\n \n"},{"old_path":"doc/user/infrastructure/index.md","new_path":"doc/user/infrastructure/index.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -29,13 +29,12 @@ Learn more about how GitLab can help you run [Infrastructure as Code](iac/index.\n \n ## Integrated Kubernetes management\n \n-GitLab has special integrations with Kubernetes to help you deploy, manage and troubleshoot\n-third-party or custom applications in Kubernetes clusters. Auto DevOps provides a full\n-DevSecOps pipeline by default targeted at Kubernetes based deployments. To support\n-all the GitLab features, GitLab offers a cluster management project for easy onboarding.\n-The deploy boards provide quick insights into your cluster, including pod logs tailing.\n+The GitLab integration with Kubernetes helps you to install, configure, manage, deploy, and troubleshoot\n+cluster applications. With the GitLab Kubernetes Agent, you can connect clusters behind a firewall,\n+have real-time access to API endpoints, perform pull-beased or push-based deployments for production\n+and non-production environments, and much more.\n \n-Learn more about the [GitLab integration with Kubernetes](clusters/index.md).\n+Learn more about the [GitLab Kubernetes Agent](../clusters/agent/index.md).\n \n ## Runbooks in GitLab\n \n"},{"old_path":"doc/user/packages/composer_repository/index.md","new_path":"doc/user/packages/composer_repository/index.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -149,7 +149,7 @@ Do not save unless you want to overwrite the existing CI/CD file.\n When you publish:\n \n - The same package with different data, it overwrites the existing package.\n-- The same package with the same data, a `404 Bad request` error occurs.\n+- The same package with the same data, a `400 Bad request` error occurs.\n \n ## Install a Composer package\n \n"},{"old_path":"doc/user/project/settings/img/import_export_download_export.png","new_path":"doc/user/project/settings/img/import_export_download_export.png","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"Binary files a/doc/user/project/settings/img/import_export_download_export.png and b/doc/user/project/settings/img/import_export_download_export.png differ\n"},{"old_path":"doc/user/project/settings/img/import_export_export_button.png","new_path":"doc/user/project/settings/img/import_export_export_button.png","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"Binary files a/doc/user/project/settings/img/import_export_export_button.png and b/doc/user/project/settings/img/import_export_export_button.png differ\n"},{"old_path":"doc/user/project/settings/import_export.md","new_path":"doc/user/project/settings/import_export.md","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -160,6 +160,8 @@ To export a project and its data, follow these steps:\n \n 1. Select **Settings** in the sidebar.\n \n+1. Scroll down and expand the **Advanced** section.\n+\n 1. Scroll down to find the **Export project** button:\n \n    ![Export button](img/import_export_export_button.png)\n"},{"old_path":"lib/api/github/entities.rb","new_path":"lib/api/github/entities.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -59,8 +59,8 @@ class RepoCommit \u003c Grape::Entity\n         expose :parents do |commit|\n           commit.parent_ids.map { |id| { sha: id } }\n         end\n-        expose :files do |commit|\n-          commit.diffs.diff_files.flat_map do |diff|\n+        expose :files do |_commit, options|\n+          options[:diff_files].flat_map do |diff|\n             additions = diff.added_lines\n             deletions = diff.removed_lines\n \n"},{"old_path":"lib/api/v3/github.rb","new_path":"lib/api/v3/github.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -20,6 +20,9 @@ class Github \u003c ::API::Base\n       # Jira Server user agent format: Jira DVCS Connector/version\n       JIRA_DVCS_CLOUD_USER_AGENT = 'Jira DVCS Connector Vertigo'\n \n+      GITALY_TIMEOUT_CACHE_KEY = 'api:v3:Gitaly-timeout-cache-key'\n+      GITALY_TIMEOUT_CACHE_EXPIRY = 1.day\n+\n       include PaginationParams\n \n       feature_category :integrations\n@@ -93,6 +96,32 @@ def find_notes(noteable)\n           notes.select { |n| n.readable_by?(current_user) }\n         end\n         # rubocop: enable CodeReuse/ActiveRecord\n+\n+        # Returns an empty Array instead of the Commit diff files for a period\n+        # of time after a Gitaly timeout, to mitigate frequent Gitaly timeouts\n+        # for some Commit diffs.\n+        def diff_files(commit)\n+          return commit.diffs.diff_files unless Feature.enabled?(:api_v3_commits_skip_diff_files, commit.project)\n+\n+          cache_key = [\n+            GITALY_TIMEOUT_CACHE_KEY,\n+            commit.project.id,\n+            commit.cache_key\n+          ].join(':')\n+\n+          return [] if Rails.cache.read(cache_key).present?\n+\n+          begin\n+            commit.diffs.diff_files\n+          rescue GRPC::DeadlineExceeded =\u003e error\n+            # Gitaly fails to load diffs consistently for some commits. The other information\n+            # is still valuable for Jira. So we skip the loading and respond with a 200 excluding diffs\n+            # Remove this when https://gitlab.com/gitlab-org/gitaly/-/issues/3741 is fixed.\n+            Rails.cache.write(cache_key, 1, expires_in: GITALY_TIMEOUT_CACHE_EXPIRY)\n+            Gitlab::ErrorTracking.track_exception(error)\n+            []\n+          end\n+        end\n       end\n \n       resource :orgs do\n@@ -228,10 +257,9 @@ def find_notes(noteable)\n           user_project = find_project_with_access(params)\n \n           commit = user_project.commit(params[:sha])\n-\n           not_found! 'Commit' unless commit\n \n-          present commit, with: ::API::Github::Entities::RepoCommit\n+          present commit, with: ::API::Github::Entities::RepoCommit, diff_files: diff_files(commit)\n         end\n       end\n     end\n"},{"old_path":"lib/gitlab/background_migration/migrate_requirements_to_work_items.rb","new_path":"lib/gitlab/background_migration/migrate_requirements_to_work_items.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,13 @@\n+# frozen_string_literal: true\n+\n+module Gitlab\n+  module BackgroundMigration\n+    # No op on CE\n+    class MigrateRequirementsToWorkItems\n+      def perform(start_id, end_id)\n+      end\n+    end\n+  end\n+end\n+\n+Gitlab::BackgroundMigration::MigrateRequirementsToWorkItems.prepend_mod_with('Gitlab::BackgroundMigration::MigrateRequirementsToWorkItems')\n"},{"old_path":"lib/gitlab/ci/artifact_file_reader.rb","new_path":"lib/gitlab/ci/artifact_file_reader.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -45,14 +45,6 @@ def validate!\n       end\n \n       def read_zip_file!(file_path)\n-        if ::Feature.enabled?(:ci_new_artifact_file_reader, job.project, default_enabled: :yaml)\n-          read_with_new_artifact_file_reader(file_path)\n-        else\n-          read_with_legacy_artifact_file_reader(file_path)\n-        end\n-      end\n-\n-      def read_with_new_artifact_file_reader(file_path)\n         job.artifacts_file.use_open_file do |file|\n           zip_file = Zip::File.new(file, false, true)\n           entry = zip_file.find_entry(file_path)\n@@ -69,25 +61,6 @@ def read_with_new_artifact_file_reader(file_path)\n         end\n       end\n \n-      def read_with_legacy_artifact_file_reader(file_path)\n-        job.artifacts_file.use_file do |archive_path|\n-          Zip::File.open(archive_path) do |zip_file|\n-            entry = zip_file.find_entry(file_path)\n-            unless entry\n-              raise Error, \"Path `#{file_path}` does not exist inside the `#{job.name}` artifacts archive!\"\n-            end\n-\n-            if entry.name_is_directory?\n-              raise Error, \"Path `#{file_path}` was expected to be a file but it was a directory!\"\n-            end\n-\n-            zip_file.get_input_stream(entry) do |is|\n-              is.read\n-            end\n-          end\n-        end\n-      end\n-\n       def max_archive_size_in_mb\n         ActiveSupport::NumberHelper.number_to_human_size(MAX_ARCHIVE_SIZE)\n       end\n"},{"old_path":"lib/gitlab/database/gitlab_schema.rb","new_path":"lib/gitlab/database/gitlab_schema.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -8,17 +8,84 @@\n # - gitlab_shared - defines a set of tables that are found on all databases (data accessed is dependent on connection)\n # - gitlab_main / gitlab_ci - defines a set of tables that can only exist on a given database\n #\n+# Tables for the purpose of tests should be prefixed with `_test_my_table_name`\n \n module Gitlab\n   module Database\n     module GitlabSchema\n+      # These tables are deleted/renamed, but still referenced by migrations.\n+      # This is needed for now, but should be removed in the future\n+      DELETED_TABLES = {\n+        # main tables\n+        'alerts_service_data' =\u003e :gitlab_main,\n+        'analytics_devops_adoption_segment_selections' =\u003e :gitlab_main,\n+        'analytics_repository_file_commits' =\u003e :gitlab_main,\n+        'analytics_repository_file_edits' =\u003e :gitlab_main,\n+        'analytics_repository_files' =\u003e :gitlab_main,\n+        'audit_events_archived' =\u003e :gitlab_main,\n+        'backup_labels' =\u003e :gitlab_main,\n+        'clusters_applications_fluentd' =\u003e :gitlab_main,\n+        'forked_project_links' =\u003e :gitlab_main,\n+        'issue_milestones' =\u003e :gitlab_main,\n+        'merge_request_milestones' =\u003e :gitlab_main,\n+        'namespace_onboarding_actions' =\u003e :gitlab_main,\n+        'services' =\u003e :gitlab_main,\n+        'terraform_state_registry' =\u003e :gitlab_main,\n+        'tmp_fingerprint_sha256_migration' =\u003e :gitlab_main, # used by lib/gitlab/background_migration/migrate_fingerprint_sha256_within_keys.rb\n+        'web_hook_logs_archived' =\u003e :gitlab_main,\n+        'vulnerability_export_registry' =\u003e :gitlab_main,\n+        'vulnerability_finding_fingerprints' =\u003e :gitlab_main,\n+        'vulnerability_export_verification_status' =\u003e :gitlab_main,\n+\n+        # CI tables\n+        'ci_build_trace_sections' =\u003e :gitlab_ci,\n+        'ci_build_trace_section_names' =\u003e :gitlab_ci,\n+        'ci_daily_report_results' =\u003e :gitlab_ci,\n+        'ci_test_cases' =\u003e :gitlab_ci,\n+        'ci_test_case_failures' =\u003e :gitlab_ci,\n+\n+        # leftovers from early implementation of partitioning\n+        'audit_events_part_5fc467ac26' =\u003e :gitlab_main,\n+        'web_hook_logs_part_0c5294f417' =\u003e :gitlab_main\n+      }.freeze\n+\n       def self.table_schemas(tables)\n         tables.map { |table| table_schema(table) }.to_set\n       end\n \n       def self.table_schema(name)\n+        schema_name, table_name = name.split('.', 2) # Strip schema name like: `public.`\n+\n+        # Most of names do not have schemas, ensure that this is table\n+        unless table_name\n+          table_name = schema_name\n+          schema_name = nil\n+        end\n+\n+        # strip partition number of a form `loose_foreign_keys_deleted_records_1`\n+        table_name.gsub!(/_[0-9]+$/, '')\n+\n+        # Tables that are properly mapped\n+        if gitlab_schema = tables_to_schema[table_name]\n+          return gitlab_schema\n+        end\n+\n+        # Tables that are deleted, but we still need to reference them\n+        if gitlab_schema = DELETED_TABLES[table_name]\n+          return gitlab_schema\n+        end\n+\n+        # All tables from `information_schema.` are `:gitlab_shared`\n+        return :gitlab_shared if schema_name == 'information_schema'\n+\n+        # All tables that start with `_test_` are shared and ignored\n+        return :gitlab_shared if table_name.start_with?('_test_')\n+\n+        # All `pg_` tables are marked as `shared`\n+        return :gitlab_shared if table_name.start_with?('pg_')\n+\n         # When undefined it's best to return a unique name so that we don't incorrectly assume that 2 undefined schemas belong on the same database\n-        tables_to_schema[name] || :\"undefined_#{name}\"\n+        :\"undefined_#{table_name}\"\n       end\n \n       def self.tables_to_schema\n"},{"old_path":"lib/gitlab/database/load_balancing/configuration.rb","new_path":"lib/gitlab/database/load_balancing/configuration.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -77,6 +77,10 @@ def primary_connection_specification_name\n           (@primary_model || @model).connection_specification_name\n         end\n \n+        def primary_db_config\n+          (@primary_model || @model).connection_db_config\n+        end\n+\n         def replica_db_config\n           @model.connection_db_config\n         end\n"},{"old_path":"lib/gitlab/database/query_analyzer.rb","new_path":"lib/gitlab/database/query_analyzer.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,60 @@\n+# frozen_string_literal: true\n+\n+module Gitlab\n+  module Database\n+    # The purpose of this class is to implement a various query analyzers based on `pg_query`\n+    # And process them all via `Gitlab::Database::QueryAnalyzers::*`\n+    class QueryAnalyzer\n+      ANALYZERS = [].freeze\n+\n+      Parsed = Struct.new(\n+        :sql, :connection, :pg\n+      )\n+\n+      def hook!\n+        @subscriber = ActiveSupport::Notifications.subscribe('sql.active_record') do |event|\n+          process_sql(event.payload[:sql], event.payload[:connection])\n+        end\n+      end\n+\n+      private\n+\n+      def process_sql(sql, connection)\n+        analyzers = enabled_analyzers(connection)\n+        return unless analyzers.any?\n+\n+        parsed = parse(sql, connection)\n+        return unless parsed\n+\n+        analyzers.each do |analyzer|\n+          analyzer.analyze(parsed)\n+        rescue =\u003e e # rubocop:disable Style/RescueStandardError\n+          # We catch all standard errors to prevent validation errors to introduce fatal errors in production\n+          Gitlab::ErrorTracking.track_and_raise_for_dev_exception(e)\n+        end\n+      end\n+\n+      def enabled_analyzers(connection)\n+        ANALYZERS.select do |analyzer|\n+          analyzer.enabled?(connection)\n+        rescue StandardError =\u003e e # rubocop:disable Style/RescueStandardError\n+          # We catch all standard errors to prevent validation errors to introduce fatal errors in production\n+          Gitlab::ErrorTracking.track_and_raise_for_dev_exception(e)\n+        end\n+      end\n+\n+      def parse(sql, connection)\n+        parsed = PgQuery.parse(sql)\n+        return unless parsed\n+\n+        normalized = PgQuery.normalize(sql)\n+        Parsed.new(normalized, connection, parsed)\n+      rescue PgQuery::ParseError =\u003e e\n+        # Ignore PgQuery parse errors (due to depth limit or other reasons)\n+        Gitlab::ErrorTracking.track_exception(e)\n+\n+        nil\n+      end\n+    end\n+  end\n+end\n"},{"old_path":"lib/gitlab/database/query_analyzers/base.rb","new_path":"lib/gitlab/database/query_analyzers/base.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,17 @@\n+# frozen_string_literal: true\n+\n+module Gitlab\n+  module Database\n+    module QueryAnalyzers\n+      class Base\n+        def self.enabled?(connection)\n+          raise NotImplementedError\n+        end\n+\n+        def self.analyze(parsed)\n+          raise NotImplementedError\n+        end\n+      end\n+    end\n+  end\n+end\n"},{"old_path":"lib/gitlab/graphql/known_operations.rb","new_path":"lib/gitlab/graphql/known_operations.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,40 @@\n+# frozen_string_literal: true\n+\n+module Gitlab\n+  module Graphql\n+    class KnownOperations\n+      Operation = Struct.new(:name) do\n+        def to_caller_id\n+          \"graphql:#{name}\"\n+        end\n+      end\n+\n+      ANONYMOUS = Operation.new(\"anonymous\").freeze\n+      UNKNOWN = Operation.new(\"unknown\").freeze\n+\n+      def self.default\n+        @default ||= self.new(Gitlab::Webpack::GraphqlKnownOperations.load)\n+      end\n+\n+      def initialize(operation_names)\n+        @operation_hash = operation_names\n+          .map { |name| Operation.new(name).freeze }\n+          .concat([ANONYMOUS, UNKNOWN])\n+          .index_by(\u0026:name)\n+      end\n+\n+      # Returns the known operation from the given ::GraphQL::Query object\n+      def from_query(query)\n+        operation_name = query.selected_operation_name\n+\n+        return ANONYMOUS unless operation_name\n+\n+        @operation_hash[operation_name] || UNKNOWN\n+      end\n+\n+      def operations\n+        @operation_hash.values\n+      end\n+    end\n+  end\n+end\n"},{"old_path":"lib/gitlab/sidekiq_config.rb","new_path":"lib/gitlab/sidekiq_config.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -6,11 +6,13 @@ module Gitlab\n   module SidekiqConfig\n     FOSS_QUEUE_CONFIG_PATH = 'app/workers/all_queues.yml'\n     EE_QUEUE_CONFIG_PATH = 'ee/app/workers/all_queues.yml'\n+    JH_QUEUE_CONFIG_PATH = 'jh/app/workers/all_queues.yml'\n     SIDEKIQ_QUEUES_PATH = 'config/sidekiq_queues.yml'\n \n     QUEUE_CONFIG_PATHS = [\n       FOSS_QUEUE_CONFIG_PATH,\n-      (EE_QUEUE_CONFIG_PATH if Gitlab.ee?)\n+      (EE_QUEUE_CONFIG_PATH if Gitlab.ee?),\n+      (JH_QUEUE_CONFIG_PATH if Gitlab.jh?)\n     ].compact.freeze\n \n     # This maps workers not in our application code to queues. We need\n@@ -33,7 +35,7 @@ module SidekiqConfig\n         weight: 2,\n         tags: []\n       )\n-    }.transform_values { |worker| Gitlab::SidekiqConfig::Worker.new(worker, ee: false) }.freeze\n+    }.transform_values { |worker| Gitlab::SidekiqConfig::Worker.new(worker, ee: false, jh: false) }.freeze\n \n     class \u003c\u003c self\n       include Gitlab::SidekiqConfig::CliMethods\n@@ -58,10 +60,14 @@ def workers\n         @workers ||= begin\n           result = []\n           result.concat(DEFAULT_WORKERS.values)\n-          result.concat(find_workers(Rails.root.join('app', 'workers'), ee: false))\n+          result.concat(find_workers(Rails.root.join('app', 'workers'), ee: false, jh: false))\n \n           if Gitlab.ee?\n-            result.concat(find_workers(Rails.root.join('ee', 'app', 'workers'), ee: true))\n+            result.concat(find_workers(Rails.root.join('ee', 'app', 'workers'), ee: true, jh: false))\n+          end\n+\n+          if Gitlab.jh?\n+            result.concat(find_workers(Rails.root.join('jh', 'app', 'workers'), ee: false, jh: true))\n           end\n \n           result\n@@ -69,16 +75,26 @@ def workers\n       end\n \n       def workers_for_all_queues_yml\n-        workers.partition(\u0026:ee?).reverse.map(\u0026:sort)\n+        workers.each_with_object([[], [], []]) do |worker, array|\n+          if worker.jh?\n+            array[2].push(worker)\n+          elsif worker.ee?\n+            array[1].push(worker)\n+          else\n+            array[0].push(worker)\n+          end\n+        end.map(\u0026:sort)\n       end\n \n       # YAML.load_file is OK here as we control the file contents\n       def all_queues_yml_outdated?\n-        foss_workers, ee_workers = workers_for_all_queues_yml\n+        foss_workers, ee_workers, jh_workers = workers_for_all_queues_yml\n \n         return true if foss_workers != YAML.load_file(FOSS_QUEUE_CONFIG_PATH)\n \n-        Gitlab.ee? \u0026\u0026 ee_workers != YAML.load_file(EE_QUEUE_CONFIG_PATH)\n+        return true if Gitlab.ee? \u0026\u0026 ee_workers != YAML.load_file(EE_QUEUE_CONFIG_PATH)\n+\n+        Gitlab.jh? \u0026\u0026 File.exist?(JH_QUEUE_CONFIG_PATH) \u0026\u0026 jh_workers != YAML.load_file(JH_QUEUE_CONFIG_PATH)\n       end\n \n       def queues_for_sidekiq_queues_yml\n@@ -120,14 +136,14 @@ def current_worker_queue_mappings\n \n       private\n \n-      def find_workers(root, ee:)\n+      def find_workers(root, ee:, jh:)\n         concerns = root.join('concerns').to_s\n \n         Dir[root.join('**', '*.rb')]\n           .reject { |path| path.start_with?(concerns) }\n           .map { |path| worker_from_path(path, root) }\n           .select { |worker| worker \u003c Sidekiq::Worker }\n-          .map { |worker| Gitlab::SidekiqConfig::Worker.new(worker, ee: ee) }\n+          .map { |worker| Gitlab::SidekiqConfig::Worker.new(worker, ee: ee, jh: jh) }\n       end\n \n       def worker_from_path(path, root)\n"},{"old_path":"lib/gitlab/sidekiq_config/cli_methods.rb","new_path":"lib/gitlab/sidekiq_config/cli_methods.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -18,6 +18,7 @@ module CliMethods\n       QUEUE_CONFIG_PATHS = begin\n         result = %w[app/workers/all_queues.yml]\n         result \u003c\u003c 'ee/app/workers/all_queues.yml' if Gitlab.ee?\n+        result \u003c\u003c 'jh/app/workers/all_queues.yml' if Gitlab.jh?\n         result\n       end.freeze\n \n"},{"old_path":"lib/gitlab/sidekiq_config/worker.rb","new_path":"lib/gitlab/sidekiq_config/worker.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -13,15 +13,20 @@ class Worker\n                :worker_has_external_dependencies?,\n                to: :klass\n \n-      def initialize(klass, ee:)\n+      def initialize(klass, ee:, jh: false)\n         @klass = klass\n         @ee = ee\n+        @jh = jh\n       end\n \n       def ee?\n         @ee\n       end\n \n+      def jh?\n+        @jh\n+      end\n+\n       def ==(other)\n         to_yaml == case other\n                    when self.class\n"},{"old_path":"lib/gitlab/webpack/file_loader.rb","new_path":"lib/gitlab/webpack/file_loader.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,65 @@\n+# frozen_string_literal: true\n+\n+require 'net/http'\n+require 'uri'\n+\n+module Gitlab\n+  module Webpack\n+    class FileLoader\n+      class BaseError \u003c StandardError\n+        attr_reader :original_error, :uri\n+\n+        def initialize(uri, orig)\n+          super orig.message\n+          @uri = uri.to_s\n+          @original_error = orig\n+        end\n+      end\n+\n+      StaticLoadError = Class.new(BaseError)\n+      DevServerLoadError = Class.new(BaseError)\n+      DevServerSSLError = Class.new(BaseError)\n+\n+      def self.load(path)\n+        if Gitlab.config.webpack.dev_server.enabled\n+          self.load_from_dev_server(path)\n+        else\n+          self.load_from_static(path)\n+        end\n+      end\n+\n+      def self.load_from_dev_server(path)\n+        host = Gitlab.config.webpack.dev_server.host\n+        port = Gitlab.config.webpack.dev_server.port\n+        scheme = Gitlab.config.webpack.dev_server.https ? 'https' : 'http'\n+        uri = Addressable::URI.new(scheme: scheme, host: host, port: port, path: self.dev_server_path(path))\n+\n+        # localhost could be blocked via Gitlab::HTTP\n+        response = HTTParty.get(uri.to_s, verify: false) # rubocop:disable Gitlab/HTTParty\n+\n+        return response.body if response.code == 200\n+\n+        raise \"HTTP error #{response.code}\"\n+      rescue OpenSSL::SSL::SSLError, EOFError =\u003e e\n+        raise DevServerSSLError.new(uri, e)\n+      rescue StandardError =\u003e e\n+        raise DevServerLoadError.new(uri, e)\n+      end\n+\n+      def self.load_from_static(path)\n+        file_uri = ::Rails.root.join(\n+          Gitlab.config.webpack.output_dir,\n+          path\n+        )\n+\n+        File.read(file_uri)\n+      rescue StandardError =\u003e e\n+        raise StaticLoadError.new(file_uri, e)\n+      end\n+\n+      def self.dev_server_path(path)\n+        \"/#{Gitlab.config.webpack.public_path}/#{path}\"\n+      end\n+    end\n+  end\n+end\n"},{"old_path":"lib/gitlab/webpack/graphql_known_operations.rb","new_path":"lib/gitlab/webpack/graphql_known_operations.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,25 @@\n+# frozen_string_literal: true\n+\n+module Gitlab\n+  module Webpack\n+    class GraphqlKnownOperations\n+      class \u003c\u003c self\n+        include Gitlab::Utils::StrongMemoize\n+\n+        def clear_memoization!\n+          clear_memoization(:graphql_known_operations)\n+        end\n+\n+        def load\n+          strong_memoize(:graphql_known_operations) do\n+            data = ::Gitlab::Webpack::FileLoader.load(\"graphql_known_operations.yml\")\n+\n+            YAML.safe_load(data)\n+          rescue StandardError\n+            []\n+          end\n+        end\n+      end\n+    end\n+  end\n+end\n"},{"old_path":"lib/gitlab/webpack/manifest.rb","new_path":"lib/gitlab/webpack/manifest.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -1,8 +1,5 @@\n # frozen_string_literal: true\n \n-require 'net/http'\n-require 'uri'\n-\n module Gitlab\n   module Webpack\n     class Manifest\n@@ -78,49 +75,16 @@ def manifest\n         end\n \n         def load_manifest\n-          data = if Gitlab.config.webpack.dev_server.enabled\n-                   load_dev_server_manifest\n-                 else\n-                   load_static_manifest\n-                 end\n+          data = Gitlab::Webpack::FileLoader.load(Gitlab.config.webpack.manifest_filename)\n \n           Gitlab::Json.parse(data)\n-        end\n-\n-        def load_dev_server_manifest\n-          host = Gitlab.config.webpack.dev_server.host\n-          port = Gitlab.config.webpack.dev_server.port\n-          scheme = Gitlab.config.webpack.dev_server.https ? 'https' : 'http'\n-          uri = Addressable::URI.new(scheme: scheme, host: host, port: port, path: dev_server_path)\n-\n-          # localhost could be blocked via Gitlab::HTTP\n-          response = HTTParty.get(uri.to_s, verify: false) # rubocop:disable Gitlab/HTTParty\n-\n-          return response.body if response.code == 200\n-\n-          raise \"HTTP error #{response.code}\"\n-        rescue OpenSSL::SSL::SSLError, EOFError =\u003e e\n+        rescue Gitlab::Webpack::FileLoader::StaticLoadError =\u003e e\n+          raise ManifestLoadError.new(\"Could not load compiled manifest from #{e.uri}.\\n\\nHave you run `rake gitlab:assets:compile`?\", e.original_error)\n+        rescue Gitlab::Webpack::FileLoader::DevServerSSLError =\u003e e\n           ssl_status = Gitlab.config.webpack.dev_server.https ? ' over SSL' : ''\n-          raise ManifestLoadError.new(\"Could not connect to webpack-dev-server at #{uri}#{ssl_status}.\\n\\nIs SSL enabled? Check that settings in `gitlab.yml` and webpack-dev-server match.\", e)\n-        rescue StandardError =\u003e e\n-          raise ManifestLoadError.new(\"Could not load manifest from webpack-dev-server at #{uri}.\\n\\nIs webpack-dev-server running? Try running `gdk status webpack` or `gdk tail webpack`.\", e)\n-        end\n-\n-        def load_static_manifest\n-          File.read(static_manifest_path)\n-        rescue StandardError =\u003e e\n-          raise ManifestLoadError.new(\"Could not load compiled manifest from #{static_manifest_path}.\\n\\nHave you run `rake gitlab:assets:compile`?\", e)\n-        end\n-\n-        def static_manifest_path\n-          ::Rails.root.join(\n-            Gitlab.config.webpack.output_dir,\n-            Gitlab.config.webpack.manifest_filename\n-          )\n-        end\n-\n-        def dev_server_path\n-          \"/#{Gitlab.config.webpack.public_path}/#{Gitlab.config.webpack.manifest_filename}\"\n+          raise ManifestLoadError.new(\"Could not connect to webpack-dev-server at #{e.uri}#{ssl_status}.\\n\\nIs SSL enabled? Check that settings in `gitlab.yml` and webpack-dev-server match.\", e.original_error)\n+        rescue Gitlab::Webpack::FileLoader::DevServerLoadError =\u003e e\n+          raise ManifestLoadError.new(\"Could not load manifest from webpack-dev-server at #{e.uri}.\\n\\nIs webpack-dev-server running? Try running `gdk status webpack` or `gdk tail webpack`.\", e.original_error)\n         end\n       end\n     end\n"},{"old_path":"lib/sidebars/projects/menus/infrastructure_menu.rb","new_path":"lib/sidebars/projects/menus/infrastructure_menu.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -100,7 +100,7 @@ def google_cloud_menu_item\n           ::Sidebars::MenuItem.new(\n             title: _('Google Cloud'),\n             link: project_google_cloud_index_path(context.project),\n-            active_routes: {},\n+            active_routes: { controller: :google_cloud },\n             item_id: :google_cloud\n           )\n         end\n"},{"old_path":"lib/tasks/gitlab/sidekiq.rake","new_path":"lib/tasks/gitlab/sidekiq.rake","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -36,13 +36,17 @@ namespace :gitlab do\n           # Do not edit it manually!\n         BANNER\n \n-        foss_workers, ee_workers = Gitlab::SidekiqConfig.workers_for_all_queues_yml\n+        foss_workers, ee_workers, jh_workers = Gitlab::SidekiqConfig.workers_for_all_queues_yml\n \n         write_yaml(Gitlab::SidekiqConfig::FOSS_QUEUE_CONFIG_PATH, banner, foss_workers)\n \n         if Gitlab.ee?\n           write_yaml(Gitlab::SidekiqConfig::EE_QUEUE_CONFIG_PATH, banner, ee_workers)\n         end\n+\n+        if Gitlab.jh?\n+          write_yaml(Gitlab::SidekiqConfig::JH_QUEUE_CONFIG_PATH, banner, jh_workers)\n+        end\n       end\n \n       desc 'GitLab | Sidekiq | Validate that all_queues.yml matches worker definitions'\n@@ -57,6 +61,7 @@ namespace :gitlab do\n \n             - #{Gitlab::SidekiqConfig::FOSS_QUEUE_CONFIG_PATH}\n             - #{Gitlab::SidekiqConfig::EE_QUEUE_CONFIG_PATH}\n+            #{\"- \" + Gitlab::SidekiqConfig::JH_QUEUE_CONFIG_PATH if Gitlab.jh?}\n \n           MSG\n         end\n"},{"old_path":"locale/gitlab.pot","new_path":"locale/gitlab.pot","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -1107,9 +1107,6 @@ msgstr \"\"\n msgid \"(check progress)\"\n msgstr \"\"\n \n-msgid \"(commits will be squashed)\"\n-msgstr \"\"\n-\n msgid \"(deleted)\"\n msgstr \"\"\n \n@@ -1128,6 +1125,11 @@ msgstr \"\"\n msgid \"(revoked)\"\n msgstr \"\"\n \n+msgid \"(squashes %d commit)\"\n+msgid_plural \"(squashes %d commits)\"\n+msgstr[0] \"\"\n+msgstr[1] \"\"\n+\n msgid \"(this user)\"\n msgstr \"\"\n \n@@ -4037,6 +4039,9 @@ msgid_plural \"ApplicationSettings|Approve %d users\"\n msgstr[0] \"\"\n msgstr[1] \"\"\n \n+msgid \"ApplicationSettings|Approve users\"\n+msgstr \"\"\n+\n msgid \"ApplicationSettings|Approve users in the pending approval status?\"\n msgstr \"\"\n \n@@ -4045,6 +4050,9 @@ msgid_plural \"ApplicationSettings|By making this change, you will automatically\n msgstr[0] \"\"\n msgstr[1] \"\"\n \n+msgid \"ApplicationSettings|By making this change, you will automatically approve all users in pending approval status.\"\n+msgstr \"\"\n+\n msgid \"ApplicationSettings|Denied domains for sign-ups\"\n msgstr \"\"\n \n@@ -6547,6 +6555,9 @@ msgstr \"\"\n msgid \"Changes to the title have not been saved\"\n msgstr \"\"\n \n+msgid \"Changing any setting here requires an application restart\"\n+msgstr \"\"\n+\n msgid \"Changing group URL can have unintended side effects.\"\n msgstr \"\"\n \n@@ -7190,6 +7201,9 @@ msgstr \"\"\n msgid \"Clients\"\n msgstr \"\"\n \n+msgid \"Clientside DSN\"\n+msgstr \"\"\n+\n msgid \"Clone\"\n msgstr \"\"\n \n@@ -8683,6 +8697,9 @@ msgstr \"\"\n msgid \"Configure Secret Detection in `.gitlab-ci.yml`, creating this file if it does not already exist\"\n msgstr \"\"\n \n+msgid \"Configure Sentry integration for error tracking\"\n+msgstr \"\"\n+\n msgid \"Configure Tracing\"\n msgstr \"\"\n \n@@ -10391,6 +10408,9 @@ msgstr \"\"\n msgid \"DORA4Metrics|The chart displays the median time between a merge request being merged and deployed to production environment(s) that are based on the %{linkStart}deployment_tier%{linkEnd} value.\"\n msgstr \"\"\n \n+msgid \"DSN\"\n+msgstr \"\"\n+\n msgid \"Dashboard\"\n msgstr \"\"\n \n@@ -11158,6 +11178,12 @@ msgstr \"\"\n msgid \"Deleted projects cannot be restored!\"\n msgstr \"\"\n \n+msgid \"Deletes the source branch\"\n+msgstr \"\"\n+\n+msgid \"Deletes the source branch.\"\n+msgstr \"\"\n+\n msgid \"Deleting\"\n msgstr \"\"\n \n@@ -12208,6 +12234,9 @@ msgstr \"\"\n msgid \"Does not apply to projects in personal namespaces, which are deleted immediately on request.\"\n msgstr \"\"\n \n+msgid \"Does not delete the source branch.\"\n+msgstr \"\"\n+\n msgid \"Domain\"\n msgstr \"\"\n \n@@ -12703,6 +12732,9 @@ msgstr \"\"\n msgid \"Enable SSL verification\"\n msgstr \"\"\n \n+msgid \"Enable Sentry error tracking\"\n+msgstr \"\"\n+\n msgid \"Enable Service Ping\"\n msgstr \"\"\n \n@@ -16109,6 +16141,9 @@ msgstr \"\"\n msgid \"GraphViewType|Stage\"\n msgstr \"\"\n \n+msgid \"Graphs\"\n+msgstr \"\"\n+\n msgid \"Gravatar\"\n msgstr \"\"\n \n@@ -29691,6 +29726,9 @@ msgstr \"\"\n msgid \"Runners|New runner, has not connected yet\"\n msgstr \"\"\n \n+msgid \"Runners|No recent contact from this runner; last contact was %{timeAgo}\"\n+msgstr \"\"\n+\n msgid \"Runners|Not available to run jobs\"\n msgstr \"\"\n \n@@ -29742,6 +29780,9 @@ msgstr \"\"\n msgid \"Runners|Runner #%{runner_id}\"\n msgstr \"\"\n \n+msgid \"Runners|Runner ID\"\n+msgstr \"\"\n+\n msgid \"Runners|Runner assigned to project.\"\n msgstr \"\"\n \n@@ -29751,6 +29792,9 @@ msgstr \"\"\n msgid \"Runners|Runner is online, last contact was %{runner_contact} ago\"\n msgstr \"\"\n \n+msgid \"Runners|Runner is online; last contact was %{timeAgo}\"\n+msgstr \"\"\n+\n msgid \"Runners|Runner is paused, last contact was %{runner_contact} ago\"\n msgstr \"\"\n \n@@ -29781,12 +29825,18 @@ msgstr \"\"\n msgid \"Runners|Something went wrong while fetching the tags suggestions\"\n msgstr \"\"\n \n+msgid \"Runners|Status\"\n+msgstr \"\"\n+\n msgid \"Runners|Stop the runner from accepting new jobs.\"\n msgstr \"\"\n \n msgid \"Runners|Tags\"\n msgstr \"\"\n \n+msgid \"Runners|This runner has never connected to this instance\"\n+msgstr \"\"\n+\n msgid \"Runners|This runner is associated with one or more projects.\"\n msgstr \"\"\n \n@@ -29853,6 +29903,15 @@ msgstr \"\"\n msgid \"Runners|locked\"\n msgstr \"\"\n \n+msgid \"Runners|not connected\"\n+msgstr \"\"\n+\n+msgid \"Runners|offline\"\n+msgstr \"\"\n+\n+msgid \"Runners|online\"\n+msgstr \"\"\n+\n msgid \"Runners|paused\"\n msgstr \"\"\n \n@@ -32473,12 +32532,6 @@ msgstr \"\"\n msgid \"Source branch\"\n msgstr \"\"\n \n-msgid \"Source branch will be deleted.\"\n-msgstr \"\"\n-\n-msgid \"Source branch will not be deleted.\"\n-msgstr \"\"\n-\n msgid \"Source branch: %{source_branch_open}%{source_branch}%{source_branch_close}\"\n msgstr \"\"\n \n@@ -34136,7 +34189,7 @@ msgstr \"\"\n msgid \"The connection will time out after %{timeout}. For repositories that take longer, use a clone/push combination.\"\n msgstr \"\"\n \n-msgid \"The contact does not belong to the same group as the issue.\"\n+msgid \"The contact does not belong to the same group as the issue\"\n msgstr \"\"\n \n msgid \"The content of this page is not encoded in UTF-8. Edits can only be made via the Git repository.\"\n@@ -34474,9 +34527,6 @@ msgstr \"\"\n msgid \"The snippet is visible to any logged in user except external users.\"\n msgstr \"\"\n \n-msgid \"The source branch will be deleted\"\n-msgstr \"\"\n-\n msgid \"The specified tab is invalid, please select another\"\n msgstr \"\"\n \n@@ -40986,13 +41036,13 @@ msgstr \"\"\n msgid \"most recent deployment\"\n msgstr \"\"\n \n-msgid \"mrWidgetCommitsAdded|%{commitCount} and %{mergeCommitCount} will be added to %{targetBranch}%{squashedCommits}.\"\n+msgid \"mrWidgetCommitsAdded|1 merge commit\"\n msgstr \"\"\n \n-msgid \"mrWidgetCommitsAdded|%{commitCount} will be added to %{targetBranch}.\"\n+msgid \"mrWidgetCommitsAdded|Adds %{commitCount} and %{mergeCommitCount} to %{targetBranch}%{squashedCommits}.\"\n msgstr \"\"\n \n-msgid \"mrWidgetCommitsAdded|1 merge commit\"\n+msgid \"mrWidgetCommitsAdded|Adds %{commitCount} to %{targetBranch}.\"\n msgstr \"\"\n \n msgid \"mrWidgetNothingToMerge|This merge request contains no changes.\"\n@@ -41102,6 +41152,9 @@ msgstr \"\"\n msgid \"mrWidget|Delete source branch\"\n msgstr \"\"\n \n+msgid \"mrWidget|Deletes the source branch\"\n+msgstr \"\"\n+\n msgid \"mrWidget|Deployment statistics are not available currently\"\n msgstr \"\"\n \n@@ -41111,6 +41164,9 @@ msgstr \"\"\n msgid \"mrWidget|Dismiss\"\n msgstr \"\"\n \n+msgid \"mrWidget|Does not delete the source branch\"\n+msgstr \"\"\n+\n msgid \"mrWidget|Email patches\"\n msgstr \"\"\n \n@@ -41167,6 +41223,9 @@ msgstr \"\"\n msgid \"mrWidget|Merged by\"\n msgstr \"\"\n \n+msgid \"mrWidget|Merges changes into\"\n+msgstr \"\"\n+\n msgid \"mrWidget|Merging! Changes are being shipped…\"\n msgstr \"\"\n \n@@ -41251,9 +41310,6 @@ msgstr \"\"\n msgid \"mrWidget|The changes were not merged into\"\n msgstr \"\"\n \n-msgid \"mrWidget|The changes will be merged into\"\n-msgstr \"\"\n-\n msgid \"mrWidget|The pipeline for this merge request did not complete. Push a new commit to fix the failure, or check the %{linkStart}troubleshooting documentation%{linkEnd} to see other possible actions.\"\n msgstr \"\"\n \n@@ -41269,12 +41325,6 @@ msgstr \"\"\n msgid \"mrWidget|The source branch is being deleted\"\n msgstr \"\"\n \n-msgid \"mrWidget|The source branch will be deleted\"\n-msgstr \"\"\n-\n-msgid \"mrWidget|The source branch will not be deleted\"\n-msgstr \"\"\n-\n msgid \"mrWidget|There are merge conflicts\"\n msgstr \"\"\n \n"},{"old_path":"qa/Gemfile.lock","new_path":"qa/Gemfile.lock","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -227,10 +227,10 @@ GEM\n     watir (6.19.1)\n       regexp_parser (\u003e= 1.2, \u003c 3)\n       selenium-webdriver (\u003e= 3.142.7)\n-    webdrivers (4.7.0)\n+    webdrivers (5.0.0)\n       nokogiri (~\u003e 1.6)\n       rubyzip (\u003e= 1.3.0)\n-      selenium-webdriver (\u003e 3.141, \u003c 5.0)\n+      selenium-webdriver (~\u003e 4.0)\n     xpath (3.2.0)\n       nokogiri (~\u003e 1.8)\n     zeitwerk (2.4.2)\n@@ -263,10 +263,10 @@ DEPENDENCIES\n   rspec-retry (~\u003e 0.6.1)\n   rspec_junit_formatter (~\u003e 0.4.1)\n   ruby-debug-ide (~\u003e 0.7.0)\n-  selenium-webdriver (~\u003e 4.0.0.rc1)\n+  selenium-webdriver (~\u003e 4.0)\n   timecop (~\u003e 0.9.1)\n-  webdrivers (~\u003e 4.6)\n+  webdrivers (~\u003e 5.0)\n   zeitwerk (~\u003e 2.4)\n \n BUNDLED WITH\n-   2.2.29\n+   2.2.30\n"},{"old_path":"qa/qa/page/group/settings/package_registries.rb","new_path":"qa/qa/page/group/settings/package_registries.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -1,5 +1,4 @@\n # frozen_string_literal: true\n-\n module QA\n   module Page\n     module Group\n@@ -20,22 +19,33 @@ class PackageRegistries \u003c QA::Page::Base\n \n           def set_allow_duplicates_disabled\n             expand_content :package_registry_settings_content do\n-              click_element(:allow_duplicates_toggle) if duplicates_enabled?\n+              click_on_allow_duplicates_button if duplicates_enabled?\n             end\n           end\n \n           def set_allow_duplicates_enabled\n             expand_content :package_registry_settings_content do\n-              click_element(:allow_duplicates_toggle) if duplicates_disabled?\n+              click_on_allow_duplicates_button unless duplicates_enabled?\n+            end\n+          end\n+\n+          def click_on_allow_duplicates_button\n+            with_allow_duplicates_button do |button|\n+              button.click\n             end\n           end\n \n           def duplicates_enabled?\n-            has_element?(:allow_duplicates_label, text: 'Allow duplicates')\n+            with_allow_duplicates_button do |button|\n+              button[:class].include?('is-checked')\n+            end\n           end\n \n-          def duplicates_disabled?\n-            has_element?(:allow_duplicates_label, text: 'Do not allow duplicates')\n+          def with_allow_duplicates_button\n+            within_element :allow_duplicates_toggle do\n+              toggle = find('button.gl-toggle')\n+              yield(toggle)\n+            end\n           end\n \n           def has_dependency_proxy_enabled?\n"},{"old_path":"qa/qa/specs/features/browser_ui/1_manage/login/maintain_log_in_mixed_env_spec.rb","new_path":"qa/qa/specs/features/browser_ui/1_manage/login/maintain_log_in_mixed_env_spec.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -1,7 +1,7 @@\n # frozen_string_literal: true\n \n module QA\n-  RSpec.describe 'Manage', :mixed_env, :smoke, only: { subdomain: :staging } do\n+  RSpec.describe 'Manage', only: { subdomain: :staging }, quarantine: { issue: 'https://gitlab.com/gitlab-org/gitlab/-/issues/344213', type: :stale } do\n     describe 'basic user' do\n       it 'remains logged in when redirected from canary to non-canary node', testcase: 'https://gitlab.com/gitlab-org/quality/testcases/-/quality/test_cases/2251' do\n         Runtime::Browser.visit(:gitlab, Page::Main::Login)\n"},{"old_path":"scripts/rspec_helpers.sh","new_path":"scripts/rspec_helpers.sh","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -166,6 +166,7 @@ function rspec_paralellized_job() {\n     export SUITE_FLAKY_RSPEC_REPORT_PATH=\"${FLAKY_RSPEC_SUITE_REPORT_PATH}\"\n     export FLAKY_RSPEC_REPORT_PATH=\"rspec_flaky/all_${report_name}_report.json\"\n     export NEW_FLAKY_RSPEC_REPORT_PATH=\"rspec_flaky/new_${report_name}_report.json\"\n+    export SKIPPED_FLAKY_TESTS_REPORT_PATH=\"rspec_flaky/skipped_flaky_tests_${report_name}_report.txt\"\n \n     if [[ ! -f $FLAKY_RSPEC_REPORT_PATH ]]; then\n       echo \"{}\" \u003e \"${FLAKY_RSPEC_REPORT_PATH}\"\n"},{"old_path":"lib/gitlab/sidekiq_cluster/cli.rb","new_path":"sidekiq_cluster/cli.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":true,"deleted_file":false,"diff":"@@ -4,27 +4,21 @@\n require 'logger'\n require 'time'\n \n+# In environments where code is preloaded and cached such as `spring`,\n+# we may run into \"already initialized\" warnings, hence the check.\n+require_relative '../lib/gitlab' unless Object.const_defined?('Gitlab')\n+require_relative '../lib/gitlab/utils'\n+require_relative '../lib/gitlab/sidekiq_config/cli_methods'\n+require_relative '../lib/gitlab/sidekiq_config/worker_matcher'\n+require_relative '../lib/gitlab/sidekiq_logging/json_formatter'\n+require_relative 'sidekiq_cluster'\n+\n module Gitlab\n   module SidekiqCluster\n     class CLI\n-      CHECK_TERMINATE_INTERVAL_SECONDS = 1\n-\n-      # How long to wait when asking for a clean termination.\n-      # It maps the Sidekiq default timeout:\n-      # https://github.com/mperham/sidekiq/wiki/Signals#term\n-      #\n-      # This value is passed to Sidekiq's `-t` if none\n-      # is given through arguments.\n-      DEFAULT_SOFT_TIMEOUT_SECONDS = 25\n-\n-      # After surpassing the soft timeout.\n-      DEFAULT_HARD_TIMEOUT_SECONDS = 5\n-\n       CommandError = Class.new(StandardError)\n \n       def initialize(log_output = $stderr)\n-        require_relative '../../../lib/gitlab/sidekiq_logging/json_formatter'\n-\n         # As recommended by https://github.com/mperham/sidekiq/wiki/Advanced-Options#concurrency\n         @max_concurrency = 50\n         @min_concurrency = 0\n"},{"old_path":"sidekiq_cluster/dependencies.rb","new_path":"sidekiq_cluster/dependencies.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,6 @@\n+# rubocop:disable Naming/FileName\n+# frozen_string_literal: true\n+\n+require 'shellwords'\n+\n+# rubocop:enable Naming/FileName\n"},{"old_path":"lib/gitlab/sidekiq_cluster.rb","new_path":"sidekiq_cluster/sidekiq_cluster.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":true,"deleted_file":false,"diff":"@@ -1,9 +1,22 @@\n # frozen_string_literal: true\n \n-require 'shellwords'\n+require_relative 'dependencies'\n \n module Gitlab\n   module SidekiqCluster\n+    CHECK_TERMINATE_INTERVAL_SECONDS = 1\n+\n+    # How long to wait when asking for a clean termination.\n+    # It maps the Sidekiq default timeout:\n+    # https://github.com/mperham/sidekiq/wiki/Signals#term\n+    #\n+    # This value is passed to Sidekiq's `-t` if none\n+    # is given through arguments.\n+    DEFAULT_SOFT_TIMEOUT_SECONDS = 25\n+\n+    # After surpassing the soft timeout.\n+    DEFAULT_HARD_TIMEOUT_SECONDS = 5\n+\n     # The signals that should terminate both the master and workers.\n     TERMINATE_SIGNALS = %i(INT TERM).freeze\n \n@@ -62,7 +75,7 @@ def self.signal_processes(pids, signal)\n     # directory - The directory of the Rails application.\n     #\n     # Returns an Array containing the PIDs of the started processes.\n-    def self.start(queues, env: :development, directory: Dir.pwd, max_concurrency: 50, min_concurrency: 0, timeout: CLI::DEFAULT_SOFT_TIMEOUT_SECONDS, dryrun: false)\n+    def self.start(queues, env: :development, directory: Dir.pwd, max_concurrency: 50, min_concurrency: 0, timeout: DEFAULT_SOFT_TIMEOUT_SECONDS, dryrun: false)\n       queues.map.with_index do |pair, index|\n         start_sidekiq(pair, env: env,\n                             directory: directory,\n"},{"old_path":"spec/lib/gitlab/sidekiq_cluster/cli_spec.rb","new_path":"spec/commands/sidekiq_cluster/cli_spec.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":true,"deleted_file":false,"diff":"@@ -3,9 +3,11 @@\n require 'fast_spec_helper'\n require 'rspec-parameterized'\n \n-RSpec.describe Gitlab::SidekiqCluster::CLI do\n+require_relative '../../../sidekiq_cluster/cli'\n+\n+RSpec.describe Gitlab::SidekiqCluster::CLI do # rubocop:disable RSpec/FilePath\n   let(:cli) { described_class.new('/dev/null') }\n-  let(:timeout) { described_class::DEFAULT_SOFT_TIMEOUT_SECONDS }\n+  let(:timeout) { Gitlab::SidekiqCluster::DEFAULT_SOFT_TIMEOUT_SECONDS }\n   let(:default_options) do\n     { env: 'test', directory: Dir.pwd, max_concurrency: 50, min_concurrency: 0, dryrun: false, timeout: timeout }\n   end\n@@ -103,7 +105,7 @@\n \n         it 'when not given', 'starts Sidekiq workers with default timeout' do\n           expect(Gitlab::SidekiqCluster).to receive(:start)\n-            .with([['foo']], default_options.merge(timeout: described_class::DEFAULT_SOFT_TIMEOUT_SECONDS))\n+            .with([['foo']], default_options.merge(timeout: Gitlab::SidekiqCluster::DEFAULT_SOFT_TIMEOUT_SECONDS))\n \n           cli.run(%w(foo))\n         end\n@@ -271,7 +273,7 @@\n       expect(Gitlab::SidekiqCluster).to receive(:signal_processes)\n         .with([], \"-KILL\")\n \n-      stub_const(\"Gitlab::SidekiqCluster::CLI::CHECK_TERMINATE_INTERVAL_SECONDS\", 0.1)\n+      stub_const(\"Gitlab::SidekiqCluster::CHECK_TERMINATE_INTERVAL_SECONDS\", 0.1)\n       allow(cli).to receive(:terminate_timeout_seconds) { 1 }\n \n       cli.wait_for_termination\n@@ -301,7 +303,7 @@\n \n         cli.run(%w(foo))\n \n-        stub_const(\"Gitlab::SidekiqCluster::CLI::CHECK_TERMINATE_INTERVAL_SECONDS\", 0.1)\n+        stub_const(\"Gitlab::SidekiqCluster::CHECK_TERMINATE_INTERVAL_SECONDS\", 0.1)\n         allow(cli).to receive(:terminate_timeout_seconds) { 1 }\n \n         cli.wait_for_termination\n"},{"old_path":"spec/controllers/concerns/renders_commits_spec.rb","new_path":"spec/controllers/concerns/renders_commits_spec.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -64,6 +64,12 @@ def go\n         subject.prepare_commits_for_rendering(merge_request.commits.take(1))\n       end\n \n+      # Populate Banzai::Filter::References::ReferenceCache\n+      subject.prepare_commits_for_rendering(merge_request.commits)\n+\n+      # Reset lazy_latest_pipeline cache to simulate a new request\n+      BatchLoader::Executor.clear_current\n+\n       expect do\n         subject.prepare_commits_for_rendering(merge_request.commits)\n         merge_request.commits.each(\u0026:latest_pipeline)\n"},{"old_path":"spec/features/graphql_known_operations_spec.rb","new_path":"spec/features/graphql_known_operations_spec.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,29 @@\n+# frozen_string_literal: true\n+\n+require 'spec_helper'\n+\n+# We need to distinguish between known and unknown GraphQL operations. This spec\n+# tests that we set up Gitlab::Graphql::KnownOperations.default which requires\n+# integration of FE queries, webpack plugin, and BE.\n+RSpec.describe 'Graphql known operations', :js do\n+  around do |example|\n+    # Let's make sure we aren't receiving or leaving behind any side-effects\n+    # https://gitlab.com/gitlab-org/gitlab/-/jobs/1743294100\n+    ::Gitlab::Graphql::KnownOperations.instance_variable_set(:@default, nil)\n+    ::Gitlab::Webpack::GraphqlKnownOperations.clear_memoization!\n+\n+    example.run\n+\n+    ::Gitlab::Graphql::KnownOperations.instance_variable_set(:@default, nil)\n+    ::Gitlab::Webpack::GraphqlKnownOperations.clear_memoization!\n+  end\n+\n+  it 'collects known Graphql operations from the code', :aggregate_failures do\n+    # Check that we include some arbitrary operation name we expect\n+    known_operations = Gitlab::Graphql::KnownOperations.default.operations.map(\u0026:name)\n+\n+    expect(known_operations).to include(\"searchProjects\")\n+    expect(known_operations.length).to be \u003e 20\n+    expect(known_operations).to all( match(%r{^[a-z]+}i) )\n+  end\n+end\n"},{"old_path":"spec/features/issues/form_spec.rb","new_path":"spec/features/issues/form_spec.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -4,25 +4,29 @@\n \n RSpec.describe 'New/edit issue', :js do\n   include ActionView::Helpers::JavaScriptHelper\n-  include FormHelper\n \n   let_it_be(:project)   { create(:project) }\n-  let_it_be(:user)      { create(:user)}\n-  let_it_be(:user2)     { create(:user)}\n+  let_it_be(:user)      { create(:user) }\n+  let_it_be(:user2)     { create(:user) }\n   let_it_be(:milestone) { create(:milestone, project: project) }\n   let_it_be(:label)     { create(:label, project: project) }\n   let_it_be(:label2)    { create(:label, project: project) }\n   let_it_be(:issue)     { create(:issue, project: project, assignees: [user], milestone: milestone) }\n \n-  before do\n-    stub_licensed_features(multiple_issue_assignees: false, issue_weights: false)\n+  let(:current_user) { user }\n \n+  before_all do\n     project.add_maintainer(user)\n     project.add_maintainer(user2)\n-    sign_in(user)\n   end\n \n-  context 'new issue' do\n+  before do\n+    stub_licensed_features(multiple_issue_assignees: false, issue_weights: false)\n+\n+    sign_in(current_user)\n+  end\n+\n+  describe 'new issue' do\n     before do\n       visit new_project_issue_path(project)\n     end\n@@ -235,29 +239,42 @@\n     end\n \n     describe 'displays issue type options in the dropdown' do\n+      shared_examples 'type option is visible' do |label:, identifier:|\n+        it \"shows #{identifier} option\", :aggregate_failures do\n+          page.within('[data-testid=\"issue-type-select-dropdown\"]') do\n+            expect(page).to have_selector(%([data-testid=\"issue-type-#{identifier}-icon\"]))\n+            expect(page).to have_content(label)\n+          end\n+        end\n+      end\n+\n       before do\n         page.within('.issue-form') do\n           click_button 'Issue'\n         end\n       end\n \n-      it 'correctly displays the Issue type option with an icon', :aggregate_failures do\n-        page.within('[data-testid=\"issue-type-select-dropdown\"]') do\n-          expect(page).to have_selector('[data-testid=\"issue-type-issue-icon\"]')\n-          expect(page).to have_content('Issue')\n-        end\n-      end\n+      it_behaves_like 'type option is visible', label: 'Issue', identifier: :issue\n+      it_behaves_like 'type option is visible', label: 'Incident', identifier: :incident\n \n-      it 'correctly displays the Incident type option with an icon', :aggregate_failures do\n-        page.within('[data-testid=\"issue-type-select-dropdown\"]') do\n-          expect(page).to have_selector('[data-testid=\"issue-type-incident-icon\"]')\n-          expect(page).to have_content('Incident')\n+      context 'when user is guest' do\n+        let_it_be(:guest) { create(:user) }\n+\n+        let(:current_user) { guest }\n+\n+        before_all do\n+          project.add_guest(guest)\n         end\n+\n+        it_behaves_like 'type option is visible', label: 'Issue', identifier: :issue\n+        it_behaves_like 'type option is visible', label: 'Incident', identifier: :incident\n       end\n     end\n \n     describe 'milestone' do\n-      let!(:milestone) { create(:milestone, title: '\"\u003e\u0026lt;img src=x onerror=alert(document.domain)\u0026gt;', project: project) }\n+      let!(:milestone) do\n+        create(:milestone, title: '\"\u003e\u0026lt;img src=x onerror=alert(document.domain)\u0026gt;', project: project)\n+      end\n \n       it 'escapes milestone' do\n         click_button 'Milestone'\n@@ -274,7 +291,7 @@\n     end\n   end\n \n-  context 'edit issue' do\n+  describe 'edit issue' do\n     before do\n       visit edit_project_issue_path(project, issue)\n     end\n@@ -329,7 +346,7 @@\n     end\n   end\n \n-  context 'inline edit' do\n+  describe 'inline edit' do\n     before do\n       visit project_issue_path(project, issue)\n     end\n"},{"old_path":"spec/features/merge_request/user_merges_when_pipeline_succeeds_spec.rb","new_path":"spec/features/merge_request/user_merges_when_pipeline_succeeds_spec.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -36,7 +36,7 @@\n           click_button \"Merge when pipeline succeeds\"\n \n           expect(page).to have_content \"Set by #{user.name} to be merged automatically when the pipeline succeeds\"\n-          expect(page).to have_content \"The source branch will not be deleted\"\n+          expect(page).to have_content \"Does not delete the source branch\"\n           expect(page).to have_selector \".js-cancel-auto-merge\"\n           visit project_merge_request_path(project, merge_request) # Needed to refresh the page\n           expect(page).to have_content /enabled an automatic merge when the pipeline for \\h{8} succeeds/i\n@@ -126,7 +126,7 @@\n     it 'allows to delete source branch' do\n       click_button \"Delete source branch\"\n \n-      expect(page).to have_content \"The source branch will be deleted\"\n+      expect(page).to have_content \"Deletes the source branch\"\n     end\n \n     context 'when pipeline succeeds' do\n"},{"old_path":"spec/features/merge_request/user_sees_merge_widget_spec.rb","new_path":"spec/features/merge_request/user_sees_merge_widget_spec.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -426,7 +426,7 @@\n \n     it 'user cannot remove source branch', :sidekiq_might_not_need_inline do\n       expect(page).not_to have_field('remove-source-branch-input')\n-      expect(page).to have_content('The source branch will be deleted')\n+      expect(page).to have_content('Deletes the source branch')\n     end\n   end\n \n"},{"old_path":"spec/frontend/admin/analytics/devops_score/components/devops_score_callout_spec.js","new_path":"spec/frontend/admin/analytics/devops_score/components/devops_score_callout_spec.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -1,7 +1,7 @@\n import { GlBanner } from '@gitlab/ui';\n import { shallowMount } from '@vue/test-utils';\n-import DevopsScoreCallout from '~/analytics/devops_report/components/devops_score_callout.vue';\n-import { INTRO_COOKIE_KEY } from '~/analytics/devops_report/constants';\n+import DevopsScoreCallout from '~/analytics/devops_reports/components/devops_score_callout.vue';\n+import { INTRO_COOKIE_KEY } from '~/analytics/devops_reports/constants';\n import * as utils from '~/lib/utils/common_utils';\n import { devopsReportDocsPath, devopsScoreIntroImagePath } from '../mock_data';\n \n"},{"old_path":"spec/frontend/admin/analytics/devops_score/components/devops_score_spec.js","new_path":"spec/frontend/admin/analytics/devops_score/components/devops_score_spec.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -2,8 +2,8 @@ import { GlTable, GlBadge, GlEmptyState } from '@gitlab/ui';\n import { GlSingleStat } from '@gitlab/ui/dist/charts';\n import { mount } from '@vue/test-utils';\n import { extendedWrapper } from 'helpers/vue_test_utils_helper';\n-import DevopsScore from '~/analytics/devops_report/components/devops_score.vue';\n-import DevopsScoreCallout from '~/analytics/devops_report/components/devops_score_callout.vue';\n+import DevopsScore from '~/analytics/devops_reports/components/devops_score.vue';\n+import DevopsScoreCallout from '~/analytics/devops_reports/components/devops_score_callout.vue';\n import { devopsScoreMetricsData, noDataImagePath, devopsScoreTableHeaders } from '../mock_data';\n \n describe('DevopsScore', () =\u003e {\n"},{"old_path":"spec/frontend/analytics/devops_report/components/service_ping_disabled_spec.js","new_path":"spec/frontend/analytics/devops_reports/components/service_ping_disabled_spec.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":true,"deleted_file":false,"diff":"@@ -1,9 +1,9 @@\n import { GlEmptyState, GlSprintf } from '@gitlab/ui';\n import { TEST_HOST } from 'helpers/test_constants';\n import { mountExtended } from 'helpers/vue_test_utils_helper';\n-import ServicePingDisabled from '~/analytics/devops_report/components/service_ping_disabled.vue';\n+import ServicePingDisabled from '~/analytics/devops_reports/components/service_ping_disabled.vue';\n \n-describe('~/analytics/devops_report/components/service_ping_disabled.vue', () =\u003e {\n+describe('~/analytics/devops_reports/components/service_ping_disabled.vue', () =\u003e {\n   let wrapper;\n \n   afterEach(() =\u003e {\n"},{"old_path":"spec/frontend/diffs/components/diff_discussions_spec.js","new_path":"spec/frontend/diffs/components/diff_discussions_spec.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -1,6 +1,7 @@\n import { GlIcon } from '@gitlab/ui';\n import { mount, createLocalVue } from '@vue/test-utils';\n import DiffDiscussions from '~/diffs/components/diff_discussions.vue';\n+import { discussionIntersectionObserverHandlerFactory } from '~/diffs/utils/discussions';\n import { createStore } from '~/mr_notes/stores';\n import DiscussionNotes from '~/notes/components/discussion_notes.vue';\n import NoteableDiscussion from '~/notes/components/noteable_discussion.vue';\n@@ -19,6 +20,9 @@ describe('DiffDiscussions', () =\u003e {\n     store = createStore();\n     wrapper = mount(localVue.extend(DiffDiscussions), {\n       store,\n+      provide: {\n+        discussionObserverHandler: discussionIntersectionObserverHandlerFactory(),\n+      },\n       propsData: {\n         discussions: getDiscussionsMockData(),\n         ...props,\n"},{"old_path":"spec/frontend/diffs/utils/discussions_spec.js","new_path":"spec/frontend/diffs/utils/discussions_spec.js","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,133 @@\n+import { discussionIntersectionObserverHandlerFactory } from '~/diffs/utils/discussions';\n+\n+describe('Diff Discussions Utils', () =\u003e {\n+  describe('discussionIntersectionObserverHandlerFactory', () =\u003e {\n+    it('creates a handler function', () =\u003e {\n+      expect(discussionIntersectionObserverHandlerFactory()).toBeInstanceOf(Function);\n+    });\n+\n+    describe('intersection observer handler', () =\u003e {\n+      const functions = {\n+        setCurrentDiscussionId: jest.fn(),\n+        getPreviousUnresolvedDiscussionId: jest.fn().mockImplementation((id) =\u003e {\n+          return Number(id) - 1;\n+        }),\n+      };\n+      const defaultProcessableWrapper = {\n+        entry: {\n+          time: 0,\n+          isIntersecting: true,\n+          rootBounds: {\n+            bottom: 0,\n+          },\n+          boundingClientRect: {\n+            top: 0,\n+          },\n+        },\n+        currentDiscussion: {\n+          id: 1,\n+        },\n+        isFirstUnresolved: false,\n+        isDiffsPage: true,\n+      };\n+      let handler;\n+      let getMock;\n+      let setMock;\n+\n+      beforeEach(() =\u003e {\n+        functions.setCurrentDiscussionId.mockClear();\n+        functions.getPreviousUnresolvedDiscussionId.mockClear();\n+\n+        defaultProcessableWrapper.functions = functions;\n+\n+        setMock = functions.setCurrentDiscussionId.mock;\n+        getMock = functions.getPreviousUnresolvedDiscussionId.mock;\n+        handler = discussionIntersectionObserverHandlerFactory();\n+      });\n+\n+      it('debounces multiple simultaneous requests into one queue', () =\u003e {\n+        handler(defaultProcessableWrapper);\n+        handler(defaultProcessableWrapper);\n+        handler(defaultProcessableWrapper);\n+        handler(defaultProcessableWrapper);\n+\n+        expect(setTimeout).toHaveBeenCalledTimes(4);\n+        expect(clearTimeout).toHaveBeenCalledTimes(3);\n+\n+        // By only advancing to one timer, we ensure it's all being batched into one queue\n+        jest.advanceTimersToNextTimer();\n+\n+        expect(functions.setCurrentDiscussionId).toHaveBeenCalledTimes(4);\n+      });\n+\n+      it('properly processes, sorts and executes the correct actions for a set of observed intersections', () =\u003e {\n+        handler(defaultProcessableWrapper);\n+        handler({\n+          // This observation is here to be filtered out because it's a scrollDown\n+          ...defaultProcessableWrapper,\n+          entry: {\n+            ...defaultProcessableWrapper.entry,\n+            isIntersecting: false,\n+            boundingClientRect: { top: 10 },\n+            rootBounds: { bottom: 100 },\n+          },\n+        });\n+        handler({\n+          ...defaultProcessableWrapper,\n+          entry: {\n+            ...defaultProcessableWrapper.entry,\n+            time: 101,\n+            isIntersecting: false,\n+            rootBounds: { bottom: -100 },\n+          },\n+          currentDiscussion: { id: 20 },\n+        });\n+        handler({\n+          ...defaultProcessableWrapper,\n+          entry: {\n+            ...defaultProcessableWrapper.entry,\n+            time: 100,\n+            isIntersecting: false,\n+            boundingClientRect: { top: 100 },\n+          },\n+          currentDiscussion: { id: 30 },\n+          isDiffsPage: false,\n+        });\n+        handler({\n+          ...defaultProcessableWrapper,\n+          isFirstUnresolved: true,\n+          entry: {\n+            ...defaultProcessableWrapper.entry,\n+            time: 100,\n+            isIntersecting: false,\n+            boundingClientRect: { top: 200 },\n+          },\n+        });\n+\n+        jest.advanceTimersToNextTimer();\n+\n+        expect(setMock.calls.length).toBe(4);\n+        expect(setMock.calls[0]).toEqual([1]);\n+        expect(setMock.calls[1]).toEqual([29]);\n+        expect(setMock.calls[2]).toEqual([null]);\n+        expect(setMock.calls[3]).toEqual([19]);\n+\n+        expect(getMock.calls.length).toBe(2);\n+        expect(getMock.calls[0]).toEqual([30, false]);\n+        expect(getMock.calls[1]).toEqual([20, true]);\n+\n+        [\n+          setMock.invocationCallOrder[0],\n+          getMock.invocationCallOrder[0],\n+          setMock.invocationCallOrder[1],\n+          setMock.invocationCallOrder[2],\n+          getMock.invocationCallOrder[1],\n+          setMock.invocationCallOrder[3],\n+        ].forEach((order, idx, list) =\u003e {\n+          // Compare each invocation sequence to the one before it (except the first one)\n+          expect(list[idx - 1] || -1).toBeLessThan(order);\n+        });\n+      });\n+    });\n+  });\n+});\n"},{"old_path":"spec/frontend/notes/components/discussion_notes_spec.js","new_path":"spec/frontend/notes/components/discussion_notes_spec.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -1,6 +1,7 @@\n import { getByRole } from '@testing-library/dom';\n import { shallowMount, mount } from '@vue/test-utils';\n import '~/behaviors/markdown/render_gfm';\n+import { discussionIntersectionObserverHandlerFactory } from '~/diffs/utils/discussions';\n import DiscussionNotes from '~/notes/components/discussion_notes.vue';\n import NoteableNote from '~/notes/components/noteable_note.vue';\n import { SYSTEM_NOTE } from '~/notes/constants';\n@@ -26,6 +27,9 @@ describe('DiscussionNotes', () =\u003e {\n   const createComponent = (props, mountingMethod = shallowMount) =\u003e {\n     wrapper = mountingMethod(DiscussionNotes, {\n       store,\n+      provide: {\n+        discussionObserverHandler: discussionIntersectionObserverHandlerFactory(),\n+      },\n       propsData: {\n         discussion: discussionMock,\n         isExpanded: false,\n"},{"old_path":"spec/frontend/notes/components/noteable_discussion_spec.js","new_path":"spec/frontend/notes/components/noteable_discussion_spec.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -3,6 +3,7 @@ import { nextTick } from 'vue';\n import discussionWithTwoUnresolvedNotes from 'test_fixtures/merge_requests/resolved_diff_discussion.json';\n import { trimText } from 'helpers/text_helper';\n import mockDiffFile from 'jest/diffs/mock_data/diff_file';\n+import { discussionIntersectionObserverHandlerFactory } from '~/diffs/utils/discussions';\n import DiscussionNotes from '~/notes/components/discussion_notes.vue';\n import ReplyPlaceholder from '~/notes/components/discussion_reply_placeholder.vue';\n import ResolveWithIssueButton from '~/notes/components/discussion_resolve_with_issue_button.vue';\n@@ -31,6 +32,9 @@ describe('noteable_discussion component', () =\u003e {\n \n     wrapper = mount(NoteableDiscussion, {\n       store,\n+      provide: {\n+        discussionObserverHandler: discussionIntersectionObserverHandlerFactory(),\n+      },\n       propsData: { discussion: discussionMock },\n     });\n   });\n@@ -167,6 +171,9 @@ describe('noteable_discussion component', () =\u003e {\n \n         wrapper = mount(NoteableDiscussion, {\n           store,\n+          provide: {\n+            discussionObserverHandler: discussionIntersectionObserverHandlerFactory(),\n+          },\n           propsData: { discussion: discussionMock },\n         });\n       });\n@@ -185,6 +192,9 @@ describe('noteable_discussion component', () =\u003e {\n \n         wrapper = mount(NoteableDiscussion, {\n           store,\n+          provide: {\n+            discussionObserverHandler: discussionIntersectionObserverHandlerFactory(),\n+          },\n           propsData: { discussion: discussionMock },\n         });\n       });\n"},{"old_path":"spec/frontend/notes/components/notes_app_spec.js","new_path":"spec/frontend/notes/components/notes_app_spec.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -9,6 +9,7 @@ import DraftNote from '~/batch_comments/components/draft_note.vue';\n import batchComments from '~/batch_comments/stores/modules/batch_comments';\n import axios from '~/lib/utils/axios_utils';\n import * as urlUtility from '~/lib/utils/url_utility';\n+import { discussionIntersectionObserverHandlerFactory } from '~/diffs/utils/discussions';\n import CommentForm from '~/notes/components/comment_form.vue';\n import NotesApp from '~/notes/components/notes_app.vue';\n import * as constants from '~/notes/constants';\n@@ -78,6 +79,9 @@ describe('note_app', () =\u003e {\n           \u003c/div\u003e`,\n         },\n         {\n+          provide: {\n+            discussionObserverHandler: discussionIntersectionObserverHandlerFactory(),\n+          },\n           propsData,\n           store,\n         },\n"},{"old_path":"spec/frontend/runner/components/cells/runner_actions_cell_spec.js","new_path":"spec/frontend/runner/components/cells/runner_actions_cell_spec.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -8,12 +8,11 @@ import RunnerActionCell from '~/runner/components/cells/runner_actions_cell.vue'\n import getGroupRunnersQuery from '~/runner/graphql/get_group_runners.query.graphql';\n import getRunnersQuery from '~/runner/graphql/get_runners.query.graphql';\n import runnerDeleteMutation from '~/runner/graphql/runner_delete.mutation.graphql';\n-import runnerUpdateMutation from '~/runner/graphql/runner_update.mutation.graphql';\n+import runnerActionsUpdateMutation from '~/runner/graphql/runner_actions_update.mutation.graphql';\n import { captureException } from '~/runner/sentry_utils';\n-import { runnersData, runnerData } from '../../mock_data';\n+import { runnersData } from '../../mock_data';\n \n const mockRunner = runnersData.data.runners.nodes[0];\n-const mockRunnerDetails = runnerData.data.runner;\n \n const getRunnersQueryName = getRunnersQuery.definitions[0].name.value;\n const getGroupRunnersQueryName = getGroupRunnersQuery.definitions[0].name.value;\n@@ -27,7 +26,7 @@ jest.mock('~/runner/sentry_utils');\n describe('RunnerTypeCell', () =\u003e {\n   let wrapper;\n   const runnerDeleteMutationHandler = jest.fn();\n-  const runnerUpdateMutationHandler = jest.fn();\n+  const runnerActionsUpdateMutationHandler = jest.fn();\n \n   const findEditBtn = () =\u003e wrapper.findByTestId('edit-runner');\n   const findToggleActiveBtn = () =\u003e wrapper.findByTestId('toggle-active-runner');\n@@ -46,7 +45,7 @@ describe('RunnerTypeCell', () =\u003e {\n         localVue,\n         apolloProvider: createMockApollo([\n           [runnerDeleteMutation, runnerDeleteMutationHandler],\n-          [runnerUpdateMutation, runnerUpdateMutationHandler],\n+          [runnerActionsUpdateMutation, runnerActionsUpdateMutationHandler],\n         ]),\n         ...options,\n       }),\n@@ -62,10 +61,10 @@ describe('RunnerTypeCell', () =\u003e {\n       },\n     });\n \n-    runnerUpdateMutationHandler.mockResolvedValue({\n+    runnerActionsUpdateMutationHandler.mockResolvedValue({\n       data: {\n         runnerUpdate: {\n-          runner: mockRunnerDetails,\n+          runner: mockRunner,\n           errors: [],\n         },\n       },\n@@ -74,7 +73,7 @@ describe('RunnerTypeCell', () =\u003e {\n \n   afterEach(() =\u003e {\n     runnerDeleteMutationHandler.mockReset();\n-    runnerUpdateMutationHandler.mockReset();\n+    runnerActionsUpdateMutationHandler.mockReset();\n \n     wrapper.destroy();\n   });\n@@ -116,12 +115,12 @@ describe('RunnerTypeCell', () =\u003e {\n \n     describe(`When clicking on the ${icon} button`, () =\u003e {\n       it(`The apollo mutation to set active to ${newActiveValue} is called`, async () =\u003e {\n-        expect(runnerUpdateMutationHandler).toHaveBeenCalledTimes(0);\n+        expect(runnerActionsUpdateMutationHandler).toHaveBeenCalledTimes(0);\n \n         await findToggleActiveBtn().vm.$emit('click');\n \n-        expect(runnerUpdateMutationHandler).toHaveBeenCalledTimes(1);\n-        expect(runnerUpdateMutationHandler).toHaveBeenCalledWith({\n+        expect(runnerActionsUpdateMutationHandler).toHaveBeenCalledTimes(1);\n+        expect(runnerActionsUpdateMutationHandler).toHaveBeenCalledWith({\n           input: {\n             id: mockRunner.id,\n             active: newActiveValue,\n@@ -145,7 +144,7 @@ describe('RunnerTypeCell', () =\u003e {\n         const mockErrorMsg = 'Update error!';\n \n         beforeEach(async () =\u003e {\n-          runnerUpdateMutationHandler.mockRejectedValueOnce(new Error(mockErrorMsg));\n+          runnerActionsUpdateMutationHandler.mockRejectedValueOnce(new Error(mockErrorMsg));\n \n           await findToggleActiveBtn().vm.$emit('click');\n         });\n@@ -167,10 +166,10 @@ describe('RunnerTypeCell', () =\u003e {\n         const mockErrorMsg2 = 'User not allowed!';\n \n         beforeEach(async () =\u003e {\n-          runnerUpdateMutationHandler.mockResolvedValue({\n+          runnerActionsUpdateMutationHandler.mockResolvedValue({\n             data: {\n               runnerUpdate: {\n-                runner: runnerData.data.runner,\n+                runner: mockRunner,\n                 errors: [mockErrorMsg, mockErrorMsg2],\n               },\n             },\n"},{"old_path":"spec/frontend/runner/components/cells/runner_type_cell_spec.js","new_path":"spec/frontend/runner/components/cells/runner_status_cell_spec.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":true,"deleted_file":false,"diff":"@@ -1,20 +1,20 @@\n import { GlBadge } from '@gitlab/ui';\n import { mount } from '@vue/test-utils';\n-import RunnerTypeCell from '~/runner/components/cells/runner_type_cell.vue';\n-import { INSTANCE_TYPE } from '~/runner/constants';\n+import RunnerStatusCell from '~/runner/components/cells/runner_status_cell.vue';\n+import { INSTANCE_TYPE, STATUS_ONLINE, STATUS_OFFLINE } from '~/runner/constants';\n \n describe('RunnerTypeCell', () =\u003e {\n   let wrapper;\n \n-  const findBadges = () =\u003e wrapper.findAllComponents(GlBadge);\n+  const findBadgeAt = (i) =\u003e wrapper.findAllComponents(GlBadge).at(i);\n \n   const createComponent = ({ runner = {} } = {}) =\u003e {\n-    wrapper = mount(RunnerTypeCell, {\n+    wrapper = mount(RunnerStatusCell, {\n       propsData: {\n         runner: {\n           runnerType: INSTANCE_TYPE,\n           active: true,\n-          locked: false,\n+          status: STATUS_ONLINE,\n           ...runner,\n         },\n       },\n@@ -25,24 +25,45 @@ describe('RunnerTypeCell', () =\u003e {\n     wrapper.destroy();\n   });\n \n-  it('Displays the runner type', () =\u003e {\n+  it('Displays online status', () =\u003e {\n     createComponent();\n \n-    expect(findBadges()).toHaveLength(1);\n-    expect(findBadges().at(0).text()).toBe('shared');\n+    expect(wrapper.text()).toMatchInterpolatedText('online');\n+    expect(findBadgeAt(0).text()).toBe('online');\n   });\n \n-  it('Displays locked and paused states', () =\u003e {\n+  it('Displays offline status', () =\u003e {\n+    createComponent({\n+      runner: {\n+        status: STATUS_OFFLINE,\n+      },\n+    });\n+\n+    expect(wrapper.text()).toMatchInterpolatedText('offline');\n+    expect(findBadgeAt(0).text()).toBe('offline');\n+  });\n+\n+  it('Displays paused status', () =\u003e {\n     createComponent({\n       runner: {\n         active: false,\n-        locked: true,\n+        status: STATUS_ONLINE,\n+      },\n+    });\n+\n+    expect(wrapper.text()).toMatchInterpolatedText('online paused');\n+\n+    expect(findBadgeAt(0).text()).toBe('online');\n+    expect(findBadgeAt(1).text()).toBe('paused');\n+  });\n+\n+  it('Is empty when data is missing', () =\u003e {\n+    createComponent({\n+      runner: {\n+        status: null,\n       },\n     });\n \n-    expect(findBadges()).toHaveLength(3);\n-    expect(findBadges().at(0).text()).toBe('shared');\n-    expect(findBadges().at(1).text()).toBe('locked');\n-    expect(findBadges().at(2).text()).toBe('paused');\n+    expect(wrapper.text()).toBe('');\n   });\n });\n"},{"old_path":"spec/frontend/runner/components/cells/runner_summary_cell_spec.js","new_path":"spec/frontend/runner/components/cells/runner_summary_cell_spec.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -1,5 +1,6 @@\n-import { mount } from '@vue/test-utils';\n+import { mountExtended } from 'helpers/vue_test_utils_helper';\n import RunnerSummaryCell from '~/runner/components/cells/runner_summary_cell.vue';\n+import { INSTANCE_TYPE, PROJECT_TYPE } from '~/runner/constants';\n \n const mockId = '1';\n const mockShortSha = '2P6oDVDm';\n@@ -8,13 +9,17 @@ const mockDescription = 'runner-1';\n describe('RunnerTypeCell', () =\u003e {\n   let wrapper;\n \n-  const createComponent = (options) =\u003e {\n-    wrapper = mount(RunnerSummaryCell, {\n+  const findLockIcon = () =\u003e wrapper.findByTestId('lock-icon');\n+\n+  const createComponent = (runner, options) =\u003e {\n+    wrapper = mountExtended(RunnerSummaryCell, {\n       propsData: {\n         runner: {\n           id: `gid://gitlab/Ci::Runner/${mockId}`,\n           shortSha: mockShortSha,\n           description: mockDescription,\n+          runnerType: INSTANCE_TYPE,\n+          ...runner,\n         },\n       },\n       ...options,\n@@ -33,6 +38,23 @@ describe('RunnerTypeCell', () =\u003e {\n     expect(wrapper.text()).toContain(`#${mockId} (${mockShortSha})`);\n   });\n \n+  it('Displays the runner type', () =\u003e {\n+    expect(wrapper.text()).toContain('shared');\n+  });\n+\n+  it('Does not display the locked icon', () =\u003e {\n+    expect(findLockIcon().exists()).toBe(false);\n+  });\n+\n+  it('Displays the locked icon for locked runners', () =\u003e {\n+    createComponent({\n+      runnerType: PROJECT_TYPE,\n+      locked: true,\n+    });\n+\n+    expect(findLockIcon().exists()).toBe(true);\n+  });\n+\n   it('Displays the runner description', () =\u003e {\n     expect(wrapper.text()).toContain(mockDescription);\n   });\n@@ -40,11 +62,14 @@ describe('RunnerTypeCell', () =\u003e {\n   it('Displays a custom slot', () =\u003e {\n     const slotContent = 'My custom runner summary';\n \n-    createComponent({\n-      slots: {\n-        'runner-name': slotContent,\n+    createComponent(\n+      {},\n+      {\n+        slots: {\n+          'runner-name': slotContent,\n+        },\n       },\n-    });\n+    );\n \n     expect(wrapper.text()).toContain(slotContent);\n   });\n"},{"old_path":"spec/frontend/runner/components/runner_contacted_state_badge_spec.js","new_path":"spec/frontend/runner/components/runner_contacted_state_badge_spec.js","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,86 @@\n+import { GlBadge } from '@gitlab/ui';\n+import { shallowMount } from '@vue/test-utils';\n+import RunnerContactedStateBadge from '~/runner/components/runner_contacted_state_badge.vue';\n+import { createMockDirective, getBinding } from 'helpers/vue_mock_directive';\n+import { STATUS_ONLINE, STATUS_OFFLINE, STATUS_NOT_CONNECTED } from '~/runner/constants';\n+\n+describe('RunnerTypeBadge', () =\u003e {\n+  let wrapper;\n+\n+  const findBadge = () =\u003e wrapper.findComponent(GlBadge);\n+  const getTooltip = () =\u003e getBinding(findBadge().element, 'gl-tooltip');\n+\n+  const createComponent = ({ runner = {} } = {}) =\u003e {\n+    wrapper = shallowMount(RunnerContactedStateBadge, {\n+      propsData: {\n+        runner: {\n+          contactedAt: '2021-01-01T00:00:00Z',\n+          status: STATUS_ONLINE,\n+          ...runner,\n+        },\n+      },\n+      directives: {\n+        GlTooltip: createMockDirective(),\n+      },\n+    });\n+  };\n+\n+  beforeEach(() =\u003e {\n+    jest.useFakeTimers('modern');\n+  });\n+\n+  afterEach(() =\u003e {\n+    jest.useFakeTimers('legacy');\n+\n+    wrapper.destroy();\n+  });\n+\n+  it('renders online state', () =\u003e {\n+    jest.setSystemTime(new Date('2021-01-01T00:01:00Z'));\n+\n+    createComponent();\n+\n+    expect(wrapper.text()).toBe('online');\n+    expect(findBadge().props('variant')).toBe('success');\n+    expect(getTooltip().value).toBe('Runner is online; last contact was 1 minute ago');\n+  });\n+\n+  it('renders offline state', () =\u003e {\n+    jest.setSystemTime(new Date('2021-01-02T00:00:00Z'));\n+\n+    createComponent({\n+      runner: {\n+        status: STATUS_OFFLINE,\n+      },\n+    });\n+\n+    expect(wrapper.text()).toBe('offline');\n+    expect(findBadge().props('variant')).toBe('muted');\n+    expect(getTooltip().value).toBe(\n+      'No recent contact from this runner; last contact was 1 day ago',\n+    );\n+  });\n+\n+  it('renders not connected state', () =\u003e {\n+    createComponent({\n+      runner: {\n+        contactedAt: null,\n+        status: STATUS_NOT_CONNECTED,\n+      },\n+    });\n+\n+    expect(wrapper.text()).toBe('not connected');\n+    expect(findBadge().props('variant')).toBe('muted');\n+    expect(getTooltip().value).toMatch('This runner has never connected');\n+  });\n+\n+  it('does not fail when data is missing', () =\u003e {\n+    createComponent({\n+      runner: {\n+        status: null,\n+      },\n+    });\n+\n+    expect(wrapper.text()).toBe('');\n+  });\n+});\n"},{"old_path":"spec/frontend/runner/components/runner_list_spec.js","new_path":"spec/frontend/runner/components/runner_list_spec.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -42,8 +42,8 @@ describe('RunnerList', () =\u003e {\n     const headerLabels = findHeaders().wrappers.map((w) =\u003e w.text());\n \n     expect(headerLabels).toEqual([\n-      'Type/State',\n-      'Runner',\n+      'Status',\n+      'Runner ID',\n       'Version',\n       'IP Address',\n       'Tags',\n@@ -62,7 +62,7 @@ describe('RunnerList', () =\u003e {\n     const { id, description, version, ipAddress, shortSha } = mockRunners[0];\n \n     // Badges\n-    expect(findCell({ fieldKey: 'type' }).text()).toMatchInterpolatedText('specific paused');\n+    expect(findCell({ fieldKey: 'status' }).text()).toMatchInterpolatedText('not connected paused');\n \n     // Runner summary\n     expect(findCell({ fieldKey: 'summary' }).text()).toContain(\n"},{"old_path":"spec/frontend/runner/components/runner_state_paused_badge_spec.js","new_path":"spec/frontend/runner/components/runner_paused_badge_spec.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":true,"deleted_file":false,"diff":"@@ -1,6 +1,6 @@\n import { GlBadge } from '@gitlab/ui';\n import { shallowMount } from '@vue/test-utils';\n-import RunnerStatePausedBadge from '~/runner/components/runner_state_paused_badge.vue';\n+import RunnerStatePausedBadge from '~/runner/components/runner_paused_badge.vue';\n import { createMockDirective, getBinding } from 'helpers/vue_mock_directive';\n \n describe('RunnerTypeBadge', () =\u003e {\n"},{"old_path":"spec/frontend/runner/components/runner_state_locked_badge_spec.js","new_path":"spec/frontend/runner/components/runner_state_locked_badge_spec.js","a_mode":"100644","b_mode":"0","new_file":false,"renamed_file":false,"deleted_file":true,"diff":"@@ -1,45 +0,0 @@\n-import { GlBadge } from '@gitlab/ui';\n-import { shallowMount } from '@vue/test-utils';\n-import RunnerStateLockedBadge from '~/runner/components/runner_state_locked_badge.vue';\n-import { createMockDirective, getBinding } from 'helpers/vue_mock_directive';\n-\n-describe('RunnerTypeBadge', () =\u003e {\n-  let wrapper;\n-\n-  const findBadge = () =\u003e wrapper.findComponent(GlBadge);\n-  const getTooltip = () =\u003e getBinding(findBadge().element, 'gl-tooltip');\n-\n-  const createComponent = ({ props = {} } = {}) =\u003e {\n-    wrapper = shallowMount(RunnerStateLockedBadge, {\n-      propsData: {\n-        ...props,\n-      },\n-      directives: {\n-        GlTooltip: createMockDirective(),\n-      },\n-    });\n-  };\n-\n-  beforeEach(() =\u003e {\n-    createComponent();\n-  });\n-\n-  afterEach(() =\u003e {\n-    wrapper.destroy();\n-  });\n-\n-  it('renders locked state', () =\u003e {\n-    expect(wrapper.text()).toBe('locked');\n-    expect(findBadge().props('variant')).toBe('warning');\n-  });\n-\n-  it('renders tooltip', () =\u003e {\n-    expect(getTooltip().value).toBeDefined();\n-  });\n-\n-  it('passes arbitrary attributes to the badge', () =\u003e {\n-    createComponent({ props: { size: 'sm' } });\n-\n-    expect(findBadge().props('size')).toBe('sm');\n-  });\n-});\n"},{"old_path":"spec/frontend/runner/components/runner_type_alert_spec.js","new_path":"spec/frontend/runner/components/runner_type_alert_spec.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -23,11 +23,11 @@ describe('RunnerTypeAlert', () =\u003e {\n   });\n \n   describe.each`\n-    type             | exampleText                                                            | anchor                 | variant\n-    ${INSTANCE_TYPE} | ${'This runner is available to all groups and projects'}               | ${'#shared-runners'}   | ${'success'}\n-    ${GROUP_TYPE}    | ${'This runner is available to all projects and subgroups in a group'} | ${'#group-runners'}    | ${'success'}\n-    ${PROJECT_TYPE}  | ${'This runner is associated with one or more projects'}               | ${'#specific-runners'} | ${'info'}\n-  `('When it is an $type level runner', ({ type, exampleText, anchor, variant }) =\u003e {\n+    type             | exampleText                                                            | anchor\n+    ${INSTANCE_TYPE} | ${'This runner is available to all groups and projects'}               | ${'#shared-runners'}\n+    ${GROUP_TYPE}    | ${'This runner is available to all projects and subgroups in a group'} | ${'#group-runners'}\n+    ${PROJECT_TYPE}  | ${'This runner is associated with one or more projects'}               | ${'#specific-runners'}\n+  `('When it is an $type level runner', ({ type, exampleText, anchor }) =\u003e {\n     beforeEach(() =\u003e {\n       createComponent({ props: { type } });\n     });\n@@ -36,8 +36,8 @@ describe('RunnerTypeAlert', () =\u003e {\n       expect(wrapper.text()).toMatch(exampleText);\n     });\n \n-    it(`Shows a ${variant} variant`, () =\u003e {\n-      expect(findAlert().props('variant')).toBe(variant);\n+    it(`Shows an \"info\" variant`, () =\u003e {\n+      expect(findAlert().props('variant')).toBe('info');\n     });\n \n     it(`Links to anchor \"${anchor}\"`, () =\u003e {\n"},{"old_path":"spec/frontend/runner/components/runner_type_badge_spec.js","new_path":"spec/frontend/runner/components/runner_type_badge_spec.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -26,18 +26,18 @@ describe('RunnerTypeBadge', () =\u003e {\n   });\n \n   describe.each`\n-    type             | text          | variant\n-    ${INSTANCE_TYPE} | ${'shared'}   | ${'success'}\n-    ${GROUP_TYPE}    | ${'group'}    | ${'success'}\n-    ${PROJECT_TYPE}  | ${'specific'} | ${'info'}\n-  `('displays $type runner', ({ type, text, variant }) =\u003e {\n+    type             | text\n+    ${INSTANCE_TYPE} | ${'shared'}\n+    ${GROUP_TYPE}    | ${'group'}\n+    ${PROJECT_TYPE}  | ${'specific'}\n+  `('displays $type runner', ({ type, text }) =\u003e {\n     beforeEach(() =\u003e {\n       createComponent({ props: { type } });\n     });\n \n-    it(`as \"${text}\" with a ${variant} variant`, () =\u003e {\n+    it(`as \"${text}\" with an \"info\" variant`, () =\u003e {\n       expect(findBadge().text()).toBe(text);\n-      expect(findBadge().props('variant')).toBe(variant);\n+      expect(findBadge().props('variant')).toBe('info');\n     });\n \n     it('with a tooltip', () =\u003e {\n"},{"old_path":"spec/frontend/vue_mr_widget/components/states/__snapshots__/mr_widget_auto_merge_enabled_spec.js.snap","new_path":"spec/frontend/vue_mr_widget/components/states/__snapshots__/mr_widget_auto_merge_enabled_spec.js.snap","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -50,7 +50,7 @@ exports[`MRWidgetAutoMergeEnabled when graphql is disabled template should have\n         \u003cspan\n           class=\"gl-mr-3\"\n         \u003e\n-          The source branch will not be deleted\n+          Does not delete the source branch\n         \u003c/span\u003e\n          \n         \u003cgl-button-stub\n@@ -122,7 +122,7 @@ exports[`MRWidgetAutoMergeEnabled when graphql is enabled template should have c\n         \u003cspan\n           class=\"gl-mr-3\"\n         \u003e\n-          The source branch will not be deleted\n+          Does not delete the source branch\n         \u003c/span\u003e\n          \n         \u003cgl-button-stub\n"},{"old_path":"spec/frontend/vue_mr_widget/components/states/mr_widget_auto_merge_enabled_spec.js","new_path":"spec/frontend/vue_mr_widget/components/states/mr_widget_auto_merge_enabled_spec.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -270,8 +270,8 @@ describe('MRWidgetAutoMergeEnabled', () =\u003e {\n \n           const normalizedText = wrapper.text().replace(/\\s+/g, ' ');\n \n-          expect(normalizedText).toContain('The source branch will be deleted');\n-          expect(normalizedText).not.toContain('The source branch will not be deleted');\n+          expect(normalizedText).toContain('Deletes the source branch');\n+          expect(normalizedText).not.toContain('Does not delete the source branch');\n         });\n \n         it('should not show delete source branch button when user not able to delete source branch', () =\u003e {\n"},{"old_path":"spec/frontend/vue_mr_widget/components/states/mr_widget_merging_spec.js","new_path":"spec/frontend/vue_mr_widget/components/states/mr_widget_merging_spec.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -42,7 +42,7 @@ describe('MRWidgetMerging', () =\u003e {\n         .trim()\n         .replace(/\\s\\s+/g, ' ')\n         .replace(/[\\r\\n]+/g, ' '),\n-    ).toEqual('The changes will be merged into branch');\n+    ).toEqual('Merges changes into branch');\n \n     expect(wrapper.find('a').attributes('href')).toBe('/branch-path');\n   });\n"},{"old_path":"spec/frontend/vue_mr_widget/mr_widget_options_spec.js","new_path":"spec/frontend/vue_mr_widget/mr_widget_options_spec.js","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -543,7 +543,7 @@ describe('MrWidgetOptions', () =\u003e {\n         nextTick(() =\u003e {\n           const tooltip = wrapper.find('[data-testid=\"question-o-icon\"]');\n \n-          expect(wrapper.text()).toContain('The source branch will be deleted');\n+          expect(wrapper.text()).toContain('Deletes the source branch');\n           expect(tooltip.attributes('title')).toBe(\n             'A user with write access to the source branch selected this option',\n           );\n@@ -559,7 +559,7 @@ describe('MrWidgetOptions', () =\u003e {\n \n         nextTick(() =\u003e {\n           expect(wrapper.text()).toContain('The source branch has been deleted');\n-          expect(wrapper.text()).not.toContain('The source branch will be deleted');\n+          expect(wrapper.text()).not.toContain('Deletes the source branch');\n \n           done();\n         });\n"},{"old_path":"spec/lib/gitlab/ci/artifact_file_reader_spec.rb","new_path":"spec/lib/gitlab/ci/artifact_file_reader_spec.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -18,17 +18,6 @@\n         expect(YAML.safe_load(subject).keys).to contain_exactly('rspec', 'time', 'custom')\n       end\n \n-      context 'when FF ci_new_artifact_file_reader is disabled' do\n-        before do\n-          stub_feature_flags(ci_new_artifact_file_reader: false)\n-        end\n-\n-        it 'returns the content at the path' do\n-          is_expected.to be_present\n-          expect(YAML.safe_load(subject).keys).to contain_exactly('rspec', 'time', 'custom')\n-        end\n-      end\n-\n       context 'when path does not exist' do\n         let(:path) { 'file/does/not/exist.txt' }\n         let(:expected_error) do\n"},{"old_path":"spec/lib/gitlab/database/gitlab_schema_spec.rb","new_path":"spec/lib/gitlab/database/gitlab_schema_spec.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -35,4 +35,24 @@\n       end\n     end\n   end\n+\n+  describe '.table_schema' do\n+    using RSpec::Parameterized::TableSyntax\n+\n+    where(:name, :classification) do\n+      'ci_builds'                       | :gitlab_ci\n+      'my_schema.ci_builds'             | :gitlab_ci\n+      'information_schema.columns'      | :gitlab_shared\n+      'audit_events_part_5fc467ac26'    | :gitlab_main\n+      '_test_my_table'                  | :gitlab_shared\n+      'pg_attribute'                    | :gitlab_shared\n+      'my_other_table'                  | :undefined_my_other_table\n+    end\n+\n+    with_them do\n+      subject { described_class.table_schema(name) }\n+\n+      it { is_expected.to eq(classification) }\n+    end\n+  end\n end\n"},{"old_path":"spec/lib/gitlab/database/query_analyzer_spec.rb","new_path":"spec/lib/gitlab/database/query_analyzer_spec.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,72 @@\n+# frozen_string_literal: true\n+\n+require 'spec_helper'\n+\n+RSpec.describe Gitlab::Database::QueryAnalyzer do\n+  let(:analyzer) { double(:query_analyzer) }\n+\n+  before do\n+    stub_const('Gitlab::Database::QueryAnalyzer::ANALYZERS', [analyzer])\n+  end\n+\n+  context 'the hook is enabled by default in specs' do\n+    it 'does process queries and gets normalized SQL' do\n+      expect(analyzer).to receive(:enabled?).and_return(true)\n+      expect(analyzer).to receive(:analyze) do |parsed|\n+        expect(parsed.sql).to include(\"SELECT $1 FROM projects\")\n+        expect(parsed.pg.tables).to eq(%w[projects])\n+      end\n+\n+      Project.connection.execute(\"SELECT 1 FROM projects\")\n+    end\n+  end\n+\n+  describe '#process_sql' do\n+    it 'does not analyze query if not enabled' do\n+      expect(analyzer).to receive(:enabled?).and_return(false)\n+      expect(analyzer).not_to receive(:analyze)\n+\n+      process_sql(\"SELECT 1 FROM projects\")\n+    end\n+\n+    it 'does analyze query if enabled' do\n+      expect(analyzer).to receive(:enabled?).and_return(true)\n+      expect(analyzer).to receive(:analyze) do |parsed|\n+        expect(parsed.sql).to eq(\"SELECT $1 FROM projects\")\n+        expect(parsed.pg.tables).to eq(%w[projects])\n+      end\n+\n+      process_sql(\"SELECT 1 FROM projects\")\n+    end\n+\n+    it 'does track exception if query cannot be parsed' do\n+      expect(analyzer).to receive(:enabled?).and_return(true)\n+      expect(analyzer).not_to receive(:analyze)\n+      expect(Gitlab::ErrorTracking).to receive(:track_exception)\n+\n+      expect { process_sql(\"invalid query\") }.not_to raise_error\n+    end\n+\n+    it 'does track exception if analyzer raises exception on enabled?' do\n+      expect(analyzer).to receive(:enabled?).and_raise('exception')\n+      expect(analyzer).not_to receive(:analyze)\n+      expect(Gitlab::ErrorTracking).to receive(:track_and_raise_for_dev_exception)\n+\n+      expect { process_sql(\"SELECT 1 FROM projects\") }.not_to raise_error\n+    end\n+\n+    it 'does track exception if analyzer raises exception on analyze' do\n+      expect(analyzer).to receive(:enabled?).and_return(true)\n+      expect(analyzer).to receive(:analyze).and_raise('exception')\n+      expect(Gitlab::ErrorTracking).to receive(:track_and_raise_for_dev_exception)\n+\n+      expect { process_sql(\"SELECT 1 FROM projects\") }.not_to raise_error\n+    end\n+\n+    def process_sql(sql)\n+      ApplicationRecord.connection.load_balancer.read_write do |connection|\n+        described_class.new.send(:process_sql, sql, connection)\n+      end\n+    end\n+  end\n+end\n"},{"old_path":"spec/lib/gitlab/graphql/known_operations_spec.rb","new_path":"spec/lib/gitlab/graphql/known_operations_spec.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,72 @@\n+# frozen_string_literal: true\n+\n+require 'fast_spec_helper'\n+require 'rspec-parameterized'\n+require \"support/graphql/fake_query_type\"\n+\n+RSpec.describe Gitlab::Graphql::KnownOperations do\n+  using RSpec::Parameterized::TableSyntax\n+\n+  # Include duplicated operation names to test that we are unique-ifying them\n+  let(:fake_operations) { %w(foo foo bar bar) }\n+  let(:fake_schema) do\n+    Class.new(GraphQL::Schema) do\n+      query Graphql::FakeQueryType\n+    end\n+  end\n+\n+  subject { described_class.new(fake_operations) }\n+\n+  describe \"#from_query\" do\n+    where(:query_string, :expected) do\n+      \"query { helloWorld }\"         | described_class::ANONYMOUS\n+      \"query fuzzyyy { helloWorld }\" | described_class::UNKNOWN\n+      \"query foo { helloWorld }\"     | described_class::Operation.new(\"foo\")\n+    end\n+\n+    with_them do\n+      it \"returns known operation name from GraphQL Query\" do\n+        query = ::GraphQL::Query.new(fake_schema, query_string)\n+\n+        expect(subject.from_query(query)).to eq(expected)\n+      end\n+    end\n+  end\n+\n+  describe \"#operations\" do\n+    it \"returns array of known operations\" do\n+      expect(subject.operations.map(\u0026:name)).to match_array(%w(anonymous unknown foo bar))\n+    end\n+  end\n+\n+  describe \"Operation#to_caller_id\" do\n+    where(:query_string, :expected) do\n+      \"query { helloWorld }\"         | \"graphql:#{described_class::ANONYMOUS.name}\"\n+      \"query foo { helloWorld }\"     | \"graphql:foo\"\n+    end\n+\n+    with_them do\n+      it \"formats operation name for caller_id metric property\" do\n+        query = ::GraphQL::Query.new(fake_schema, query_string)\n+\n+        expect(subject.from_query(query).to_caller_id).to eq(expected)\n+      end\n+    end\n+  end\n+\n+  describe \".default\" do\n+    it \"returns a memoization of values from webpack\", :aggregate_failures do\n+      # .default could have been referenced in another spec, so we need to clean it up here\n+      described_class.instance_variable_set(:@default, nil)\n+\n+      expect(Gitlab::Webpack::GraphqlKnownOperations).to receive(:load).once.and_return(fake_operations)\n+\n+      2.times { described_class.default }\n+\n+      # Uses reference equality to verify memoization\n+      expect(described_class.default).to equal(described_class.default)\n+      expect(described_class.default).to be_a(described_class)\n+      expect(described_class.default.operations.map(\u0026:name)).to include(*fake_operations)\n+    end\n+  end\n+end\n"},{"old_path":"spec/lib/gitlab/sidekiq_config/cli_methods_spec.rb","new_path":"spec/lib/gitlab/sidekiq_config/cli_methods_spec.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -11,12 +11,12 @@ def expand_path(path)\n     end\n \n     def stub_exists(exists: true)\n-      ['app/workers/all_queues.yml', 'ee/app/workers/all_queues.yml'].each do |path|\n+      ['app/workers/all_queues.yml', 'ee/app/workers/all_queues.yml', 'jh/app/workers/all_queues.yml'].each do |path|\n         allow(File).to receive(:exist?).with(expand_path(path)).and_return(exists)\n       end\n     end\n \n-    def stub_contents(foss_queues, ee_queues)\n+    def stub_contents(foss_queues, ee_queues, jh_queues)\n       allow(YAML).to receive(:load_file)\n                        .with(expand_path('app/workers/all_queues.yml'))\n                        .and_return(foss_queues)\n@@ -24,6 +24,10 @@ def stub_contents(foss_queues, ee_queues)\n       allow(YAML).to receive(:load_file)\n                        .with(expand_path('ee/app/workers/all_queues.yml'))\n                        .and_return(ee_queues)\n+\n+      allow(YAML).to receive(:load_file)\n+                       .with(expand_path('jh/app/workers/all_queues.yml'))\n+                       .and_return(jh_queues)\n     end\n \n     before do\n@@ -45,8 +49,9 @@ def stub_contents(foss_queues, ee_queues)\n         end\n \n         it 'flattens and joins the contents' do\n-          expected_queues = %w[queue_a queue_b]\n-          expected_queues = expected_queues.first(1) unless Gitlab.ee?\n+          expected_queues = %w[queue_a]\n+          expected_queues \u003c\u003c 'queue_b' if Gitlab.ee?\n+          expected_queues \u003c\u003c 'queue_c' if Gitlab.jh?\n \n           expect(described_class.worker_queues(dummy_root))\n             .to match_array(expected_queues)\n@@ -55,7 +60,7 @@ def stub_contents(foss_queues, ee_queues)\n \n       context 'when the file contains an array of hashes' do\n         before do\n-          stub_contents([{ name: 'queue_a' }], [{ name: 'queue_b' }])\n+          stub_contents([{ name: 'queue_a' }], [{ name: 'queue_b' }], [{ name: 'queue_c' }])\n         end\n \n         include_examples 'valid file contents'\n"},{"old_path":"spec/lib/gitlab/sidekiq_config/worker_spec.rb","new_path":"spec/lib/gitlab/sidekiq_config/worker_spec.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -18,19 +18,26 @@ def create_worker(queue:, **attributes)\n       get_tags: attributes[:tags]\n     )\n \n-    described_class.new(inner_worker, ee: false)\n+    described_class.new(inner_worker, ee: false, jh: false)\n   end\n \n   describe '#ee?' do\n     it 'returns the EE status set on creation' do\n-      expect(described_class.new(double, ee: true)).to be_ee\n-      expect(described_class.new(double, ee: false)).not_to be_ee\n+      expect(described_class.new(double, ee: true, jh: false)).to be_ee\n+      expect(described_class.new(double, ee: false, jh: false)).not_to be_ee\n+    end\n+  end\n+\n+  describe '#jh?' do\n+    it 'returns the JH status set on creation' do\n+      expect(described_class.new(double, ee: false, jh: true)).to be_jh\n+      expect(described_class.new(double, ee: false, jh: false)).not_to be_jh\n     end\n   end\n \n   describe '#==' do\n     def worker_with_yaml(yaml)\n-      described_class.new(double, ee: false).tap do |worker|\n+      described_class.new(double, ee: false, jh: false).tap do |worker|\n         allow(worker).to receive(:to_yaml).and_return(yaml)\n       end\n     end\n@@ -57,7 +64,7 @@ def worker_with_yaml(yaml)\n \n         expect(worker).to receive(meth)\n \n-        described_class.new(worker, ee: false).send(meth)\n+        described_class.new(worker, ee: false, jh: false).send(meth)\n       end\n     end\n   end\n"},{"old_path":"spec/lib/gitlab/webpack/file_loader_spec.rb","new_path":"spec/lib/gitlab/webpack/file_loader_spec.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,79 @@\n+# frozen_string_literal: true\n+\n+require 'fast_spec_helper'\n+require 'support/helpers/file_read_helpers'\n+require 'support/webmock'\n+\n+RSpec.describe Gitlab::Webpack::FileLoader do\n+  include FileReadHelpers\n+  include WebMock::API\n+\n+  let(:error_file_path) { \"error.yml\" }\n+  let(:file_path) { \"my_test_file.yml\" }\n+  let(:file_contents) do\n+    \u003c\u003c-EOF\n+    - hello\n+    - world\n+    - test\n+    EOF\n+  end\n+\n+  before do\n+    allow(Gitlab.config.webpack.dev_server).to receive_messages(host: 'hostname', port: 2000, https: false)\n+    allow(Gitlab.config.webpack).to receive(:public_path).and_return('public_path')\n+    allow(Gitlab.config.webpack).to receive(:output_dir).and_return('webpack_output')\n+  end\n+\n+  context \"with dev server enabled\" do\n+    before do\n+      allow(Gitlab.config.webpack.dev_server).to receive(:enabled).and_return(true)\n+\n+      stub_request(:get, \"http://hostname:2000/public_path/not_found\").to_return(status: 404)\n+      stub_request(:get, \"http://hostname:2000/public_path/#{file_path}\").to_return(body: file_contents, status: 200)\n+      stub_request(:get, \"http://hostname:2000/public_path/#{error_file_path}\").to_raise(StandardError)\n+    end\n+\n+    it \"returns content when respondes succesfully\" do\n+      expect(Gitlab::Webpack::FileLoader.load(file_path)).to be(file_contents)\n+    end\n+\n+    it \"raises error when 404\" do\n+      expect { Gitlab::Webpack::FileLoader.load(\"not_found\") }.to raise_error(\"HTTP error 404\")\n+    end\n+\n+    it \"raises error when errors out\" do\n+      expect { Gitlab::Webpack::FileLoader.load(error_file_path) }.to raise_error(Gitlab::Webpack::FileLoader::DevServerLoadError)\n+    end\n+  end\n+\n+  context \"with dev server enabled and https\" do\n+    before do\n+      allow(Gitlab.config.webpack.dev_server).to receive(:enabled).and_return(true)\n+      allow(Gitlab.config.webpack.dev_server).to receive(:https).and_return(true)\n+\n+      stub_request(:get, \"https://hostname:2000/public_path/#{error_file_path}\").to_raise(EOFError)\n+    end\n+\n+    it \"raises error if catches SSLError\" do\n+      expect { Gitlab::Webpack::FileLoader.load(error_file_path) }.to raise_error(Gitlab::Webpack::FileLoader::DevServerSSLError)\n+    end\n+  end\n+\n+  context \"with dev server disabled\" do\n+    before do\n+      allow(Gitlab.config.webpack.dev_server).to receive(:enabled).and_return(false)\n+      stub_file_read(::Rails.root.join(\"webpack_output/#{file_path}\"), content: file_contents)\n+      stub_file_read(::Rails.root.join(\"webpack_output/#{error_file_path}\"), error: Errno::ENOENT)\n+    end\n+\n+    describe \".load\" do\n+      it \"returns file content from file path\" do\n+        expect(Gitlab::Webpack::FileLoader.load(file_path)).to be(file_contents)\n+      end\n+\n+      it \"throws error if file cannot be read\" do\n+        expect { Gitlab::Webpack::FileLoader.load(error_file_path) }.to raise_error(Gitlab::Webpack::FileLoader::StaticLoadError)\n+      end\n+    end\n+  end\n+end\n"},{"old_path":"spec/lib/gitlab/webpack/graphql_known_operations_spec.rb","new_path":"spec/lib/gitlab/webpack/graphql_known_operations_spec.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,47 @@\n+# frozen_string_literal: true\n+\n+require 'fast_spec_helper'\n+\n+RSpec.describe Gitlab::Webpack::GraphqlKnownOperations do\n+  let(:content) do\n+    \u003c\u003c-EOF\n+    - hello\n+    - world\n+    - test\n+    EOF\n+  end\n+\n+  around do |example|\n+    described_class.clear_memoization!\n+\n+    example.run\n+\n+    described_class.clear_memoization!\n+  end\n+\n+  describe \".load\" do\n+    context \"when file loader returns\" do\n+      before do\n+        allow(::Gitlab::Webpack::FileLoader).to receive(:load).with(\"graphql_known_operations.yml\").and_return(content)\n+      end\n+\n+      it \"returns memoized value\" do\n+        expect(::Gitlab::Webpack::FileLoader).to receive(:load).once\n+\n+        2.times { ::Gitlab::Webpack::GraphqlKnownOperations.load }\n+\n+        expect(::Gitlab::Webpack::GraphqlKnownOperations.load).to eq(%w(hello world test))\n+      end\n+    end\n+\n+    context \"when file loader errors\" do\n+      before do\n+        allow(::Gitlab::Webpack::FileLoader).to receive(:load).and_raise(StandardError.new(\"test\"))\n+      end\n+\n+      it \"returns empty array\" do\n+        expect(::Gitlab::Webpack::GraphqlKnownOperations.load).to eq([])\n+      end\n+    end\n+  end\n+end\n"},{"old_path":"spec/lib/sidebars/projects/menus/infrastructure_menu_spec.rb","new_path":"spec/lib/sidebars/projects/menus/infrastructure_menu_spec.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -51,6 +51,16 @@\n         it 'menu link points to Terraform page' do\n           expect(subject.link).to eq find_menu_item(:terraform).link\n         end\n+\n+        context 'when Terraform menu is not visible' do\n+          before do\n+            subject.renderable_items.delete(find_menu_item(:terraform))\n+          end\n+\n+          it 'menu link points to Google Cloud page' do\n+            expect(subject.link).to eq find_menu_item(:google_cloud).link\n+          end\n+        end\n       end\n     end\n \n@@ -89,5 +99,11 @@ def find_menu_item(menu_item)\n \n       it_behaves_like 'access rights checks'\n     end\n+\n+    describe 'Google Cloud' do\n+      let(:item_id) { :google_cloud }\n+\n+      it_behaves_like 'access rights checks'\n+    end\n   end\n end\n"},{"old_path":"spec/models/acts_as_taggable_on/tag_spec.rb","new_path":"spec/models/acts_as_taggable_on/tag_spec.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,16 @@\n+# frozen_string_literal: true\n+\n+require 'spec_helper'\n+\n+RSpec.describe ActsAsTaggableOn::Tag do\n+  it 'has the same connection as Ci::ApplicationRecord' do\n+    query = 'select current_database()'\n+\n+    expect(described_class.connection.execute(query).first).to eq(Ci::ApplicationRecord.connection.execute(query).first)\n+    expect(described_class.retrieve_connection.execute(query).first).to eq(Ci::ApplicationRecord.retrieve_connection.execute(query).first)\n+  end\n+\n+  it 'has the same sticking as Ci::ApplicationRecord' do\n+    expect(described_class.sticking).to eq(Ci::ApplicationRecord.sticking)\n+  end\n+end\n"},{"old_path":"spec/models/acts_as_taggable_on/tagging_spec.rb","new_path":"spec/models/acts_as_taggable_on/tagging_spec.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,16 @@\n+# frozen_string_literal: true\n+\n+require 'spec_helper'\n+\n+RSpec.describe ActsAsTaggableOn::Tagging do\n+  it 'has the same connection as Ci::ApplicationRecord' do\n+    query = 'select current_database()'\n+\n+    expect(described_class.connection.execute(query).first).to eq(Ci::ApplicationRecord.connection.execute(query).first)\n+    expect(described_class.retrieve_connection.execute(query).first).to eq(Ci::ApplicationRecord.retrieve_connection.execute(query).first)\n+  end\n+\n+  it 'has the same sticking as Ci::ApplicationRecord' do\n+    expect(described_class.sticking).to eq(Ci::ApplicationRecord.sticking)\n+  end\n+end\n"},{"old_path":"spec/models/group_spec.rb","new_path":"spec/models/group_spec.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -2648,14 +2648,6 @@ def setup_group_members(group)\n     end\n \n     it_behaves_like 'returns namespaces with disabled email'\n-\n-    context 'when feature flag :linear_group_ancestor_scopes is disabled' do\n-      before do\n-        stub_feature_flags(linear_group_ancestor_scopes: false)\n-      end\n-\n-      it_behaves_like 'returns namespaces with disabled email'\n-    end\n   end\n \n   describe '.timelogs' do\n"},{"old_path":"spec/models/namespace_spec.rb","new_path":"spec/models/namespace_spec.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -284,7 +284,7 @@\n       end\n     end\n \n-    context 'creating a default Namespace' do\n+    context 'creating a Namespace with nil type' do\n       let(:namespace_type) { nil }\n \n       it 'is the correct type of namespace' do\n@@ -295,7 +295,7 @@\n     end\n \n     context 'creating an unknown Namespace type' do\n-      let(:namespace_type) { 'One' }\n+      let(:namespace_type) { 'nonsense' }\n \n       it 'creates a default Namespace' do\n         expect(Namespace.find(namespace.id)).to be_a(Namespace)\n"},{"old_path":"spec/requests/api/graphql/mutations/issues/set_crm_contacts_spec.rb","new_path":"spec/requests/api/graphql/mutations/issues/set_crm_contacts_spec.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,161 @@\n+# frozen_string_literal: true\n+\n+require 'spec_helper'\n+\n+RSpec.describe 'Setting issues crm contacts' do\n+  include GraphqlHelpers\n+\n+  let_it_be(:user) { create(:user) }\n+  let_it_be(:group) { create(:group) }\n+  let_it_be(:project) { create(:project, group: group) }\n+  let_it_be(:contacts) { create_list(:contact, 4, group: group) }\n+\n+  let(:issue) { create(:issue, project: project) }\n+  let(:operation_mode) { Types::MutationOperationModeEnum.default_mode }\n+  let(:crm_contact_ids) { [global_id_of(contacts[1]), global_id_of(contacts[2])] }\n+  let(:does_not_exist_or_no_permission) { \"The resource that you are attempting to access does not exist or you don't have permission to perform this action\" }\n+\n+  let(:mutation) do\n+    variables = {\n+      project_path: issue.project.full_path,\n+      iid: issue.iid.to_s,\n+      operation_mode: operation_mode,\n+      crm_contact_ids: crm_contact_ids\n+    }\n+\n+    graphql_mutation(:issue_set_crm_contacts, variables,\n+                     \u003c\u003c-QL.strip_heredoc\n+                       clientMutationId\n+                       errors\n+                       issue {\n+                         customerRelationsContacts {\n+                           nodes {\n+                             id\n+                           }\n+                         }\n+                       }\n+                     QL\n+    )\n+  end\n+\n+  def mutation_response\n+    graphql_mutation_response(:issue_set_crm_contacts)\n+  end\n+\n+  before do\n+    create(:issue_customer_relations_contact, issue: issue, contact: contacts[0])\n+    create(:issue_customer_relations_contact, issue: issue, contact: contacts[1])\n+  end\n+\n+  context 'when the user has no permission' do\n+    it 'returns expected error' do\n+      error = Gitlab::Graphql::Authorize::AuthorizeResource::RESOURCE_ACCESS_ERROR\n+      post_graphql_mutation(mutation, current_user: user)\n+\n+      expect(graphql_errors).to include(a_hash_including('message' =\u003e error))\n+    end\n+  end\n+\n+  context 'when the user has permission' do\n+    before do\n+      group.add_reporter(user)\n+    end\n+\n+    context 'when the feature is disabled' do\n+      before do\n+        stub_feature_flags(customer_relations: false)\n+      end\n+\n+      it 'raises expected error' do\n+        post_graphql_mutation(mutation, current_user: user)\n+\n+        expect(graphql_errors).to include(a_hash_including('message' =\u003e 'Feature disabled'))\n+      end\n+    end\n+\n+    context 'replace' do\n+      it 'updates the issue with correct contacts' do\n+        post_graphql_mutation(mutation, current_user: user)\n+\n+        expect(graphql_data_at(:issue_set_crm_contacts, :issue, :customer_relations_contacts, :nodes, :id))\n+          .to match_array([global_id_of(contacts[1]), global_id_of(contacts[2])])\n+      end\n+    end\n+\n+    context 'append' do\n+      let(:crm_contact_ids) { [global_id_of(contacts[3])] }\n+      let(:operation_mode) { Types::MutationOperationModeEnum.enum[:append] }\n+\n+      it 'updates the issue with correct contacts' do\n+        post_graphql_mutation(mutation, current_user: user)\n+\n+        expect(graphql_data_at(:issue_set_crm_contacts, :issue, :customer_relations_contacts, :nodes, :id))\n+          .to match_array([global_id_of(contacts[0]), global_id_of(contacts[1]), global_id_of(contacts[3])])\n+      end\n+    end\n+\n+    context 'remove' do\n+      let(:crm_contact_ids) { [global_id_of(contacts[0])] }\n+      let(:operation_mode) { Types::MutationOperationModeEnum.enum[:remove] }\n+\n+      it 'updates the issue with correct contacts' do\n+        post_graphql_mutation(mutation, current_user: user)\n+\n+        expect(graphql_data_at(:issue_set_crm_contacts, :issue, :customer_relations_contacts, :nodes, :id))\n+          .to match_array([global_id_of(contacts[1])])\n+      end\n+    end\n+\n+    context 'when the contact does not exist' do\n+      let(:crm_contact_ids) { [\"gid://gitlab/CustomerRelations::Contact/#{non_existing_record_id}\"] }\n+\n+      it 'returns expected error' do\n+        post_graphql_mutation(mutation, current_user: user)\n+\n+        expect(graphql_data_at(:issue_set_crm_contacts, :errors))\n+          .to match_array([\"Issue customer relations contacts #{non_existing_record_id}: #{does_not_exist_or_no_permission}\"])\n+      end\n+    end\n+\n+    context 'when the contact belongs to a different group' do\n+      let(:group2) { create(:group) }\n+      let(:contact) { create(:contact, group: group2) }\n+      let(:crm_contact_ids) { [global_id_of(contact)] }\n+\n+      before do\n+        group2.add_reporter(user)\n+      end\n+\n+      it 'returns expected error' do\n+        post_graphql_mutation(mutation, current_user: user)\n+\n+        expect(graphql_data_at(:issue_set_crm_contacts, :errors))\n+        .to match_array([\"Issue customer relations contacts #{contact.id}: #{does_not_exist_or_no_permission}\"])\n+      end\n+    end\n+\n+    context 'when attempting to add more than 6' do\n+      let(:operation_mode) { Types::MutationOperationModeEnum.enum[:append] }\n+      let(:gid) { global_id_of(contacts[0]) }\n+      let(:crm_contact_ids) { [gid, gid, gid, gid, gid, gid, gid] }\n+\n+      it 'returns expected error' do\n+        post_graphql_mutation(mutation, current_user: user)\n+\n+        expect(graphql_data_at(:issue_set_crm_contacts, :errors))\n+          .to match_array([\"You can only add up to 6 contacts at one time\"])\n+      end\n+    end\n+\n+    context 'when trying to remove non-existent contact' do\n+      let(:operation_mode) { Types::MutationOperationModeEnum.enum[:remove] }\n+      let(:crm_contact_ids) { [\"gid://gitlab/CustomerRelations::Contact/#{non_existing_record_id}\"] }\n+\n+      it 'raises expected error' do\n+        post_graphql_mutation(mutation, current_user: user)\n+\n+        expect(graphql_data_at(:issue_set_crm_contacts, :errors)).to be_empty\n+      end\n+    end\n+  end\n+end\n"},{"old_path":"spec/requests/api/settings_spec.rb","new_path":"spec/requests/api/settings_spec.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -612,5 +612,46 @@\n         expect(json_response.slice(*settings.keys)).to eq(settings)\n       end\n     end\n+\n+    context 'Sentry settings' do\n+      let(:settings) do\n+        {\n+          sentry_enabled: true,\n+          sentry_dsn: 'http://sentry.example.com',\n+          sentry_clientside_dsn: 'http://sentry.example.com',\n+          sentry_environment: 'production'\n+        }\n+      end\n+\n+      let(:attribute_names) { settings.keys.map(\u0026:to_s) }\n+\n+      it 'includes the attributes in the API' do\n+        get api('/application/settings', admin)\n+\n+        expect(response).to have_gitlab_http_status(:ok)\n+        attribute_names.each do |attribute|\n+          expect(json_response.keys).to include(attribute)\n+        end\n+      end\n+\n+      it 'allows updating the settings' do\n+        put api('/application/settings', admin), params: settings\n+\n+        expect(response).to have_gitlab_http_status(:ok)\n+        settings.each do |attribute, value|\n+          expect(ApplicationSetting.current.public_send(attribute)).to eq(value)\n+        end\n+      end\n+\n+      context 'missing sentry_dsn value when sentry_enabled is true' do\n+        it 'returns a blank parameter error message' do\n+          put api('/application/settings', admin), params: { sentry_enabled: true }\n+\n+          expect(response).to have_gitlab_http_status(:bad_request)\n+          message = json_response['message']\n+          expect(message[\"sentry_dsn\"]).to include(a_string_matching(\"can't be blank\"))\n+        end\n+      end\n+    end\n   end\n end\n"},{"old_path":"spec/requests/api/v3/github_spec.rb","new_path":"spec/requests/api/v3/github_spec.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -6,7 +6,7 @@\n   let_it_be(:user) { create(:user) }\n   let_it_be(:unauthorized_user) { create(:user) }\n   let_it_be(:admin) { create(:user, :admin) }\n-  let_it_be(:project) { create(:project, :repository, creator: user) }\n+  let_it_be_with_reload(:project) { create(:project, :repository, creator: user) }\n \n   before do\n     project.add_maintainer(user)\n@@ -506,11 +506,18 @@ def expect_project_under_namespace(projects, namespace, user)\n \n   describe 'GET /repos/:namespace/:project/commits/:sha' do\n     let(:commit) { project.repository.commit }\n-    let(:commit_id) { commit.id }\n+\n+    def call_api(commit_id: commit.id)\n+      jira_get v3_api(\"/repos/#{project.namespace.path}/#{project.path}/commits/#{commit_id}\", user)\n+    end\n+\n+    def response_diff_files(response)\n+      Gitlab::Json.parse(response.body)['files']\n+    end\n \n     context 'authenticated' do\n-      it 'returns commit with github format' do\n-        jira_get v3_api(\"/repos/#{project.namespace.path}/#{project.path}/commits/#{commit_id}\", user)\n+      it 'returns commit with github format', :aggregate_failures do\n+        call_api\n \n         expect(response).to have_gitlab_http_status(:ok)\n         expect(response).to match_response_schema('entities/github/commit')\n@@ -519,36 +526,130 @@ def expect_project_under_namespace(projects, namespace, user)\n       it 'returns 200 when project path include a dot' do\n         project.update!(path: 'foo.bar')\n \n-        jira_get v3_api(\"/repos/#{project.namespace.path}/#{project.path}/commits/#{commit_id}\", user)\n+        call_api\n \n         expect(response).to have_gitlab_http_status(:ok)\n       end\n \n-      it 'returns 200 when namespace path include a dot' do\n-        group = create(:group, path: 'foo.bar')\n-        project = create(:project, :repository, group: group)\n-        project.add_reporter(user)\n+      context 'when namespace path includes a dot' do\n+        let(:group) { create(:group, path: 'foo.bar') }\n+        let(:project) { create(:project, :repository, group: group) }\n \n-        jira_get v3_api(\"/repos/#{group.path}/#{project.path}/commits/#{commit_id}\", user)\n+        it 'returns 200 when namespace path include a dot' do\n+          project.add_reporter(user)\n \n-        expect(response).to have_gitlab_http_status(:ok)\n+          call_api\n+\n+          expect(response).to have_gitlab_http_status(:ok)\n+        end\n+      end\n+\n+      context 'when the Gitaly `CommitDiff` RPC times out', :use_clean_rails_memory_store_caching do\n+        let(:commit_diff_args) { [project.repository_storage, :diff_service, :commit_diff, any_args] }\n+\n+        before do\n+          allow(Gitlab::GitalyClient).to receive(:call)\n+            .and_call_original\n+        end\n+\n+        it 'handles the error, logs it, and returns empty diff files', :aggregate_failures do\n+          allow(Gitlab::GitalyClient).to receive(:call)\n+            .with(*commit_diff_args)\n+            .and_raise(GRPC::DeadlineExceeded)\n+\n+          expect(Gitlab::ErrorTracking)\n+            .to receive(:track_exception)\n+            .with an_instance_of(GRPC::DeadlineExceeded)\n+\n+          call_api\n+\n+          expect(response).to have_gitlab_http_status(:ok)\n+          expect(response_diff_files(response)).to be_blank\n+        end\n+\n+        it 'does not handle the error when feature flag is disabled', :aggregate_failures do\n+          stub_feature_flags(api_v3_commits_skip_diff_files: false)\n+\n+          allow(Gitlab::GitalyClient).to receive(:call)\n+            .with(*commit_diff_args)\n+            .and_raise(GRPC::DeadlineExceeded)\n+\n+          call_api\n+\n+          expect(response).to have_gitlab_http_status(:error)\n+        end\n+\n+        it 'only calls Gitaly once for all attempts within a period of time', :aggregate_failures do\n+          expect(Gitlab::GitalyClient).to receive(:call)\n+            .with(*commit_diff_args)\n+            .once # \u003c- once\n+            .and_raise(GRPC::DeadlineExceeded)\n+\n+          3.times do\n+            call_api\n+\n+            expect(response).to have_gitlab_http_status(:ok)\n+            expect(response_diff_files(response)).to be_blank\n+          end\n+        end\n+\n+        it 'calls Gitaly again after a period of time', :aggregate_failures do\n+          expect(Gitlab::GitalyClient).to receive(:call)\n+            .with(*commit_diff_args)\n+            .twice # \u003c- twice\n+            .and_raise(GRPC::DeadlineExceeded)\n+\n+          call_api\n+\n+          expect(response).to have_gitlab_http_status(:ok)\n+          expect(response_diff_files(response)).to be_blank\n+\n+          travel_to((described_class::GITALY_TIMEOUT_CACHE_EXPIRY + 1.second).from_now) do\n+            call_api\n+\n+            expect(response).to have_gitlab_http_status(:ok)\n+            expect(response_diff_files(response)).to be_blank\n+          end\n+        end\n+\n+        it 'uses a unique cache key, allowing other calls to succeed' do\n+          cache_key = [described_class::GITALY_TIMEOUT_CACHE_KEY, project.id, commit.cache_key].join(':')\n+          Rails.cache.write(cache_key, 1)\n+\n+          expect(Gitlab::GitalyClient).to receive(:call)\n+            .with(*commit_diff_args)\n+            .once # \u003c- once\n+\n+          call_api\n+\n+          expect(response).to have_gitlab_http_status(:ok)\n+          expect(response_diff_files(response)).to be_blank\n+\n+          call_api(commit_id: commit.parent.id)\n+\n+          expect(response).to have_gitlab_http_status(:ok)\n+          expect(response_diff_files(response).length).to eq(1)\n+        end\n       end\n     end\n \n     context 'unauthenticated' do\n+      let(:user) { nil }\n+\n       it 'returns 401' do\n-        jira_get v3_api(\"/repos/#{project.namespace.path}/#{project.path}/commits/#{commit_id}\", nil)\n+        call_api\n \n         expect(response).to have_gitlab_http_status(:unauthorized)\n       end\n     end\n \n     context 'unauthorized' do\n+      let(:user) { unauthorized_user }\n+\n       it 'returns 404 when lower access level' do\n-        project.add_guest(unauthorized_user)\n+        project.add_guest(user)\n \n-        jira_get v3_api(\"/repos/#{project.namespace.path}/#{project.path}/commits/#{commit_id}\",\n-                   unauthorized_user)\n+        call_api\n \n         expect(response).to have_gitlab_http_status(:not_found)\n       end\n"},{"old_path":"spec/services/authorized_project_update/project_access_changed_service_spec.rb","new_path":"spec/services/authorized_project_update/project_access_changed_service_spec.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,21 @@\n+# frozen_string_literal: true\n+\n+require 'spec_helper'\n+\n+RSpec.describe AuthorizedProjectUpdate::ProjectAccessChangedService do\n+  describe '#execute' do\n+    it 'schedules the project IDs' do\n+      expect(AuthorizedProjectUpdate::ProjectRecalculateWorker).to receive(:bulk_perform_and_wait)\n+        .with([[1], [2]])\n+\n+      described_class.new([1, 2]).execute\n+    end\n+\n+    it 'permits non-blocking operation' do\n+      expect(AuthorizedProjectUpdate::ProjectRecalculateWorker).to receive(:bulk_perform_async)\n+        .with([[1], [2]])\n+\n+      described_class.new([1, 2]).execute(blocking: false)\n+    end\n+  end\n+end\n"},{"old_path":"spec/services/groups/transfer_service_spec.rb","new_path":"spec/services/groups/transfer_service_spec.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -593,11 +593,16 @@\n           let_it_be_with_reload(:group) { create(:group, :private, parent: old_parent_group) }\n           let_it_be(:new_group_member) { create(:user) }\n           let_it_be(:old_group_member) { create(:user) }\n+          let_it_be(:unique_subgroup_member) { create(:user) }\n+          let_it_be(:direct_project_member) { create(:user) }\n \n           before do\n             new_parent_group.add_maintainer(new_group_member)\n             old_parent_group.add_maintainer(old_group_member)\n+            subgroup1.add_developer(unique_subgroup_member)\n+            nested_project.add_developer(direct_project_member)\n             group.refresh_members_authorized_projects\n+            subgroup1.refresh_members_authorized_projects\n           end\n \n           it 'removes old project authorizations' do\n@@ -613,7 +618,7 @@\n           end\n \n           it 'performs authorizations job immediately' do\n-            expect(AuthorizedProjectsWorker).to receive(:bulk_perform_inline)\n+            expect(AuthorizedProjectUpdate::ProjectRecalculateWorker).to receive(:bulk_perform_inline)\n \n             transfer_service.execute(new_parent_group)\n           end\n@@ -630,14 +635,24 @@\n                 ProjectAuthorization.where(project_id: nested_project.id, user_id: new_group_member.id).size\n               }.from(0).to(1)\n             end\n+\n+            it 'preserves existing project authorizations for direct project members' do\n+              expect { transfer_service.execute(new_parent_group) }.not_to change {\n+                ProjectAuthorization.where(project_id: nested_project.id, user_id: direct_project_member.id).count\n+              }\n+            end\n           end\n \n-          context 'for groups with many members' do\n-            before do\n-              11.times do\n-                new_parent_group.add_maintainer(create(:user))\n-              end\n+          context 'for nested groups with unique members' do\n+            it 'preserves existing project authorizations' do\n+              expect { transfer_service.execute(new_parent_group) }.not_to change {\n+                ProjectAuthorization.where(project_id: nested_project.id, user_id: unique_subgroup_member.id).count\n+              }\n             end\n+          end\n+\n+          context 'for groups with many projects' do\n+            let_it_be(:project_list) { create_list(:project, 11, :repository, :private, namespace: group) }\n \n             it 'adds new project authorizations for the user which makes a transfer' do\n               transfer_service.execute(new_parent_group)\n@@ -646,9 +661,21 @@\n               expect(ProjectAuthorization.where(project_id: nested_project.id, user_id: user.id).size).to eq(1)\n             end\n \n+            it 'adds project authorizations for users in the new hierarchy' do\n+              expect { transfer_service.execute(new_parent_group) }.to change {\n+                ProjectAuthorization.where(project_id: project_list.map { |project| project.id }, user_id: new_group_member.id).size\n+              }.from(0).to(project_list.count)\n+            end\n+\n+            it 'removes project authorizations for users in the old hierarchy' do\n+              expect { transfer_service.execute(new_parent_group) }.to change {\n+                ProjectAuthorization.where(project_id: project_list.map { |project| project.id }, user_id: old_group_member.id).size\n+              }.from(project_list.count).to(0)\n+            end\n+\n             it 'schedules authorizations job' do\n-              expect(AuthorizedProjectsWorker).to receive(:bulk_perform_async)\n-                .with(array_including(new_parent_group.members_with_parents.pluck(:user_id).map {|id| [id, anything] }))\n+              expect(AuthorizedProjectUpdate::ProjectRecalculateWorker).to receive(:bulk_perform_async)\n+                .with(array_including(group.all_projects.ids.map { |id| [id, anything] }))\n \n               transfer_service.execute(new_parent_group)\n             end\n"},{"old_path":"spec/services/issues/set_crm_contacts_service_spec.rb","new_path":"spec/services/issues/set_crm_contacts_service_spec.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,162 @@\n+# frozen_string_literal: true\n+\n+require 'spec_helper'\n+\n+RSpec.describe Issues::SetCrmContactsService do\n+  let_it_be(:user) { create(:user) }\n+  let_it_be(:group) { create(:group) }\n+  let_it_be(:project) { create(:project, group: group) }\n+  let_it_be(:contacts) { create_list(:contact, 4, group: group) }\n+\n+  let(:issue) { create(:issue, project: project) }\n+  let(:does_not_exist_or_no_permission) { \"The resource that you are attempting to access does not exist or you don't have permission to perform this action\" }\n+\n+  before do\n+    create(:issue_customer_relations_contact, issue: issue, contact: contacts[0])\n+    create(:issue_customer_relations_contact, issue: issue, contact: contacts[1])\n+  end\n+\n+  subject(:set_crm_contacts) do\n+    described_class.new(project: project, current_user: user, params: params).execute(issue)\n+  end\n+\n+  describe '#execute' do\n+    context 'when the user has no permission' do\n+      let(:params) { { crm_contact_ids: [contacts[1].id, contacts[2].id] } }\n+\n+      it 'returns expected error response' do\n+        response = set_crm_contacts\n+\n+        expect(response).to be_error\n+        expect(response.message).to match_array(['You have insufficient permissions to set customer relations contacts for this issue'])\n+      end\n+    end\n+\n+    context 'when user has permission' do\n+      before do\n+        group.add_reporter(user)\n+      end\n+\n+      context 'when the contact does not exist' do\n+        let(:params) { { crm_contact_ids: [non_existing_record_id] } }\n+\n+        it 'returns expected error response' do\n+          response = set_crm_contacts\n+\n+          expect(response).to be_error\n+          expect(response.message).to match_array([\"Issue customer relations contacts #{non_existing_record_id}: #{does_not_exist_or_no_permission}\"])\n+        end\n+      end\n+\n+      context 'when the contact belongs to a different group' do\n+        let(:group2) { create(:group) }\n+        let(:contact) { create(:contact, group: group2) }\n+        let(:params) { { crm_contact_ids: [contact.id] } }\n+\n+        before do\n+          group2.add_reporter(user)\n+        end\n+\n+        it 'returns expected error response' do\n+          response = set_crm_contacts\n+\n+          expect(response).to be_error\n+          expect(response.message).to match_array([\"Issue customer relations contacts #{contact.id}: #{does_not_exist_or_no_permission}\"])\n+        end\n+      end\n+\n+      context 'replace' do\n+        let(:params) { { crm_contact_ids: [contacts[1].id, contacts[2].id] } }\n+\n+        it 'updates the issue with correct contacts' do\n+          response = set_crm_contacts\n+\n+          expect(response).to be_success\n+          expect(issue.customer_relations_contacts).to match_array([contacts[1], contacts[2]])\n+        end\n+      end\n+\n+      context 'add' do\n+        let(:params) { { add_crm_contact_ids: [contacts[3].id] } }\n+\n+        it 'updates the issue with correct contacts' do\n+          response = set_crm_contacts\n+\n+          expect(response).to be_success\n+          expect(issue.customer_relations_contacts).to match_array([contacts[0], contacts[1], contacts[3]])\n+        end\n+      end\n+\n+      context 'remove' do\n+        let(:params) { { remove_crm_contact_ids: [contacts[0].id] } }\n+\n+        it 'updates the issue with correct contacts' do\n+          response = set_crm_contacts\n+\n+          expect(response).to be_success\n+          expect(issue.customer_relations_contacts).to match_array([contacts[1]])\n+        end\n+      end\n+\n+      context 'when attempting to add more than 6' do\n+        let(:id) { contacts[0].id }\n+        let(:params) { { add_crm_contact_ids: [id, id, id, id, id, id, id] } }\n+\n+        it 'returns expected error message' do\n+          response = set_crm_contacts\n+\n+          expect(response).to be_error\n+          expect(response.message).to match_array(['You can only add up to 6 contacts at one time'])\n+        end\n+      end\n+\n+      context 'when trying to remove non-existent contact' do\n+        let(:params) { { remove_crm_contact_ids: [non_existing_record_id] } }\n+\n+        it 'returns expected error message' do\n+          response = set_crm_contacts\n+\n+          expect(response).to be_success\n+          expect(response.message).to be_nil\n+        end\n+      end\n+\n+      context 'when combining params' do\n+        let(:error_invalid_params) { 'You cannot combine crm_contact_ids with add_crm_contact_ids or remove_crm_contact_ids' }\n+\n+        context 'add and remove' do\n+          let(:params) { { remove_crm_contact_ids: [contacts[1].id], add_crm_contact_ids: [contacts[3].id] } }\n+\n+          it 'updates the issue with correct contacts' do\n+            response = set_crm_contacts\n+\n+            expect(response).to be_success\n+            expect(issue.customer_relations_contacts).to match_array([contacts[0], contacts[3]])\n+          end\n+        end\n+\n+        context 'replace and remove' do\n+          let(:params) { { crm_contact_ids: [contacts[3].id], remove_crm_contact_ids: [contacts[0].id] } }\n+\n+          it 'returns expected error response' do\n+            response = set_crm_contacts\n+\n+            expect(response).to be_error\n+            expect(response.message).to match_array([error_invalid_params])\n+          end\n+        end\n+\n+        context 'replace and add' do\n+          let(:params) { { crm_contact_ids: [contacts[3].id], add_crm_contact_ids: [contacts[1].id] } }\n+\n+          it 'returns expected error response' do\n+            response = set_crm_contacts\n+\n+            expect(response).to be_error\n+            expect(response.message).to match_array([error_invalid_params])\n+          end\n+        end\n+      end\n+    end\n+  end\n+end\n"},{"old_path":"spec/services/projects/container_repository/cleanup_tags_service_spec.rb","new_path":"spec/services/projects/container_repository/cleanup_tags_service_spec.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":""},{"old_path":"spec/lib/gitlab/sidekiq_cluster_spec.rb","new_path":"spec/sidekiq_cluster/sidekiq_cluster_spec.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":true,"deleted_file":false,"diff":"@@ -1,9 +1,10 @@\n # frozen_string_literal: true\n \n-require 'fast_spec_helper'\n require 'rspec-parameterized'\n \n-RSpec.describe Gitlab::SidekiqCluster do\n+require_relative '../../sidekiq_cluster/sidekiq_cluster'\n+\n+RSpec.describe Gitlab::SidekiqCluster do # rubocop:disable RSpec/FilePath\n   describe '.trap_signals' do\n     it 'traps the given signals' do\n       expect(described_class).to receive(:trap).ordered.with(:INT)\n"},{"old_path":"spec/spec_helper.rb","new_path":"spec/spec_helper.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -107,9 +107,7 @@\n         warn `curl -s -o log/goroutines.log http://localhost:9236/debug/pprof/goroutine?debug=2`\n       end\n     end\n-  end\n-\n-  unless ENV['CI']\n+  else\n     # Allow running `:focus` examples locally,\n     # falling back to all tests when there is no `:focus` example.\n     config.filter_run focus: true\n"},{"old_path":"spec/support/flaky_tests.rb","new_path":"spec/support/flaky_tests.rb","a_mode":"0","b_mode":"100644","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,36 @@\n+# frozen_string_literal: true\n+\n+return unless ENV['CI']\n+return unless ENV['SKIP_FLAKY_TESTS_AUTOMATICALLY'] == \"true\"\n+return if ENV['CI_MERGE_REQUEST_LABELS'].to_s.include?('pipeline:run-flaky-tests')\n+\n+require_relative '../tooling/rspec_flaky/report'\n+\n+RSpec.configure do |config|\n+  $flaky_test_example_ids = begin # rubocop:disable Style/GlobalVars\n+    raise \"$SUITE_FLAKY_RSPEC_REPORT_PATH is empty.\" if ENV['SUITE_FLAKY_RSPEC_REPORT_PATH'].to_s.empty?\n+    raise \"#{ENV['SUITE_FLAKY_RSPEC_REPORT_PATH']} doesn't exist\" unless File.exist?(ENV['SUITE_FLAKY_RSPEC_REPORT_PATH'])\n+\n+    RspecFlaky::Report.load(ENV['SUITE_FLAKY_RSPEC_REPORT_PATH']).map { |_, flaky_test_data| flaky_test_data[\"example_id\"] }\n+  rescue =\u003e e # rubocop:disable Style/RescueStandardError\n+    puts e\n+    []\n+  end\n+  $skipped_flaky_tests_report = [] # rubocop:disable Style/GlobalVars\n+\n+  config.around do |example|\n+    # Skip flaky tests automatically\n+    if $flaky_test_example_ids.include?(example.id) # rubocop:disable Style/GlobalVars\n+      puts \"Skipping #{example.id} '#{example.full_description}' because it's flaky.\"\n+      $skipped_flaky_tests_report \u003c\u003c example.id # rubocop:disable Style/GlobalVars\n+    else\n+      example.run\n+    end\n+  end\n+\n+  config.after(:suite) do\n+    next unless ENV['SKIPPED_FLAKY_TESTS_REPORT_PATH']\n+\n+    File.write(ENV['SKIPPED_FLAKY_TESTS_REPORT_PATH'], \"#{$skipped_flaky_tests_report.join(\"\\n\")}\\n\") # rubocop:disable Style/GlobalVars\n+  end\n+end\n"},{"old_path":"spec/tooling/quality/test_level_spec.rb","new_path":"spec/tooling/quality/test_level_spec.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -49,7 +49,7 @@\n     context 'when level is integration' do\n       it 'returns a pattern' do\n         expect(subject.pattern(:integration))\n-          .to eq(\"spec/{controllers,mailers,requests}{,/**/}*_spec.rb\")\n+          .to eq(\"spec/{commands,controllers,mailers,requests}{,/**/}*_spec.rb\")\n       end\n     end\n \n@@ -131,7 +131,7 @@\n     context 'when level is integration' do\n       it 'returns a regexp' do\n         expect(subject.regexp(:integration))\n-          .to eq(%r{spec/(controllers|mailers|requests)})\n+          .to eq(%r{spec/(commands|controllers|mailers|requests)})\n       end\n     end\n \n@@ -204,6 +204,10 @@\n       expect(subject.level_for('spec/mailers/abuse_report_mailer_spec.rb')).to eq(:integration)\n     end\n \n+    it 'returns the correct level for an integration test in a subfolder' do\n+      expect(subject.level_for('spec/commands/sidekiq_cluster/cli.rb')).to eq(:integration)\n+    end\n+\n     it 'returns the correct level for a system test' do\n       expect(subject.level_for('spec/features/abuse_report_spec.rb')).to eq(:system)\n     end\n"},{"old_path":"spec/workers/container_expiration_policies/cleanup_container_repository_worker_spec.rb","new_path":"spec/workers/container_expiration_policies/cleanup_container_repository_worker_spec.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -82,8 +82,9 @@\n             nil | 10  | nil\n             0   | 5   | nil\n             10  | 0   | 0\n-            10  | 5   | 0.5\n-            3   | 10  | (10 / 3.to_f)\n+            10  | 5   | 50.0\n+            17  | 3   | 17.65\n+            3   | 10  | 333.33\n           end\n \n           with_them do\n"},{"old_path":"tooling/bin/find_change_diffs","new_path":"tooling/bin/find_change_diffs","a_mode":"100755","b_mode":"100755","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -5,11 +5,22 @@ require 'gitlab'\n require 'pathname'\n \n # This script saves the diffs of changes in an MR to the directory specified as the first argument\n+#\n+# It exits with a success code if diffs are found and saved, or if there are no changes, including if the script runs in\n+# a pipeline that is not for a merge request.\n \n gitlab_token = ENV.fetch('PROJECT_TOKEN_FOR_CI_SCRIPTS_API_USAGE')\n gitlab_endpoint = ENV.fetch('CI_API_V4_URL')\n-mr_project_path = ENV.fetch('CI_MERGE_REQUEST_PROJECT_PATH')\n-mr_iid = ENV.fetch('CI_MERGE_REQUEST_IID')\n+mr_project_path = ENV['CI_MERGE_REQUEST_PROJECT_PATH']\n+mr_iid = ENV['CI_MERGE_REQUEST_IID']\n+\n+puts \"CI_MERGE_REQUEST_PROJECT_PATH is missing.\" if mr_project_path.to_s.empty?\n+puts \"CI_MERGE_REQUEST_IID is missing.\" if mr_iid.to_s.empty?\n+\n+unless mr_project_path \u0026\u0026 mr_iid\n+  puts \"Exiting as this does not appear to be a merge request pipeline.\"\n+  exit\n+end\n \n abort(\"ERROR: Please specify a directory to write MR diffs into.\") if ARGV.empty?\n output_diffs_dir = Pathname.new(ARGV.shift).expand_path\n"},{"old_path":"tooling/bin/qa/check_if_only_quarantined_specs","new_path":"tooling/bin/qa/check_if_only_quarantined_specs","a_mode":"100755","b_mode":"0","new_file":false,"renamed_file":false,"deleted_file":true,"diff":"@@ -1,18 +0,0 @@\n-#!/usr/bin/env ruby\n-# frozen_string_literal: true\n-\n-require 'pathname'\n-\n-# This script assumes the first argument is a directory of files containing diffs of changes from an MR. It exits with a\n-# success code if all diffs add a line that quarantines a test. If any diffs are not specs, or they are specs that don't\n-# quarantine a test, it exits with code 1 to indicate failure (i.e., there was _not_ only quarantined specs).\n-\n-abort(\"ERROR: Please specify the directory containing MR diffs.\") if ARGV.empty?\n-diffs_dir = Pathname.new(ARGV.shift).expand_path\n-\n-diffs_dir.glob('**/*').each do |path|\n-  next if path.directory?\n-\n-  exit 1 unless path.to_s.end_with?('_spec.rb.diff')\n-  exit 1 unless path.read.match?(/^\\+.*, quarantine:/)\n-end\n"},{"old_path":"tooling/bin/qa/package_and_qa_check","new_path":"tooling/bin/qa/package_and_qa_check","a_mode":"0","b_mode":"100755","new_file":true,"renamed_file":false,"deleted_file":false,"diff":"@@ -0,0 +1,45 @@\n+#!/usr/bin/env ruby\n+# frozen_string_literal: true\n+\n+require 'pathname'\n+\n+# This script checks if the package-and-qa job should trigger downstream pipelines to run the QA suite.\n+#\n+# It assumes the first argument is a directory of files containing diffs of changes from an MR\n+# (e.g., created by tooling/bin/find_change_diffs). It exits with a success code if there are no diffs, or if the diffs\n+# are suitable to run QA tests.\n+#\n+# The script will abort (exit code 1) if the argument is missing.\n+#\n+# The following condition will result in a failure code (2), indicating that package-and-qa should not run:\n+#\n+#   - If the changes only include tests being put in quarantine\n+\n+abort(\"ERROR: Please specify the directory containing MR diffs.\") if ARGV.empty?\n+diffs_dir = Pathname.new(ARGV.shift).expand_path\n+\n+# Run package-and-qa if there are no diffs. E.g., in scheduled pipelines\n+exit 0 if diffs_dir.glob('**/*').empty?\n+\n+files_count = 0\n+specs_count = 0\n+quarantine_specs_count = 0\n+\n+diffs_dir.glob('**/*').each do |path|\n+  next if path.directory?\n+\n+  files_count += 1\n+  next unless path.to_s.end_with?('_spec.rb.diff')\n+\n+  specs_count += 1\n+  quarantine_specs_count += 1 if path.read.match?(/^\\+.*, quarantine:/)\n+end\n+\n+# Run package-and-qa if there are no specs. E.g., when the MR changes QA framework files.\n+exit 0 if specs_count == 0\n+\n+# Skip package-and-qa if there are only specs being put in quarantine.\n+exit 2 if quarantine_specs_count == specs_count \u0026\u0026 quarantine_specs_count == files_count\n+\n+# Run package-and-qa under any other circumstances. E.g., if there are specs being put in quarantine but there are also\n+# other changes that might need to be tested.\n"},{"old_path":"tooling/quality/test_level.rb","new_path":"tooling/quality/test_level.rb","a_mode":"100644","b_mode":"100644","new_file":false,"renamed_file":false,"deleted_file":false,"diff":"@@ -54,6 +54,7 @@ class TestLevel\n         tooling\n       ],\n       integration: %w[\n+        commands\n         controllers\n         mailers\n         requests\n"}],"compare_timeout":false,"compare_same_ref":false,"web_url":"https://gitlab.com/gitlab-org/gitlab-foss/-/compare/4901ff1764398bb017487d4a5104b74bc284f33a...2295d352f6073101497f9bf4e4981c7ae72706a3"}